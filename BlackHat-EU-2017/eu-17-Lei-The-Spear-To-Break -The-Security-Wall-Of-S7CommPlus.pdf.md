The spear to break the security wall of S7CommPlus
CHENG LEI , NSFOCUS

OverView
- PLC and Siemens PLC intorduction - S7CommPlus protocol - Encryption Part Analyze - Protections

Related Work
- Dillon Beresford. Exploiting Siemens Simatic S7 PLCs. Black Hat 2011 USA.
- Ralf Spenneberg et. al. PLC-Blaster: A Worm Living Solely in the PLC. Black Hat 2016 USA
- This talk mainly focus on the current encrypted S7CommPlus protocol

What is PLC
Programmable Logic Controllers (PLC) is responsible for process control in industrial control system. A PLC contains a Central Processing Unit (CPU), some digital/analog inputs and outputs modules, communication module and some process modules like PID.

Siemens PLCs
S7-300

 S7-200,S7-300,S7-400 using the S7Comm protocol

S7-1200 S7-1500

 S7-1200v3.0 using the early S7CommPlus protocol
 S7-1200v4.0, S7-1500 using the current encrypted S7CommPlus protocol

TIA Portal
TIA Portal is the configuration and programming software for Siemens PLCs.

Replay Attack
 Replay attacks have been widely used in PLC attacks.  Get the communication sequence packets with the help of Wireshark

S7CommPlus Protocol
 The current S7CommPlus protocol including the S7CommPlus Connection packets and S7CommPlus Function packets has a similar structure.
렁 1234..SFeuirrcinsotcntCidoonCnnoPenacnctkeioectn--ioSnSettSouepptuPRpLeCqsRpueoqensutseest

S7CommPlus Protocol
 Session ID
Session ID = Object ID+0x80

S7CommPlus Protocol
 Encryption Part 1. The second connection packet has two encryptions
2. The function packet has one encryptionIntegrity Part

The Encryption
 Using reverse debugging techniques, we found these encryption is calculated by TIA Portal through a file named OMSp_core_managed.dll
1. Connection packet encryption
Input parameter for this encryption is a random value array generated by the PLC in the first connection response packet.

The Encryption

1 First encryption in the connection packet

Using XOR (we call this Encryption1), the first encryption can be calculated

with the input parameter Value Array.

Encryption1

Value Array

First Encryption

The Encryption

2Second encryption in the connection packet

Using the result of the first encryption as input parameter, the second encryption is

calculated through a more complex Siemens-private algorithm.

Encryption2

First Encryption

Second Encryption

The Encryption
2. Function packet encryption
A fixed field array with Session ID is the input parameter. A complex algorithm (we call this Encryption3) is used to calculated the encryption result as follow:
Constant Array Encryption3 Function Encryption (with Session ID)

Demonstration

The Encryption
3. S7CommPlus Communication with Encryption

Protections
Code level:
-- Use code confusion techniques and anti-Debug techniques for the key DLL files
Design level
-- use a private key as an input parameter for encryption algorithm in the communication between Siemens software and PLCs.
Protocol level
-- Encrypt the whole packets instead of the key byte encryption

chengleim19@gmail.com

