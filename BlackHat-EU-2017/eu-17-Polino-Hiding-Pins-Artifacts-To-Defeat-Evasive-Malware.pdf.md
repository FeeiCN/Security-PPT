Hiding PIN's Artifacts
to Defeat Evasive Malware
Mario Polino, Andrea Continella, Sebastiano Mariani, Lorenzo Fontana, Stefano D'Alessio, Fabio Gritti, Stefano Zanero

Agenda
- Arancino - Dynamic Binary Instrumentation Tools - DBI Evasion - Evasive Malware Measurement - Evasive Resilient Unpacking Tool - DEMO

Arancino

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

Arancino

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

Malware Analysis

Malware Analysis

Static
mov eax, esi mov edi, ebx mov ecx, 14h rep stosd mov dword ptr [esp+0Ch], 0Ah mov dword ptr [esp+8], 50h mov [esp+4], ebx mov dword ptr [esp], 0 call sub_8048C30 cmp eax, 0FFFFFFFFh jz short loc_80488F8

mov [esp], ebx call sub_8048A50 test eax, eax jz short loc_8048858

loc_80488F8: mov edx, [esp+6Ch] xor edx, large gs:14h jnz short loc_804890D

loc_8048858: cmp ds:dword_804C3C0, 1 mov [esp+8], ebx mov dword ptr [esp+4], offset aSInvalidComman sbb eax, eax not eax add eax, 24h mov [esp+0Ch], eax mov dword ptr [esp], 1 call ___printf_chk

cmp ds:dword_804C3C0, 1 mov dword ptr [esp+4], 804960Bh mov dword ptr [esp], 1 sbb eax, eax not eax add eax, 24h mov [esp+8], eax call ___printf_chk jmp short loc_8048882

loc_8048882: mov eax, ds:stdout mov [esp], eax call _fflush

Dynamic

Malware

Run in a sandbox

Traces instances

CreateFile (_T("File.txt"),...)

VirtualAlloc( ... )

ReadFile(hout, buf, 40, 0, NULL); CloseHandle(hout)

Malware Evasive
If (amIUnderAnalysis()) {
die(); } else {
beMalicious(); }

Dynamic Binary Instrumentation

What is a DBI Tool?

.text
.rodata .data

Memory

stack

What is a DBI Tool?

DBI

///////////////////////// ///////////////////////// /////////////////////////
///////////.t/e/x//t//////////
///////////////////////// ///////////////////////// /////////////////////////
.rodata
.data

Memory

stack

What is a DBI Tool?

Basic Block
Control Flow Graph

BB1

BB3

BB2

BB4 BB6

BB7

BB8

BB9

BB10

Trace

BB1

BB3

BB2

BB4 BB6

BB7

BB8

BB9

BB10

What is a DBI Tool?

Trace is copied in the code cache

BB1

BB3

BB2

Code Cache

BB1

BB3

BB2

BB4 BB6

BB7

BB8

BB9

BB10

What is a DBI Tool?

User instrumentation code is added.
JIT Compiler

BB1
User Defined Code

BB3

BB2

User Defined Code

Code Cache

DBI - Evasive Malware

Intel Pin Tools

DynamoRIO

Valgrind

rev.ng

DBI - Evasive Malware

Intel Pin Tools

DynamoRIO

Valgrind

rev.ng

DBI - Evasive Malware

Code Cache Artifacts

JIT Compiler Detection

Environment Artifact

Overhead Detection

Code Cache Artifacts

Code Cache Artifacts

All those artifacts caused by having a Code Cache
 IP Detection

BB1
User Defined Code

BB3

BB2

 Self-Modifying Code

Code Cache

CCA - IP Detection

Nt Sycall (EIP -> EDX) int 2e
EIP
Floating Point Context on the Stack fsave/ fxsave/ fstenv When we find one of those in a trace we patch the env after the execution of the instruction. NB call Instruction is handled by Pin

code cache
ins1 ins2 ins3 ins4
ins1 ins2 ins3 ins4 ins5 ins6
...

Arancino - Pattern Matching Module

- PatchMap: List of instructions and func pointers
- PatchDispatcher: check and add patch to instructions during trace building.

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER

PATCHED TRACE

int 2e fsave fxsave

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
add eax,4

PATCHED TRACE

int 2e fsave fxsave

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
add eax,4
Is it in the list?
int 2e fsave fxsave

PATCHED TRACE

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
add eax,4
Nope!
int 2e fsave fxsave

PATCHED TRACE

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
add eax,4

PATCHED TRACE
add eax,4

int 2e fsave fxsave

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
int 2e

PATCHED TRACE
add eax,4

int 2e fsave fxsave

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
int 2e
Is it in the list?
int 2e fsave fxsave

PATCHED TRACE
add eax,4

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
int 2e
Yes!
int 2e fsave fxsave

PATCHED TRACE
add eax,4

TRACE
add eax,4 int 2e
jmp 0x0804856c

CCA - IP Detection

PATCH DISPATCHER
int 2e
int 2e fsave fxsave

PATCHED TRACE
add eax,4 int 2e
patch_int2e()

CCA - IP Detection RT

0x00200000 0x00200003 0x00200005
0x00200003
EDX
0x00400000 0x00400003 0x00400005

add eax,4 int 2e
patch_int_2e() Jmp 0x0804856c
add eax,4 int 2e
Jmp 0x0804856c [ ... ]

Code Cache
Main module

CCA - IP Detection RT

0x00200000 0x00200003 0x00200005
0x00400003
EDX
0x00400000 0x00400003 0x00400005

add eax,4 int 2e
patch_int_2e() Jmp 0x0804856c
add eax,4 int 2e
Jmp 0x0804856c [ ... ]

Code Cache
Main module

Code Cache Artifacts

All those artifacts caused by having a Code Cache
 IP Detection

BB1
User Defined Code

BB3

BB2

 Self-Modifying Code

Code Cache

CCA - Self Modifying Code

code cache
.text

ins1 ins2 wrong_ins3 ins4 ins5 ins6 ins7
...

Collected Trace

CCA - Self Modifying Code

code cache
.text

ins1 ins2 wrong_ins3 ins4 ins5
ins1 ins2 wrong_ins3 ins4 ins5 ins6 ins7
...

Collected Trace

CCA - Self Modifying Code

code cache
Patch
.text

ins1 ins2 wrong_ins3 ins4 ins5
ins1 ins2 wrong_ins3 ins4 ins5 ins6 ins7
...

Instruction Pointer

CCA - Self Modifying Code

code cache
Patch
.text

ins1 ins2 wrong_ins3 ins4 ins5
ins1 ins2 ins3 ins4 ins5 ins6 ins7
...

Instruction Pointer

CCA - Self Modifying Code

code cache
.text

ins1 ins2 wrong_ins3 ins4 ins5
ins1 ins2 ins3 ins4 ins5 ins6 ins7
...

Instruction Pointer

CCA - Self Modifying Code

code cache
.text

ins1 ins2 wrong_ins3 ins4 ins5
ins1 ins2 ins3 ins4 ins5 ins6 ins7
...

Instruction Pointer

CCA - Self Modifying Code

code cache
.text

ins1 ins2 wrong_ins3 ins4 ins5
Crash
ins1 ins2 ins3 ins4 ins5 ins6 ins7
...

Instruction Pointer

Arancino - Self Modifying Code Module

- MarkWrittenAddress: store which address has been overwritten
- CheckEIPWritten: check if next instruction has been overwritten.

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

Analysis Routines
code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 wrong_ins3 ins4 ins5 ins6
...

Collected Trace

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 wrong_ins3 ins4 ins5 ins6
...

Instruction Pointer

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 wrong_ins3 ins4 ins5 ins6
...

address_ins3

CCA - Self Modifying Code

code cache
Patch
.text

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

Instruction Pointer
address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

Instruction Pointer
address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

Instruction Pointer
address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

Instruction Pointer
address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten() MarkWrittenAddress()
ins1
CheckEipWritten()
ins2
CheckEipWritten()
wrong_ins3
CheckEipWritten()
ins1 ins2 ins3 ins4 ins5 ins6
...

address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten()

MarkWrittenAddress()

ins1

CheckEipWritten()

ins2

CheckEipWritten()

Instruction Pointer

ChwecrkoEnipgW_irnitste3n()Cache

address_ins3

Invalidated

ins1 ins2 ins3 ins4 ins5 ins6
...

CCA - Self Modifying Code

code cache
.text

ins1 ins2 ins3 ins4 ins5 ins6
...

ReCollected Trace

address_ins3

code cache
.text

CCA - Self Modifying Code

CheckEipWritten()
ins3
CheckEipWritten()
ins4
CheckEipWritten()
ins5
ins1 ins2 ins3 ins4 ins5 ins6
...

ReCollected Trace

address_ins3

Environment Artifacts

Environment Artifacts
 Parent Detection  Memory Fingerprinting

EA - Parent Detection
Malware can check which is the process father.  NtQuerySystemInformation  CSRSS.exe

Arancino - Hooking Module

- Hooking Function Module: Install an Hook on dll's Functions
- Hooking Syscall Module: Install an Hook on dll's Functions

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

Arancino - Hooking Module

- Hooking Function Module: Install an Hook on dll's Functions
- Hooking Syscall Module: Install an Hook on dll's Functions

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

Arancino - Hook Functions
.text

ImageLoad

Memory Pintool.dll

Arancino - Hook Functions

ImageLoad

.text new.dll

Memory

Pintool.dll

Arancino - Hook Functions

HOOK DISPATCHER

.text

ImageLoad

new.dll

new.dll

Memory

VirtualFree VirtualQueryEx
...

Pintool.dll

Arancino - Hook Functions

HOOK DISPATCHER

.text

ImageLoad

new.dll

new.dll

Memory

VirtualFree VirtualQueryEx
...

Pintool.dll

Arancino - Hook Functions

HOOK DISPATCHER

.text

ImageLoad

new.dll

Check if

new.dll

Functions are

in the List

VirtualFree VirtualQueryEx

Pintool.dll

...

Memory

Arancino - Hook Functions

HOOK DISPATCHER

.text

ImageLoad

new.dll

new.dll

Memory

VirtualFree VirtualQueryEx
...

Pintool.dll

Arancino - Hook Functions

HOOK DISPATCHER

.text

ImageLoad

new.dll

Function
new.dll

VirtualFree VirtualQueryEx
...

Hook Function
Pintool.dll

EA - Parent Detection
Hooked NtQuerySystemInformation pin.exe -> cmd.exe
Hooked NtOpenProcess to deny access to CSRSS.exe

Environment Artifacts
 Parent Detection  Memory Fingerprinting

EA - Memory Fingerprinting
.text new.dll
Pintool.dll

EA - Memory Fingerprinting
.text new.dll
Pintool.dll

EA - Memory Fingerprinting
.text new.dll
Pintool.dll

EA - Memory Fingerprinting
.text new.dll
Pintool.dll

EA - Memory Fingerprinting
.text new.dll
Pintool.dll

EA - Memory Fingerprinting

.text new.dll
Pintool.dll

0x00400000 0x00402000 0x55100000 0x55101000 0x6f100000
0x6f103000

EA - Memory Fingerprinting

0x58402000

.text new.dll
Pintool.dll

0x00400000 0x00402000 0x55100000 0x55101000 0x6f100000
0x6f103000

EA - Memory Fingerprinting

0x58402000

.text
new.dll Crash

0x00400000
0x00402000 0x55100000
0x55101000

0x6f100000

Pintool.dll

0x6f103000

EA - Memory Fingerprinting

.text

new.dll

VirtualQuery

Pintool.dll

EA - Memory Fingerprinting
We Hook NtQueryVirtualMemory We create a Whitelist of accessible memory regions updated at runtime.  Main Module  Libraries  Heap and Stack  PEB, TEB, etc.  Mapped files

JIT Compiler Detection

JIT Compiler Detection
 Memory Page Permissions  Checks if there are WX pages
 DLL Hook Detection
 Memory Allocations

JIT Compiler Detection
 Memory Page Permissions  Checks if there are WX pages
 DLL Hook Detection
 Memory Allocations

JITC Detection - DLL Hook
A process can search through memory for discrepancy caused by Hooks.
KiUserApcDispatcher - normal execution
KiUserApcDispatcher - Instrumented execution

Arancino

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

JITC Detection - DLL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

0x77C76F58 LJEMAPE0AxX5,B[6E8S0PB+E2D0]

JITC Detection - DLL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

0x77C76F58

JMP 0x5B680BE0

JITC Detection - DLL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

add eax,2 mov edx, [eax] cmp edx,0x8d
jnz ebx
eax = 0x77C76F58

add eax,2
Is memory read operation? Nope! Go next

0x77C76F58

JMP 0x5B680BE0

JITC Detection - DDL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

add eax,2 mov edx, [eax] cmp edx,0x8d
jnz ebx
eax = 0x77C76F58

mov edx, [eax]
Is memory read operation? Yes

0x77C76F58

JMP 0x5B680BE0

JITC Detection - DDL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

add eax,2 mov edx, [eax] cmp edx,0x8d
jnz ebx
eax = 0x77C76F58

mov edx, [eax]

Is the target address inside a fake memory item?
Yes fake memory function
invoked

0x77C76F58

JMP 0x5B680BE0

JITC Detection - DDL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

add eax,2 mov edx, [eax] cmp edx,0x8d
jnz ebx
eax = 0x77C76F58

mov edx, [eax]
FakeMemoryFunc() 0x77C76F58 0x77C76F5F

0x01C00A2B LEA EAX, [ESP+2D]

0x77C76F58

JMP 0x5B680BE0

JITC Detection - DDL Hook

TRACE

FAKE_READ_HANDLER

MEMORY

add eax,2 mov edx, [eax] cmp edx,0x8d
jnz ebx
Instrumented process read the fake value:
LEA EAX, [ESP+2D]
and doesn't detect PIN

mov edx, [eax]

0x01C00A2B LEA EAX, [ESP+2D]

0x77C76F58

JMP 0x5B680BE0

JIT Compiler Detection
 Memory Page Permissions  Checks if there are WX pages
 DLL Hook Detection
 Memory Allocations

JIT Compiler - API Hook
JIT Compiler needs Memory to perform the compiling
We can monitor the allocation by Hooking at ZwAllocateVirtualMemory

JIT Compiler - API Hook
Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll
Pintool.dll

JIT Compiler - API Hook

Write

Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll

Pintool.dll

Arancino

Arancino

Fake Memory Handler Modules

Fake Read Handler Module

Fake Write Handler Module

Fake Free Handler Module

Pattern Matching Module

Self Modifying Code Module

Process Information Module

Hooking Module

Hooking Function Module

Hooking Syscall Module

JIT Compiler - API Hook

Write

Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll

Pintool.dll

JIT Compiler - API Hook

Write

Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll

Pintool.dll

JIT Compiler - API Hook

Write

Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll

Pintool.dll

JIT Compiler - API Hook

Read

Counter Fun
.text
ZwAllocateVirtualMemory
ntdll.dll

Pintool.dll

Overhead Detection

Overhead Detection
 Windows Time  Use windows API  GetTickCount and timeGetTime  Or Windows Structures  KUSER_SHARED_DATA.
 CPU Time  Count CPU cycles (rdtsc)

Evasive Malware Measurement

Anti-Instrumentation Measurement
Dataset
 7006 Binaries
 Virus Total Intelligence (3+ AV Detection)
 From October 2016 to February 2017

Anti-Instrumentation Measurement
Environment Setup
 Virtual Machine (VirtualBox)  Windows 7 (64-bit)  Custom Apps (Adobe Reader, Chrome, and media players)  User Data (saved credentials, browser history, etc.)  Basic User Activity (moving the mouse, launching applications)  5 min run

Evasive Malware

At least one evasive behavior: 1,093 / 7006 (15.6%)

Family Name [1]

Samples

Evasive Techniques

virlock confidence
virut mira upatre lamer sivis

619 (8.8%)

600 (96.9%)

2

505 (7.2%)

68 (13.5%)

4

242 (3.5%)

13 (5.4%)

2

230 (3.3%)

9 (3.9%)

1

187 (2.7%)

2 (1.1%)

1

171 (2.4%)

0 (0.0%)

0

168 (2.4%)

0 (0.0%)

0

[1] AvClass https://github.com/malicialab/avclass

Top Evasive Malware

At least one evasive behavior: 1,093 / 7006 (15.6%)

Family Name [1]

Samples

Evasive Techniques

sfone unruy virlock vilsel urelas confuser vobfus

19

19 (100.0%)

1

11

11 (100.0%)

1

619

600 (96.9%)

2

13

8 (61.5%)

2

18

9 (47.4%)

2

52

8 (44.4%)

1

29

19 (36.5%)

1

[1] AvClass https://github.com/malicialab/avclass

Top Techniques Used
At least one evasive behavior: 1,093 / 7006 (15.6%)

Technique

#

Code Cache Artifacts

Self-modifying code

897

Environment Artifacts

Parent detection

259

JIT Compiler Detection

Write on protected

40

memory region

Environment Artifacts

Check DEBUG flag

5

Environment Artifacts

Memory fingerprinting

3

Overhead

Pin time [ms]

Arancino [ms]

Arancino overhead
[%]

Module activated

Parent Detection

850

870

2%

Hooking Module

EIP Detection - int2e

710

1,150

62%

Pattern Match Module

Memory Fingerprinting

2,000

7,090

254,5%

Fake Read Module

Memory Allocations 2,000

2,900

45%

Fake Write Module + Hooking Module

Unpacking Approach

Detect W and X memory regions

Dump the
Program

Deobfuscate the Import
Address Table

Recognize the correct
dump

Experiment 1 : known packers

Upx FSG MessageBox.exe
WinRAR.exe

Mew

mpress PeCompact Obsidium ExePacker

ezip

Xcomp PElock ASProtect ASPack eXpressor exe32packer beropacker Hyperion MessageBox.exe
WinRAR.exe
Original code dumped but Import directory not reconstructed

Experiment 2 : wild samples

Number of packed (checked manually) samples 1096

N°

%

Unpacked and working

669

63

Unpacked but not executable

139

13

Not unpacked

258

24

Arancino - GitHub
DEMO Time!
eXait https://www.coresecurity.com/corelabs-research/open-source-tools/exait

Black Hat Sound Bytes
 Malware authors employ Anti-Instrumentation techniques to detect when their samples are being instrumented
 We proposed an approach to practically defeat such techniques  We studied the common techniques adopted by modern
malware authors to evade of instrumentation systems  On top of Arancino ~> dynamic, evasion-resilient unpacker
 Known packers use anti-instrumentation techniques!

Arancino - GitHub
Thanks!
https://github.com/necst/arancino
Mario Polino <mario.polino@polimi.it>

Arancino - GitHub
Questions?
https://github.com/necst/arancino
Mario Polino <mario.polino@polimi.it>

Arancino - GitHub
Questions?
https://github.com/necst/arancino
Mario Polino <mario.polino@polimi.it>

Credits
 Icons, CC from Noun Project:  Vicons Design  Aya Sofya  Adnen Kadri  Stock Image Folio  Icon Fair  Creative Stall  Gregor Cresnar

Arancino - GitHub

