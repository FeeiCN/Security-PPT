A Broken Chain:
Discovering OPC-UA Attack Surface and Exploiting the Supply-chain
By Eran Jacob
#BHUSA @BlackHatEvents

Who am I?
Eran Jacob Security Research Team Leader
@EranJacob linkedin.com/in/eranj

Roman Dvorkin
linkedin.com/in/roman-dvorkin

Alon Zini
linkedin.com/in/alon-zini-3b9698185

#BHUSA @BlackHatEvents

Agenda
Intro

Supply-chain Exploitation

The Attack Surface

Fuzzing

#BHUSA @BlackHatEvents

Automation Protocols

Manufacturing

Critical Infrastructure

Buildings, Traffic..
#BHUSA @BlackHatEvents

Automation Protocols
#BHUSA @BlackHatEvents

OPC Classic
Open Platform Communications

- Data Access - Alarms and Events - Historical Data Access

Distributed Component Object Model

Firewall unfriendly

Security

#BHUSA @BlackHatEvents

OPC Unified Architecture

Cloud/IT
2.

ERP
MES SCADA

Cloud
3.
Relay Broker

1.

HMI

OT

Controller Field Devices

Controller
4.
Field Devices #BHUSA @BlackHatEvents

OPC Unified Architecture

Cloud/IT
2.

ERP
MES SCADA

Cloud
3.
Relay Broker

1.

HMI

OT

Controller Field Devices

Controller
4.
Field Devices #BHUSA @BlackHatEvents

Motivation for Research
 The "next-thing" in industrial
communication
 Highly adopted  Significant potential impact

#BHUSA @BlackHatEvents

02

Discovering the Attack Surface
or at least some of it..

#BHUSA @BlackHatEvents

Mapping the surface

Specifications

Communication Stack

.NET Standard .NET legacy ANSI C legacy JAVA legacy

#BHUSA @BlackHatEvents

Mapping the surface

Specifications

Communication Stack

.NET standard
.NET legacy ANSI C legacy JAVA legacy

#BHUSA @BlackHatEvents

Mapping the surface

Specifications

Communication Stack

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Commercial SDKs

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Mapping the surface
C / C++ .NET

#BHUSA @BlackHatEvents

Mapping the surface
C / C++

#BHUSA @BlackHatEvents

Mapping the surface
C / C++

#BHUSA @BlackHatEvents

Mapping the surface
C / C++

TB5STACK.dll

uastack.dll

uastack.dll #BHUSA @BlackHatEvents

Mapping the surface
.NET

#BHUSA @BlackHatEvents

Mapping the surface

Specifications

Communication Stack

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Commercial SDKs

"The vast majority of OPC UA products are based on these commercial OPC UA SDK/Toolkits"
OPC Foundation

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Mapping the surface

Specifications

Communication Stack

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Commercial SDKs

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Chain of Dependency

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Pervious Work

Active
OPC Foundation Security Working
Group

2017
German Office for Information Security (BSI)

2018, 2020
Kaspersky

2021
Claroty

...

Academic papers

2021

o Practical Pitfalls for Security in OPC UA

2020

o Assessing the Security of OPC UA Deployments

o...

#BHUSA @BlackHatEvents

03

Exploiting the supply chain

#BHUSA @BlackHatEvents

Chain of Dependency

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

OPC UA Connection

Client

HEL

Hello

Acknowledge

OPN

OpenSecureChannelRequest

OpenSecureChannelResponse

MSG

CreateSessionRequest

CreateSessionResponse

MSG

ActivateSessionRequest

ActivateSessionResponse

MSG

...

...
MSG

CLO

CloseSecureChannelRequest

Server

ACK Transport

Secure Channel: Confidentiality, Integrity, App

OPN

Authentication

MSG Session: User Authentication & Authorization

MSG

MSG
Messages: Read, Write, Call...
MSG

#BHUSA @BlackHatEvents

Reading the Reference
Complex Datatypes
Variants, Extension Objects, Structures
Flexible Encoding
Binary, XML, JSON
Pre-security messages
(OpenSecureChannel, GetEndpoints , FindServers...)
https://tyk.io/great-api-documentation-requires-code-examples/

#BHUSA @BlackHatEvents

Chain of Dependency

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Breaking the .NET Stack
 NET doesn't like deep function calls...  The reference alerts of such risk when describing nested data types.  A related issue was already found in the past (CVE-2018-12086):

Object
Inner Object XML/Binary

#BHUSA @BlackHatEvents

Nested Data Types
Variant
(UNION)

Array/Matrix

Built in data type

Diagnostic Info
Inner diagnostic info

Extension Object
(Structure Container) OPC UA Structure XML/Binary
Data Value
Variant

#BHUSA @BlackHatEvents

Unlimited Nesting
XML OPC UA Decoder

Variant
(UNION)

Array/Matrix

Built in data type

#BHUSA @BlackHatEvents

Nested Structures

Extension Object
(Structure Container)

- Extension Objects! - VERY useful for pivoting our way to vulnerable parts of the stacks - Used in messages before channel or session security (in both directions)

OPC UA Structure XML/Binary

Client

Server

HEL

Hello

Acknowledge

ACK Transport

OPN

OpenSecureChannelRequest

Secure Channel: Confidentiality, Integrity, App

OpenSecureChannelResponse

OPN

Authentication

MSG

CreateSessionRequest

CreateSessionResponse

MSG Session: User Authentication & Authorization

MSG

ActivateSessionRequest

ActivateSessionResponse

MSG

MSG

...

MSG

...

MSG
Messages: Read, Write, Call...

MSG

CLO

CloseSecureChannelRequest

#BHUSA @BlackHatEvents

Nested Structures
OpenSecureChannelRequest
OPN

Extension Object
(Structure Container) OPC UA Structure XML/Binary
#BHUSA @BlackHatEvents

Nested Structures - Chunks.

Client
HEL
OPN MSG MSG MSG MSG CLO

Server

Hello

Acknowledge

ACK

OpenSecureChannelRequest

OpenSecureChannelResponse

OPN

CreateSessionRequest

CreateSessionResponse

MSG

ActivateSessionRequest

ActivateSessionResponse

MSG

...

...

MSG

MSG
CloseSecureChannelRequest

Transport connection Secure Channel: Confidentiality, Integrity, App
Authentication
Session: User Authentication & Authentication
Messages: Read, Write, Call...

Extension Object
(Structure Container) OPC UA Structure XML/Binary
#BHUSA @BlackHatEvents

Nested Structures - Chunks.

Client
HEL
OPN MSG
CLO

Server

Hello

Acknowledge

ACK

OpenSecureChannelRequest

OpenSecureChannelResponse

OPN

FindServersRequest

FindServersResponse

MSG

CloseSecureChannelRequest

Transport connection Secure Channel: security mode = NONE FindServers

Extension Object
(Structure Container)
OPC UA Structure XML/Binary

#BHUSA @BlackHatEvents

.NET Stack Vulnerability
6 years old 0 day

CVE-2021-27432

#BHUSA @BlackHatEvents

.NET Stack Vulnerability
Client -> Server

Main Site

Remote Site 1

Remote Site 2

Loss of visibility & control
OPC UA SERVER

PLC

HMI

PLC

SCADA
(OPC UA client)

PC
Loss of visibility & control
OPC UA SERVER

#BHUSA @BlackHatEvents

.NET Stack Vulnerability
Server -> Client

Main Site

Remote Site 1

Remote Site 2

Loss of visibility & control
OPC UA SERVER

PLC

HMI

PLC

SCADA
(OPC UA client)

PC
Loss of visibility & control
OPC UA SERVER

#BHUSA @BlackHatEvents

Unified Automation .NET SDK

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Unified Automation .NET SDK

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

XXE. Again.
 Code refactoring reintroduced the vulnerability  Exploitable over Extension Object decoding
*XXE = XML External Entity

CVE-2021-27434
#BHUSA @BlackHatEvents

SDK XXE Vulnerability Impact
Client -> Server

OT Network

IT Network

OPC UA SERVER

PLC

HMI

PLC

#BHUSA @BlackHatEvents

Softing C++ OPC UA SDK

Specifications

Communication Stack

Commercial SDKs

.NET standard
.NET legacy ANSI C legacy JAVA legacy

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Softing C++ OPC UA SDK

SDK interface (API) SDK-level processing Stack-level processing

TB5CPP TB5OT TB5STACK

Softing's SDK C++ objects
TB5UTIL
Foundation's ANSI C stack structures
#BHUSA @BlackHatEvents

From Binary to Objects
TB5STACK

Binary Message C Structures

TB5OT

https://www.flaticon.com/free-icon/documents_160085

SDK C++ Objects
#BHUSA @BlackHatEvents

Foundation's Extension Object
Looking at the Legacy ANCI C stack decoded Extension Objects are stored in a specific structure
ID of the contained structure Encoding of the BODY
BODY UNION

Extension Object
(Structure Container)
OPC UA Structure... XML/Binary

#BHUSA @BlackHatEvents

Foundation's ExtensionObject
Zooming into the ExtensionObject body union
Int32, Byte* Int32, Byte* Object* , EncodableType*
#BHUSA @BlackHatEvents

Foundation's ExtensionObject

ID of the contained structure Encoding of the BODY
BODY UNION

MUST be validated MUST be validated

#BHUSA @BlackHatEvents

Setting C++ Objects
TB5STACK
Binary Message
Extension Object Struct
TypeID: X/Y/Z.. Encoding: EncodeableObject Body: decoded object
C Structure
https://www.flaticon.com/free-icon/documents_160085

TB5OT

SDK C++ Objects
#BHUSA @BlackHatEvents

Skipping Internal Structure Decoding
1. XML..

2. Type-ID encoding

#BHUSA @BlackHatEvents

Setting C++ Objects
TB5STACK
Binary Message
Extension Object Struct
TypeID: X/Y/Z.. Encoding: XML/Binary Body: ByteString object
C Structure
https://www.flaticon.com/free-icon/documents_160085

TB5OT

SDK C++ Objects
#BHUSA @BlackHatEvents

Setting C++ Objects
TB5STACK
Binary Message
Extension Object Struct
TypeID: X/Y/Z.. Encoding: XML/Binary Body: ByteString object
C Structure
https://www.flaticon.com/free-icon/documents_160085

TB5OT

SDK C++ Objects
#BHUSA @BlackHatEvents

A word about PubSub
Option: Publish/Subscribe in the Cloud

Subscriber : Client Subscriber : Client Subscriber : Client
SubscSruibbesrc:riCbleiern:t Client Subscriber : Client
Subscriber : Client Subscriber : Client Subscriber : Client

Relay Broker

Option: Secure Multicast
Subscriber : Client

Subscriber : Client

Publisher/Sender : Server Publisher/Sender : Server

Subscriber : Client

Subscriber : Client

Publisher/Sender : Server

#BHUSA @BlackHatEvents

Exploiting the Object Setters
Network Message
DataSetMetaData (DiscoveryResponse)
FieldMetaDataArray
KeyValuePair Variant
ExtensionObject

Subscriber : Client Subscriber : Client Subscriber : Client

Publisher/Sender : Server

Variant
(UNION)

Array/Matrix

Built in data type

#BHUSA @BlackHatEvents

 Demo? Multicast pubsub, RT communication..
#BHUSA @BlackHatEvents

Setting C++ Objects

CVE-2021-32994

TB5STACK

Binary Message

7 x

Extension Object Struct ExteTnyspieoIDn: OX/bY/jZe.c. t Struct ExteTnyspieoEInDn:cOoXd/bYin/jeZg.:c.XtMSLt/rBuicnatry
TypeIEDn:cXo/BdYio/ndZg.y:.:XML/BByitneaSrtyring object EncodBiondgy: :XML/BByinteaSrtyring object
Body: ByteString object

TB5OT

SDK C++ Objects

C Structure

#BHUSA @BlackHatEvents https://www.123rf.com/photo_141980838_stock-vector-crumpled-cube-box-icon-black-illustration-of-damage-breakage-pain-damnification-contour-isolated-vec.html

Not a one-time mistake...
#BHUSA @BlackHatEvents

Products
Specifications

Communication Stack
.NET standard
.NET legacy ANSI C legacy JAVA legacy

Commercial SDKs

Products

** This mapping is based on our best effort & knowledge; some vendors or relations may be missing or inaccurate **

#BHUSA @BlackHatEvents

Products
Configurations

Integration with OPC UA SDK/stack
#BHUSA @BlackHatEvents

SDK Integration
Required Interfaces
ServerConfig, NodeManager, IOManager
Optional Interfaces
MethodManager, EventManager, HistoryManager
http://documentation.unified-automation.com/uasdkcpp/1.4.2/html/L1ServerSdkIntroduction.html

#BHUSA @BlackHatEvents

Fuzzing Products
IOManager: * Read * Write * Monitor Items

...
#BHUSA @BlackHatEvents

Summary

ERP
MES SCADA

Cloud
Relay Broker

HMI

Controller

Field Devices

Controller
Field Devices

#BHUSA @BlackHatEvents

Stay Safe!

Matan Dobrushin
@matan_dob

Eran Jacob
@EranJacob linkedin.com/in/eranj

Special thanks to
Roman Dvorkin
linkedin.com/in/roman-dvorkin
and the rest of the team

Alon Zini
linkedin.com/in/alon-zini-3b9698185

