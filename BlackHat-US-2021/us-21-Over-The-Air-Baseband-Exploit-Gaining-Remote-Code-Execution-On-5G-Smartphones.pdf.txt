Over The Air Baseband Exploit: Gaining Remote Code Execution on 5G Smartphones
Marco Grassi (@marcograss) Xingyu Chen (@0xKira233)

Talk Agenda
 Introduction  Background  Research Preparation and Methodology  Target Identification  Audit Scope and Vulnerability Hunting  Vulnerability  Verifying the bug in an emulated environment  Debugging Tips  Exploitation and Challenges  DEMO  Environment Setup  Conclusions

Introduction
 In recent years the adoption of 5G networks and devices (consumer and IoT) skyrocketed
 All of them must have a 5G modem
 It's very important to secure those modems since they process untrusted data from a radio network.

Introduction
 Previously we examined the security of 2G,3G,4G modem and we achieved remote code execution over the air
 In the meanwhile 5G has been rolled out
 We will show what changed and that it's still possible to achieve RCE over the air on the modem with 5G

Background
 The security of 5G networks and especially modem baseband have not been thoroughly studied.
 We will cover the necessary main concepts in our talk but here are some relevant previous research, you can find the links in our whitepaper
 Our previous work on the Huawei modem remote code execution and pwn2own  Amat Cama work on Samsung Shannon  Comsecuris research on both Samsung Shannon, Intel and MediaTek basebands
 Those previous researches, even if on an older network generation, are still extremely relevant in the context of baseband research and exploitation.

Research Preparation and Methodology
What are the requirements and the goals for this research?
 Target Identification: We simply purchased all available 5G consumer phones to us at the time of this research, to find a candidate.
 Scope: We need to find a suitable vulnerability in a 5G component
 It must be triggerable remotely over the air  It must achieve remote code execution in the modem with good reliability
 Execution: We need to research and find a way to trigger the vulnerabilities we found, without having access to any commercial 5G base station.
 At the time of the research, there was no working 5G opensource base station project that we could use

Target Identification
 We purchased several 5G consumer devices available at the time of the research
 The minimum requirement was that they could *AT LEAST* leverage the 5G NR (5G New Radio)
 It was still the early days of 5G deployment so we ended up with 4-5 consumer smartphones.
 Their capabilities varies, so we need to make a detour and explain a difference between 5G devices

5G devices operating mode
 There are 2 main deployment of 5G for a device leveraging the 5G New Radio:
 Non Standalone Mode (NSA): This mode combines the 5G New Radio, and leverages the other component of a 4G network.
 Cheaper deployment, yet still faster speed than 4G thanks to the new radio.  It can reuse the old core network
 Standalone Mode (SA): This mode fully implements and use the 5G New Radio and 5G network specification.
 We believe SA mode is the future, so we decided to focus on this.

Our research target is found
 For our research we chose a Vivo S6 5G
 SA Mode  Exynos 980 SoC  Samsung Shannon Baseband  The baseband runs on its own ARM
Cortex core, separated from the AP (Application Processor), with a RTOS  AP and modem communicate with each other

Firmware
 We simply recovered the firmware from a full-OTA image for the device.
 After unpacking the firmware, the modem code it can be found in modem.bin file
 After finding the load address (https://github.com/marcograss/rbasefind) we can load it in IDA Pro and start hunting for vulnerabilities.

Audit Scope and Vulnerability Hunting
 We audited the 5G areas for some time and collected the vulnerabilities we found
 We selected the best candidate to use for this research  We hope this vulnerability is quite descriptive of the code quality of
modern modems  We quickly noticed while auditing the lack of stack cookies mitigation.
 Stack cookies are a mitigation that tries to stop the exploitation of stack based buffer overflow, by inserting a "magic cookie" before critical information on the stack is corrupted, in order to check it before returning from the function and hopefully detect if a overflow happened.
 This would make the exploitation of a stack overflow greatly simplified. Especially considering we lack any kind of debugging in this device modem.

Audit Scope and Vulnerability Hunting
 As you can imagine the bug we choose is a "stack overflow" memory corruption bug
 The interesting part it's that not only it's a stack overflow, but it's a stack overflow in a XML parser, inside the baseband.
 This XML parser is responsible for parsing IMS messages from the network to the device
 We will provide some information on IMS next.

IMS: Attack Vector Background
 IMS is the selected architecture for 4G and 5G on top of which interactive calling is built.
 We will show later why this is important  A baseband it's a IMS Client. It will handle VoLTE and VoNR messages
so it must be able to process SIP messages  The IMS Server uses SIP messages to communicate with the modem

IMS: Attack Vector Background
Here is an example of an INVITE message

IMS: Attack Vector Background
 SIP is a text-based, HTTP-like protocol, including headers and content.  The receiver (baseband) must parse those messages  The content can be not only key value pairs, but also XML format text.  XML is a much more complicated and bug-prone/error-prone format
to parse.  Usually a dedicated library is used, but here they implement it from
scratch.  This introduces an entirely new attack surface into the baseband.

Vulnerability
 Our OTA Remote Code Execution bug is in the IMS component of the baseband
 When parsing the XML content of a SIP message IMSPL_XmlGetNextTagName will be called
 This modem has no debugging symbols or information, so all function names, types, and function signatures, are either manually recovered from log strings, or by reverse engineering.

This function will parse an XML tag from src and copy its name to dst, e.g.
<meta name="viewport" content="width=device-width, initial-scale=1"> will get "meta" copied to the destination buffer.

 The function looks for the end of a tag by skipping special characters, e.g. space, '/', '>', '?'.
 There are no security checks at all.
 The function doesn't know how big is the destination buffer.
 All callers could potentially be exploited with a buffer overflow.
 By cross referencing the function IMSPL_XmlGetNextTagName, we found hundreds of calling places. Most of them are vulnerable because source buffer is fetched from OTA message, which is fully controlled by an attacker.

Verifying the bug in an emulated environment
 PC control works in a emulated Unicorn environment where we emulate the modem.

Debugging Tips
 Without vulnerabilities:
 adb logcat -b radio/all
 With vulnerabilities:
 Crash log -->
 With Code execution:
 Mechanism called RFS. When you read files through the API, it will appear on ADB log (useful for debugging)
 Unprotect code and write "UDF" instruction to inspect the functions you are interested in

Exploitation
 Pretty many callers found  Overflow on a stack buffer  No stack cookie  Easy game?

Exploitation Challenges
 Triggering message in early stage
 We are not able to complete whole VoLTE registration process
 Don't crash baseband  A deep function is better
 Payload length can be restricted by a shallow function call which have small stack frames to corrupt
 A call B  A call B call C ... call X 
 Characters blacklist
 find_tag_end will stop when encounters special chars  "\x00\x09\x0a\x0d\x20\x2f\x3e\x3f"

Exploitation Challenge #0
 Triggering message in early stage
 No XML payload delivered until NOTIFY message

Exploitation Challenge #1
 Don't crash baseband or crash it gently
 To prove the successful pwn with visual demonstration  Prevent unpredictable harm to the phone
 How?
 Write to a write-protect address e.g. code
 For debugging
 Return to the original address with no side effect
 Caller of IMSPL_XmlParser_RegInfoDecode  Return 0 as if no error

Exploitation Challenge #2
 A deep function is better
 More space to fit our payload  We don't have much knowledge about the calling stack  Choose an inner tag inside the XML

Exploitation Challenge #3
 Characters blacklist
 "\x00\x09\x0a\x0d\x20\x2f\x3e\x3f"  Affect both ROP and shellcode  Xor to bypass
 ROP
 Shellcode is easier

Visual Demonstration
 We're able to run arbitrary shellcode now  AP (Application Processor) and CP (Cellular Processor) are isolated
from each other  Communication through limited channels

Visual Demonstration
 International Mobile Equipment Identity (IMEI)  This information is shared between two processors  Fetched from NVRAM, persistent after reboot

Visual Demonstration
 NVRAM is a range of structured memory to CP
 Load from flash at initialization  Synchronized after reboot  Accessed with index  We can modify if we know the index

Visual Demonstration
 Sample shellcode

Environment Setup
 Ettus USRP B210  srsENB  Open5GS  sysmo-usim-tool & pysim  CoIMS & CoIMS_Wiki  docker_open5gs ...

Environment Setup
 IMS Server: Kamailio
 After initial setup, the suite works well on Qualcomm basebands  E.g. OnePlus 6(non-IPSec), Google Pixel 3(IPSec)  No luck for Samsung devices
 REGISTER and SUBSCRIBE must be succeed

Environment Setup
 Debugging IMS in Samsung Handsets
 Sysdump & Samsung IMS Logger
1. View normal registration messages 2. Capture the traffic on server 3. Diff and analyze 4. Modify the message and retry

Environment Setup
 IPSec issue
 Solution: force to disable IPSec from server side

Conclusions
 We presented you the state of 5G baseband security for one vendor  Although there has been an evolution in terms of network
functionalities, the security is still lagging behind the AP side by quite a bit.  Some basebands are lacking of even basic security measures  We hope in the future to do a new talk and compromise basebands with more security features and hardening.  Please check our whitepaper also for additional details and resources.

