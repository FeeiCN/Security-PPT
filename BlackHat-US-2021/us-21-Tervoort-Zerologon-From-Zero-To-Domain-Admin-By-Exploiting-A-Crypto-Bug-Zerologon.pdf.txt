Zerologon
from Zero to Domain Admin by Exploiting a Crypto Bug
Tom Tervoort
#BHUSA @BlackHatEvents

About me
 Tom Tervoort  Security Specialist at Secura  PhD student at Amsterdam UMC
2

#BHUSA @BlackHatEvents

Security protocols are three line programs that people still manage to get wrong - Roger Needham
Transport security broken by MitM => bad Authentication bypass by anyone => very bad
#BHUSA @BlackHatEvents
3

#BHUSA @BlackHatEvents
4

#BHUSA @BlackHatEvents
5

The Netlogon Remote Protocol
 Computer-to-DC and DC-to-DC RPC protocol  Maintaining (cross-)domain relationships  Pre-Windows 2000 domain replication  Facilitates domain authentication (primarily NTLM)  Machine account password reset
 Unique cryptographic authentication and transport security protocol
#BHUSA @BlackHatEvents
6

NTLM and Netlogon
#BHUSA @BlackHatEvents
7

Prior work: abusing Netlogon for NTLM relay
 NTLM session key used for NTLM relay mitigations such as SMB signing and EPA
 CVE-2015-005 (Core Security): steal key by passing intercepted challenge + response not directed at attacker machine
 Mitigation: match computer name in NTLM handshake with Netlogon client
 CVE-2019-1019 (Preempt): bypass this by removing name from NTLM_CHALLENGE
#BHUSA @BlackHatEvents
8

Netlogon authentication handshake
Shared secret: MD4(client password)
Session key: KDF(shared secret, client challenge, server challenge)
Client proof of identity: encrypt(session key, client challenge)
Encryption algorithms and "Secure RPC" negotiated with unauthenticated flags
#BHUSA @BlackHatEvents
9

Post-handshake authentication w/o Secure RPC
#BHUSA @BlackHatEvents
10

Shouldn't this be encrypted?
#BHUSA @BlackHatEvents
11

CVE-2019-1424: MitM to privileged RCE
1. Drop TCP connection 2. Fallback to SMB transport without
Secure RPC 3. NTLM admin login with any password 4. Alter response; leave authenticator 5. PSExec => RCE
CVSS score: 8.1 Patched November 2019
#BHUSA @BlackHatEvents
12

Idea: impersonating a client
1. Bypass handshake authentication 2. Downgrade attack to disable Secure RPC 3. Spoof an authenticator 4. Do something evil with a Netlogon call 5. ??? 6. Profit?
13

#BHUSA @BlackHatEvents

Step 1: bypass handshake authentication

 Input: attacker-controlled "challenge"  Sk: unknown session key  Output: can this be guessed?
14

#BHUSA @BlackHatEvents

Step 2: downgrade attack
Client-side: force AES crypto and "Secure RPC"

Server-side: force AES

Client-side: verify server flags

No protection: missing Secure RPC flag from client

#BHUSA @BlackHatEvents
17

Step 3: authenticator spoofing
Algorithm
Initial ClientStoredCredential = handshake credential = 0 So what if we pretend it's January 1st, 1970?
#BHUSA @BlackHatEvents
18

Step 4: this looks interesting...
#BHUSA @BlackHatEvents
19

Step 4: so we need to encrypt a password?
#BHUSA @BlackHatEvents
20

Can this actually work?
#BHUSA @BlackHatEvents
21

What if we set the DC machine password to ""?
#BHUSA @BlackHatEvents
22

The patch
 Released August 2020  Blocks handshake credential when first 5 bytes are identical  Server-side enforcement of Secure RPC for trust, DC and Windows accounts  Since February 2021: all clients must use Secure RPC, unless allowlisted  Allowing legacy client without Secure RPC support: Zerologon-style attack unlikely, but
still vulnerable to MitM.
#BHUSA @BlackHatEvents
23

Is Netlogon safe now?
 Well... I haven't found another practical exploit, but:
 Security properties of authentication protocol still dubious.  Netlogon "Secure RPC" does not authenticate DCE/RPC metadata (including Opnum).  Very strange replay protection.  What if legacy ciphers (based on 2DES and RC4) are enabled?  Complexity: implementation bugs?
 How much more critical infrastructure depends on obscure legacy cryptography?
#BHUSA @BlackHatEvents
24

AD cryptography: a can of worms?
#BHUSA @BlackHatEvents
25

