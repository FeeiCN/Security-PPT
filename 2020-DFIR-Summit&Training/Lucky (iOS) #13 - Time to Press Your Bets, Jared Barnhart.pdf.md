Time To Press Your Bets
Jared Barnhart @bizzybarney Parsons Corporation Test Engineer, Principal

@axi0mx

Oh, the timing.
 8 days after official iOS 13 release  iOS research culture change  Apple can't fix it  This is awesome  @mattiaep has free resources available
for more info!

Credit: regmedia.co.uk

Research all the things!

JFK-ish

Everything.
 Get an iPhone X (A11 chip) to maximize the longevity of this exploit  Prompt and unlimited access to the full iOS file system
 Native = Apple's applications, directories and files  Upon release, we have almost immediate access to jailbreak the OS  Affordable Forensic Research  For the cost of an iPhone 4s thru iPhone X you can do otherwise free forensic
research and analysis  TEST AND VERIFY!

Something old, something new, something borrowed, something really creepy.
 Facial Recognition in Photos  Recoverable Deleted Images  Personalization Portrait  3Bars - Rough WiFi Location
Tracking

Type to enter a caption.

Type to enter a caption.

Path: /private/var/mobile/Media/..
 The Native Photos application has evolved into an extremely intelligent repository of processed data about the images it contains
 Keyword searching  Facial recognition and categorization of specific people  "Moment" type categorization - Concerts, Museums, Sporting Events, Trips, Theme
Parks, Birthdays, Timeframes, and many more!  Place designations based on location data

Taking Photo
FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/PhotoData/takingphoto FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.HEIC FSE_CONTENT_MODIFIED 3876 "Camera"/private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.HEIC FSE_XATTR_MODIFIED 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.HEIC FSE_STAT_CHANGED 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.HEIC FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.MDATA FSE_CONTENT_MODIFIED 3876 "Camera"/private/var/mobile/Media/DCIM/.MISC/Incoming/61548763015__6E0F08AB-79E3-4BA5-A062-5DCD0678595C.MDATA FSE_STAT_CHANGED 3799 "assetsd" /private/var/mobile/Media/PhotoData/Photos.sqlite FSE_DELETE 3799 "assetsd" /private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/58E8EF6B-2C96-42C5-86EB-880AD19C572B FSE_CONTENT_MODIFIED 3799 "assetsd"/private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/58E8EF6B-2C96-42C5-86EB-880AD19C572B FSE_CONTENT_MODIFIED 3799 "assetsd"/private/var/mobile/Media/PhotoData/MISC/.PreviewWellImage.tiff-6H6U FSE_CREATE_FILE 3799 "assetsd" /private/var/mobile/Media/PhotoData/MISC/.PreviewWellImage.tiff-6H6U FSE_XATTR_MODIFIED 3799 "assetsd" /private/var/mobile/Media/PhotoData/MISC/PreviewWellImage.tiff FSE_CREATE_FILE 3799 "assetsd" /private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/EF5FC828-1F3F-4391-B67B-24CFF7D77F17 FSE_STAT_CHANGED 3799 "assetsd" /private/var/mobile/Media/PhotoData/Photos.sqlite-wal FSE_DELETE 3799 "assetsd" /private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/EF5FC828-1F3F-4391-B67B-24CFF7D77F17 FSE_CONTENT_MODIFIED 3799 "assetsd"/private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/EF5FC828-1F3F-4391-B67B-24CFF7D77F17 ^CLa-di-da-di-da:/private/var/mobile/Media root# /usr/bin/fsmon /private/var/mobile/Media/ FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/PhotoData/takingphoto FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.HEIC FSE_CONTENT_MODIFIED 3876 "Camera"/private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.HEIC FSE_XATTR_MODIFIED 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.HEIC FSE_STAT_CHANGED 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.HEIC FSE_CREATE_FILE 3876 "Camera" /private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.MDATA FSE_CONTENT_MODIFIED 3876 "Camera"/private/var/mobile/Media/DCIM/.MISC/Incoming/61548768822__41BE5297-788F-456A-A638-CE0381F0B0D8.MDATA FSE_CREATE_FILE 3799 "assetsd" /private/var/mobile/Media/PhotoData/MISC/.PreviewWellImage.tiff-vvgE FSE_CONTENT_MODIFIED 3799 "assetsd"/private/var/mobile/Media/PhotoData/MISC/.PreviewWellImage.tiff-vvgE FSE_CREATE_FILE 3799 "assetsd" /private/var/mobile/Media/PhotoData/MISC/.PreviewWellImage.tiff-vvgE FSE_XATTR_MODIFIED 3799 "assetsd" /private/var/mobile/Media/PhotoData/MISC/PreviewWellImage.tiff FSE_CREATE_FILE 3799 "assetsd" /private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/0204B38C-6BE6-4C3B-9A7C-F7442167750D FSE_DELETE 3799 "assetsd" /private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/0204B38C-6BE6-4C3B-9A7C-F7442167750D FSE_CONTENT_MODIFIED 3799 "assetsd"/private/var/mobile/Media/PhotoData/Caches/ClientServerTransactions/0204B38C-6BE6-4C3B-9A7C-F7442167750D

Closing Camera App

Now What?
 Ultimately writes the newly taken photo to /private/var/mobile/Media/DCIM/1**APPLE/IMG_0001.HEIC / .JPG
 User settings determine if HEIC (High Efficiency Image Format / Container) or JPEG is default file type
 Start of user's photos reside in ../100APPLE/ , but directories iterate upwards to 101APPLE, 102APPLE, etc. (mine is 116APPLE)
 iCloud synced Photos being enabled shows additional on-disk activity as the Cloud Photo Library (CPL)

Here comes the goodness..

Path: /private/var/mobile/Media/MediaAnalysis/mediaanalysis.db
 Scoring and analysis for each photo occurs in this file  Different factors such as sharpness, quality, shot type, human confidence, and more

Path: /private/var/mobile/Media/MediaAnalysis/mediaanalysis.db
 `Results' table tracks the results of the analysis, and joins to the `Assets'  Multiple results listed for each `assetId'  Each `resultsType' value represents a different measure of the analysis performed on the
individual asset, the result type is stored in the `results' BLOB

`results' column BLOB's
 BLOB's can be printed to .txt using `plutil'  BLOB where `resultsType' = 1 involves attributes about faces

BLOB Data Summary

SQL Query

Focused Results on `humanBounds and `humanConfidence' - 5019 rows returned

 Seems to be a constant process of analyzing the content of photos and videos
 This auger is feeding into the `Memories' and `People' categorization of Photos
 But how does the keyword search work?

Path: /private/var/mobile/Media/PhotoData/Caches/search/psi.sqlite
 Textual strings related to the searchable terms can be found in this file  Do NOT mistake the terms in this file for user created content, but the context found
in this file is derived from Apple's analysis of the media files  Apple is analyzing the content of the images and video files in Photos and attaching
search strings to certain files  There are sub-terms generated to point to the established keywords so if the user
searches for "truck" it might default to "Automobile" or "Vehicle"

`word_embedding' table
 The `word' column is ultimately the term that is being searched
 The `exended word' column is pointing back to the `word' column
 BLOB's in the database when exported to CSV show the words
 These values are not pre-populated, as the media files are analyzed new entries are written here

Database View

CSV View

`groups' table
 `groups' table contains some naming information related to the revolving categories that are constantly offered in Photos such as the names of People, Places, Events, Holidays, Seasons, etc.
 In the example below, I searched for `green bay' and one of the BLOB results listed is "Green Bay Packers vs. Miami Dolphins". Extremely specific, and exactly accurate. This device went to one NFL football game in Green Bay, Wisconsin and the Packers played the Miami Dolphins.

You might, but later you will regret it.

It gets creepy now.
 ~67 tables full of data about the native Photos and Cloud Photo Library
 Potentially several hundred MB's in size (mine was ~324MB)
 It knows when a stranger is looking at your baby..
Path: /private/var/mobile/Media/PhotoData/Photos.sqlite

ZDETECTEDFACE Table
 Age  Hair Color  Baldness  Gender  Eye Glasses  Facial Hair  X and Y axis measurements for left eye, right eye, mouth, and center  Person Identifier - joins to ZPERSON table

ZPERSON Table
 Face Count - Number of times the face is known in the Photos
 Display Name  Full Name  Person UUID  CONTACTMATCHINGDICTIONARY - If
yes, possible to get phone number for person from BLOB

SQL Query

 Query only hits on photos with faces and outputs: file name and directory, age estimate rating, gender, glasses type, facial hair type, baldness, person name, number of times the person's face is recognized in Photos, location coordinates if available, Moment location title.
 Additional research can be done fore hair color, and more.

Therefore, fully deleted photos are generally gone forever.

 Typically when recovering deleted photos in mobile devices, they are being carved from unallocated space of internal or external flash memory.
 Allocated photos are logically accessible in the file system, meaning the user can still open them, share them, etc.
 Unallocated photos are no longer accessible to the user, but the data that was the photo file can still reside in the unallocated area until clean-up algorithms clear that block of flash memory to be used again by the file system.
 On iOS devices after the iPhone 4, the unallocated space is ENCRYPTED so we cannot address the unallocated area. Thus, why no physical iOS extractions.
 `Recently Deleted' folder = Not Deleted. Simply starts a counter in a database to actually delete at a later time.

Path: /private/var/mobile/Library/Caches/com.apple.MobileSMS/Previews/Search
 Not necessarily new, but I didn't learn about it until very recently and was able to test it on multiple devices with repeated results
 Within Messaging application, if you touch the Contact or Group icon at the top of the screen, and then the small "i" in a circle, it presents among other things the media files exchanged within that thread
 Upon pressing that small "i" in a circle, those photos are written to disk in the path above  Upon deleting the photo from the thread, and with never having saved the media files, the
media files can still be found  Attribution is the difficult part, but I'll take a deleted photo all day, every day!
Thanks to Sgt. Ryan Socks for bringing this artifact to my attention!

New Device

iMessage Thread Started

Check of the Directory

../Previews/Search doesn't exist!

Photo Received While Monitoring the ../com.apple.MobileSMS/ directory
Photo received Message thread populated the ../Previews/Attachments directory and stored a .ktx image file there that was NOT a preview of the attachment, but instead an all pink image.
Still no ../Previews/Search directory though!

Press the small i for info while monitoring the ../com.apple.MobileSMS/ directory info screen
../Previews/Search directory is created!

Check of the ../Search directory reveals a .png

Time to DELETE!!!
No Preview Image in info

Apple kept a copy for you! You're welcome.
 This photo was never saved anywhere else  The photo is no longer visible to the user  Pressing the info small i caused the ../Search
directory version of the image to be created  It IS NOT deleted when the user deletes the image  It IS NOT deleted when the user deletes the entire
thread

Path: /private/var/mobile/Library/PersonalizationPortrait/PPSQLDatabase.db
 Native file first appearing on iOS 13  iOS 12 had the PersonalizationPortrait directory but no database within it.  Confirmed in iOS 14 beta via iTunes backup - with even more data!  Aggregates pieces of data from many different sources including Maps, Mail, Messages,
Photos, Safari, News, Notes, and Core Routine data.  `Personalization' suggests Apple is trying to customize content for the user.  Data constantly changing as the user performs actions on the device.  This database is fascinating and frightening at the same time so investigate it, but BE
CAREFUL!!

 Can harvest data from 3rd Party Apps, CoreRoutine, Maps, PhotoData, Safari, and more.
 CoreRoutine is duplicative of Local.sqlite, Cloud-V2.sqlite, but this is another source for "Significant Locations" data
 Attribution is difficult! One row from Crew App, next from Apple Maps, then CoreRoutine, and then text from an open Safari tab that included a city, state, or country name.

Data selected then placed onto a map, and it's accurate!

 Possible to find data derived from a 3rd party installed application that otherwise might have been overlooked.
 Below, a location based notification was setup for a workgroup named "Dundee Candidates" in the Crew app to show chat availability only when the device was in a pre-set geofence.

 `ne' believed to mean `name'
 Selects `name' data from Safari browser tabs, Apple Maps, CoreRoutine, Contacts, and other sources
 Name can be of a place, person, company, object (such as "Outback Dundee Lounger" as a type of chair)

Why? Diabolical plan?
 In a recent SMS message with my uncle, I called him "Uncle Rodney" in my reply to him. From that message, the `ne_records' table recorded "Uncle Rodney" and separately his last name which was not said in the SMS message.
 So this table grabbed "Uncle Rodney <Last Name>" and recorded them. WHY?? Is my phone going to use my using "Uncle" to some way associate that contact as a family member?

Credit: super-villain.fandom.com

 `tp' believed to mean `topic'
 Interesting artifact is the `extraction_os_build' column which can contain other Cloud connected devices
 Can be joined to `sources' table to get a rough estimate of the timeframe for the OS upgrades, and also show when the activity came from a secondary device
iOS Version History iOS-17A577 = iOS 13.0 iOS-17A878 = iOS 13.1.3 iOS-17B111 = iOS 13.2.3 iOS-17C54 = iOS 13.3 iOS-17D50 = iOS 13.3.1 iOS-17F75 = iOS 13.5
Credit: theiphonewiki.com

Apparently just three.

Path: /private/var/root/Library/Caches/com.apple.wifid/ThreeBars.sqlite
 Believed to be Apple offering publicly available WiFi access points to iDevices  Tends to be commercial buildings, not residential homes  Coarse location tracking made possible by this file recording Latitude, Longitude and WiFi BSSID's (Basic Service Set
Identifiers) of nearby access points  Relies on an internet connection (WiFi or cellular) to estimate the location of the device as it relates to nearby WiFi
access points.  Tested device with no internet connection using navigation app, and no data was populated to this file  ~6 days of stored data  How are these networks populated?  If a hotel's open WiFi constantly has iPhones connected to it...does Apple give that network a higher popularity
score?

Only PPSQL

Ehh..sort of.

Only ThreeBars

PPSQL+ThreeBars+C ache.sqlite

 Every iPhone on iOS 13+ is constantly checking in with Apple on where it is when it is internet connected, and this file populates nearby wireless access points.
 Fences and gates do not stop the access point data from being shared to nearby iDevices.
 Is your corporate / government access point making this list?
 Does this mean Apple knows how many iPhones are connected to a WiFi network? Are they recording it and then using the data to suggest that network to others nearby?

 Sarah Edwards @iamevltwin  Heather Mahalik @HeatherMahalik  Brigs @AlexisBrignoni  Josh Hickman @josh_hickman1  checkra1n  unc0ver  DB Browser for SQLite  HexFiend

Additional details soon on mac4n6.com
Jared Barnhart @bizzybarney Parsons Corporation Test Engineer, Principal

