ROCK APPROUND THE CLOCK!
Tracking Malware Developers by Android "AAPT" Timezone Disclosure Bug
@unapibageek - @ssantosv

Sheila Ayelen Berta
Security Researcher ElevenPaths
(Telefonica Digital cyber security unit)

Sergio De Los Santos
Head of Innovation and Lab ElevenPaths
(Telefonica Digital cyber security unit)

@unapibageek - @ssantosv

@unapibageek - @ssantosv

@unapibageek - @ssantosv

@unapibageek - @ssantosv

WHAT WE DID?
@unapibageek - @ssantosv

WHAT WE DID?
@unapibageek - @ssantosv

WHAT WE DID?
@unapibageek - @ssantosv

WHAT WE DID?
@unapibageek - @ssantosv

@unapibageek - @ssantosv

WHAT IS AAPT?
@unapibageek - @ssantosv

WHAT IS AAPT?
@unapibageek - @ssantosv

Aapt timezone disclosure
@unapibageek - @ssantosv

Aapt timezone disclosure
@unapibageek - @ssantosv

Aapt timezone disclosure
@unapibageek - @ssantosv

Aapt timezone disclosure
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE

@unapibageek - @ssantosv

EVEN = 0

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

ANALYZING SOURCE CODE
@unapibageek - @ssantosv

THE PROBLEM
BUG = LOCALTIME(0)
@unapibageek - @ssantosv

THE PROBLEM
BUG = LOCALTIME(0) EXPECTED = LOCALTIME(TIMESTAMP)
@unapibageek - @ssantosv

runtime analysis
@unapibageek - @ssantosv

runtime analysis
@unapibageek - @ssantosv

runtime analysis
@unapibageek - @ssantosv

runtime analysis
@unapibageek - @ssantosv

runtime analysis
@unapibageek - @ssantosv

WHY A TIMEZONE?
Localtime(): HOUR = UNIX EPOCH +/- TIMEZONE
@unapibageek - @ssantosv

WHY A TIMEZONE?
Localtime(): HOUR = UNIX EPOCH +/- TIMEZONE
E.g: GMT +3 = UNIX EPOCH + 3Hs GMT -3 = UNIX EPOCH - 3Hs
@unapibageek - @ssantosv

WHY A TIMEZONE? AAPT BUG = 0 +/- TIMEZONE
@unapibageek - @ssantosv

WHY A TIMEZONE?
AAPT BUG = 0 +/- TIMEZONE
E.g: GMT +3 = 0+3 = 01-01-80 03:00 GMT -3 = 0-3 = 12-31-79 21:00
@unapibageek - @ssantosv

A LITTLE DETAIL
@unapibageek - @ssantosv

A LITTLE DETAIL
@unapibageek - @ssantosv

A LITTLE DETAIL
@unapibageek - @ssantosv

GMT +0 = 01-01-80 00:00 GMT +1 = 01-01-80 01:00 GMT +2 = 01-01-80 02:00 GMT +3 = 01-01-80 03:00 GMT +4 = 01-01-80 04:00 GMT +5 = 01-01-80 05:00 GMT +6 = 01-01-80 06:00 GMT +7 = 01-01-80 07:00 GMT +8 = 01-01-80 08:00 GMT +9 = 01-01-80 09:00 GMT +10 = 01-01-80 10:00 GMT +11 = 01-01-80 11:00
@unapibageek - @ssantosv

Offset table

GMT +0 = 01-01-80 00:00 GMT +1 = 01-01-80 01:00 GMT +2 = 01-01-80 02:00 GMT +3 = 01-01-80 03:00 GMT +4 = 01-01-80 04:00 GMT +5 = 01-01-80 05:00 GMT +6 = 01-01-80 06:00 GMT +7 = 01-01-80 07:00 GMT +8 = 01-01-80 08:00 GMT +9 = 01-01-80 09:00 GMT +10 = 01-01-80 10:00 GMT +11 = 01-01-80 11:00
@unapibageek - @ssantosv

Offset table
GMT +12/-12 = 01-01-80 12:00 GMT -11 = 12-31-80 13:00 GMT -10 = 12-31-80 14:00 GMT -9 = 12-31-80 15:00 GMT -8 = 12-31-80 16:00 GMT -7 = 12-31-80 17:00 GMT -6 = 12-31-80 18:00 GMT -5 = 12-31-80 19:00 GMT -4 = 12-31-80 20:00 GMT -3 = 12-31-80 21:00 GMT -2 = 12-31-80 22:00 GMT -1 = 12-31-80 23:00

EVEN BEYOND AAPT
@unapibageek - @ssantosv

EVEN BEYOND AAPT
@unapibageek - @ssantosv

EVEN BEYOND AAPT
@unapibageek - @ssantosv

@unapibageek - @ssantosv

apks == zip
@unapibageek - @ssantosv

apks == zip
@unapibageek - @ssantosv

YOU CAN CREATE CERTIFICATES AD-HOC WHEN YOU ARE ABOUT TO COMPILE YOUR APK

SELF SIGNED CERTIFICATES

@unapibageek - @ssantosv

SELF SIGNED CERTIFICATES
CERTIFICATES STORE THE TIME AND DATE OF THE COMPUTER WHERE THEY HAVE BEEN CREATED, IN UTC TIME
@unapibageek - @ssantosv

DATETIMES
Signature file datetime is the local
computer time (timezone included):
Certificate creation datetime (UTC):
@unapibageek - @ssantosv

DATETIMES
Signature file datetime is the local
computer time (timezone included):
+-50 seconds later than the certificate
2018/05/24 15:27:10
Certificate creation datetime (UTC):
2018/05/24 22:26:22
@unapibageek - @ssantosv

rock appround The clock

File time

Cert time

2018/05/24 15:27:10 - 2018/05/24 22:26:22

=

-7 hours and 48 seconds: GMT -7

@unapibageek - @ssantosv

Another example:

rock appround The clock

File time

Cert time

2018/07/08 14:30:16 - 2018/07/08 13:30:12

=

1 hour: GMT +1
(File created 4 seconds after the cert...)

@unapibageek - @ssantosv

mapping the timezone

UTC 0 STORED IN CERTIFICATE
UTC +8 STORED IN ZIP FILE

Assuming minutes and seconds are "close
in time" because certificate and signature are created
together

@unapibageek - @ssantosv

mapping the timezone

UTC 0 STORED IN CERTIFICATE
8 HOURS UTC +8
STORED IN ZIP FILE

Assuming minutes and seconds are "close
in time" because certificate and signature are created
together

@unapibageek - @ssantosv

GMT CHECK TOOL
@unapibageek - @ssantosv

GMT CHECK TOOL
@unapibageek - @ssantosv

GMT CHECK TOOL
@unapibageek - @ssantosv

GMT CHECK TOOL
@unapibageek - @ssantosv

statistics
@unapibageek - @ssantosv

statistics
TIMEZONE LEAKAGE BY AAPT BUG: 179.122 APKs TIMEZONE LEAKAGE BY DATETIMES: 477.849 APKs

61056 APKs AAPT BUG

3082

31708 APKs

APKs TIMESTAMP

LEAK

18479
APKs 2969 AAPT APKs
BUG

62863 APKs TIMESTAMP LEAK

UTC +0

UTC +7

MORE THAN HALF A MILLION OF APKs LEAKING THEIR TIMEZONE
FROM OUR 10 MILLION APKS DATABASE
@unapibageek - @ssantosv

Is this useful for malware?

MALWARE (1000 SAMPLES) ANALYZED WITH AAPT TIMEZONE DISCLOSURE

Type
UTC +0 UTC +1 UTC +2 UTC +3 UTC +4 UTC +5 UTC +6 UTC +7 UTC +8 UTC +9 UTC +10 UTC +11 UTC +12 UTC -1 UTC -2 UTC -3 UTC -4 UTC -5 UTC -6 UTC -7 UTC -8 UTC -9 UTC -10 UTC -11

# of APKs
1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 532 276
72 1000 1000 391 1000 1000 1000 1000
21 10 2 6

Detected only by 1 AV 45 55 60 38 71 74 54 66 102 57 15 18 6 61 42 19 74 53 30 92 3 0 0 0

@unapibageek - @ssantosv

Detected only by 2 AV 13 5 6 21 28 7 0 18 47 4 3 0 0 10 25 2 3 13 10 11 1 1 0 0

Detected only by 3 AV 6 4 4 6 27 6 1 9 39 0 2 4 0 11 17 3 6 11 9 8 0 0 0 0

Detected by +3 AV 22 30 26 21 72 22 3 46 126 4 10 47 0 19 17 2 16 6 68 62 0 0 0 0

TOTAL
86 94 96 86 198 109 58 139 314 65 30 69 6 101 101 26 99 83 117 173 4 1 0 0

% detected
8,60% 9,40% 9,60% 8,60% 19,80% 10,90% 5,80% 13,90% 31,40% 6,50% 5,64% 25,00% 8,33% 10,10% 10,10% 6,65% 9,90% 8,30% 11,70% 17,30% 19,05% 10,00% 0,00% 0,00%

% of samples identified as malware

statistics
1000 SAMPLES WITH AAPT TIMEZONE DISCLOSURE
@unapibageek - @ssantosv

Is this useful for malware?

MALWARE (1000 SAMPLES) ANALYZED WITH FILE/CERTiFICATE DATETIMES

Type
UTC +0 UTC +1 UTC +2 UTC +3 UTC +4 UTC +5 UTC +6 UTC +7 UTC +8 UTC +9 UTC +10 UTC +11 UTC +12 UTC -1 UTC -2 UTC -3 UTC -4 UTC -5 UTC -6 UTC -7 UTC -8 UTC -9 UTC -10 UTC -11

# of APKs
1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 1000 276 588 293

Detected only by Detected only by Detected only by

1 AV

2 AV

3 AV

35

16

11

58

8

2

76

13

16

91

28

15

72

27

18

58

29

31

98

24

16

53

20

3

83

31

16

71

51

3

43

7

16

53

12

7

55

10

1

17

6

3

29

9

6

36

3

4

59

11

5

49

7

2

43

15

8

33

11

7

35

10

4

16

4

2

36

21

4

26

4

1

Detected by +3 AV 107 26 80 60 65 153 70 43 218 36 44 139 59 31 29 40 145 153 383 23 32 24 24 20

TOTAL
169 94 185 194 182 271 208 119 348 161 110 211 125 57 73 83 220 211 449 74 81 46 85 51

% detected
16,90% 9,40% 18,50% 19,40% 18,20% 27,10% 20,80% 11,90% 34,80% 16,10% 11,00% 21,10% 12,50% 5,70% 7,30% 8,30% 22,00% 21,10% 44,90% 7,40% 8,10% 16,67% 14,46% 17,41%

@unapibageek - @ssantosv

% of samples identified as malware

statistics
1000 APKS WITH FILE/CERTiFICATE DATETIMES (do not forget DST!)
@unapibageek - @ssantosv

DISTRIBUTION OF MALWARE BY TIMEZONE AND USING...

statistics

3807 APKS IDENTIFIED AS MALWARE WITH 2055 APKS IDENTIFIED AS MALWARE WITH

FILE/CERTIFICATE DATETIMES

AAPT TIMEZONE DISCLOSURE

@unapibageek - @ssantosv

statistics

IN OUR DATABASE, THE STANDARD RATE IS: FOR EACH RANDOM 1000APKS WE IDENTIFY 60 AS MALWARE, So:

1000 APKs sample
UTC +5 UTC +8 UTC -5 UTC -6 UTC +4 UTC +8

# APKs Detected by +3 AV
153 218 153 383 72 126

Times more likely to be malware than Standard Rate 2,55 3,63 2,55 6,38 1,20 2,10

IN SHORT: AN UTC-6 APK IS 6,38 TIMES MORE LIKELY TO BE MALWARE THAN STANDARD RATE

@unapibageek - @ssantosv

EXAMPLES
@unapibageek - @ssantosv

EXAMPLES

FILE/CERTiFICATE DATETIMES REAL EXAMPLE: DEATHRING
@unapibageek - @ssantosv

AAPT TIMEZONE DISCLOSURE REAL EXAMPLE: JUDY

EXAMPLES
CHINESE COMPILED APKS IN THE SPOTLIGHT
@unapibageek - @ssantosv

HIDDAD MALWARE, COMES FROM...

EXAMPLES

@unapibageek - @ssantosv

EXAMPLES

BOTH TECHNIQUES EXAMPLES:

certificateValidFrom signatureFileLastUpdateDate oldestDateFile

File/Certificate DateTime Technique

2016/12/04 07:27:57 2016/12/03 16:21:02 2016/12/03 11:52:30

2016/12/04 10:30:14 2016/12/03 19:24:30 2016/12/03 14:55:54

1980/01/01 03:00:00 1980/01/01 03:00:00 1980/01/01 03:00:00

03:02:17 03:03:28 03:03:24

@unapibageek - @ssantosv

EXAMPLES

BOTH TECHNIQUES EXAMPLES:

certificateValidFrom signatureFileLastUpdateDate oldestDateFile

File/Certificate DateTime Technique

2016/12/04 07:27:57 2016/12/03 16:21:02 2016/12/03 11:52:30

2016/12/04 10:30:14 2016/12/03 19:24:30 2016/12/03 14:55:54

1980/01/01 03:00:00 1980/01/01 03:00:00 1980/01/01 03:00:00

03:02:17 03:03:28 03:03:24

FULLY AUTOMATED?

@unapibageek - @ssantosv

@unapibageek - @ssantosv

metadata
WANNACRY METADATA, THE INSPIRATION
@unapibageek - @ssantosv

metadata
WANNACRY METADATA, THE INSPIRATION
@unapibageek - @ssantosv

metadata
WAS IT USEFUL IN ANDROID MALWARE?
@unapibageek - @ssantosv

metadata
WAS IT USEFUL IN ANDROID MALWARE?
@unapibageek - @ssantosv

strings
./aapt d --values strings android_app.apk
@unapibageek - @ssantosv

strings
./aapt d --values resources android_app.apk | grep '^ *resource.*:string/' --after-context=1 > output.txt
@unapibageek - @ssantosv

Our tool
@unapibageek - @ssantosv

Conclusions & Future Work
We presented different ways for not just leaking timezone but as well... · Possibly detecting automated malware creation · Possible better Machine learning features in
detecting APK malware · A tool for a quick view of all this useful
information around APKs metadata Future work should be more accurate about DST and using more samples
@unapibageek - @ssantosv

Thank you!

Sheila Ayelen Berta
Security Researcher ­ ElevenPaths (Telefonica Digital cyber security unit)
@UnaPibaGeek sheila.berta@11paths.com

Sergio De Los Santos
Head of Research ­ ElevenPaths (Telefonica Digital cyber security unit)
@ssantosv sergio.delossantos@11paths.com

@unapibageek - @ssantosv

