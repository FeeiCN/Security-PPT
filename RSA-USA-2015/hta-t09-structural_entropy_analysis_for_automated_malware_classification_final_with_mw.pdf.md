SESSION ID: HTA-T09
Structural Entropy Analysis for Automated Malware Classification

Matt Wolff and Glenn Chisholm
Chief Data Scientist  Chief Technology Officer Cylance, Inc. @cylanceinc

#RSAC

#RSAC
Overview: The Problem
 Malware can obfuscate its purpose by encrypting or compressing code segments within the PE structure.
 First-order obfuscation techniques (encryption and compression) can disguise the malicious commands so that they pass through traditional "signature-based detection" of anti-virus programs.
 Meta-obfuscation techniques (e.g. null content insertion) can then disguise the encryption and compression so that the file passes through entropy filters.
2

#RSAC
Overview: The Contribution
 We describe a technique called structural entropy analysis which can help to detect the presence of suspicious patterns of obfuscation.
 Structural entropy analysis goes beyond mean entropy analysis and mere "detection of packing" to find suspicious patterns of entropy change.
 It quantifies the "amount of structure" in the entropy signal; finds the location of mean change points; and computes the distribution of energy across multiple spatial scales.
 It then derives 387 mathematical features which are jointly predictive of the file being malware.  Structural entropy is much harder for a malware writer to control than commonly used
measures such as mean entropy alone.  SE performs well (87.2% accuracy) on predicting malicious behavior for completely novel
files "in the wild." Moreover, it can easily be combined with other types of features.
3

#RSAC
Apply Slide: Relevance to Audience
 For Architects & Consumers of Machine Learning-Based AntiMalware Systems:
 We illustrate the usefulness of incorporating 520 structural entropy features within a machine learning classifier.
 For Architects & Consumers of Detection-Based Anti-Malware Systems:
 We provide an in-depth example of how "soft-constraint" features can be built for a machinelearning type system.
4

#RSAC
Mean entropy: A first clue to packing
High entropy is a symptom of "packing" (compression or encryption)
 Entropy calculated over neighboring bins of 256 bytes  Minimum possible entropy = 0 bits; maximum possible entropy = 8 bits
Lyda, R., & Hamrock, J. (2007). Using entropy analysis to find encrypted and packed malware. IEEE Security & Privacy, (2), 40-45. 5

#RSAC
Structural entropy: "Time series" approach
 We treat the file as an entropy time series. We want to take into account sequential structure
 The entropy measurements, taken at adjacent points in the code, are not independent and identically distributed, but have strong spatial correlations (based on proximity)
6

#RSAC
Structural entropy: "Time series" approach
 The executable file's raw machine code (in hex) is split into non-overlapping chunks of fixed length, typically 256 bytes.
 Where
 H is entropy  c is a chunk of code  n is the number of possible
characters (here n=256)  pi is the probability of each
character in the chunk
7

#RSAC
Nonstationary Time Series: Which tools can we use?
 Problem: This is a nonstationary time series.
 Statistical features (mean, variance, etc.) change over the file.
 But most time series approaches assume stationarity.
 E.g. Fourier decompositions, autoregressive models, moving average models.
8

#RSAC
Nonstationary Time Series: Which tools can we use?
 Solution: We characterize entropy streams as meanchange point time series.
 Structure: local stable means plus noisy variation around that mean
 Local stable means have an unknown length.
9

#RSAC
Nonstationary Time Series: Three Modeling Techniques
Statistical tools which discover the underlying structure of software entropy
10

#RSAC
11

#RSAC
This Work vs. Previous Work
 Moreover, by applying the big-picture modeling perspective of nonstationary time series, we broaden the notion of structural entropy
 In particular, we gain  At least two new techniques (DFA, MCPM)  Development of wavelet techniques (Multi-Resolution Analysis)  A multi-tiered workflow (see "Structural Entropy Analysis Flowchart")
12

Method Overview
ENTER BULLETPOINTS FROM GOLDEN
13

#RSAC
Features are shown in the 5th and 6th columns. Model-based features are shown in orange. Propensity features, which require pre-processing by logistic regression, have thick borders.

#RSAC
This Work vs. Previous Work
 Previous work: structural entropy analysis computes similarity between 2 files.  This goal comes from a signature-based approach.
 This project: structural entropy analysis extracts predictive features from 1 file.  This goal comes from a machine-learning approach.
e.g. Baysa, Donabelle, Richard M. Low, and Mark Stamp. "Structural entropy and metamorphic malware." Journal of Computer Virology and Hacking Techniques, 9.4 (2013): 179-192.
14

First Modeling Technique:

#RSAC

Detrended Fluctuation

Analysis (DFA)

#RSAC
Detrended Fluctuation Analysis (DFA): Intro
 Derived from random fractal theory.
 Generalizes the Hurst statistic for stationary processes, which quantifies the extent to which time series exhibit power-law (i.e. unusually slowly decaying) correlations.
 Fits piecewise linear models to integrated time series at different spatial scales.
 Has been applied to non-stationary signals in bioinformatics (neuronal spiking, DNA sequences, heart rate dynamics, human gate analysis) and theoretically studied in physics.
Chen, Z., Ivanov, P. C., Hu, K., & Stanley, H. E. (2002). Effect of nonstationarities on detrended fluctuation analysis. Physical Review E, 65(4), 041107.
16

#RSAC
Detrended Fluctuation Analysis (DFA): Algorithm Heart beat interval time series
Integrated version
17

#RSAC
Detrended Fluctuation Analysis (DFA): Concept : How does error amplify as models simplify?
18

#RSAC
Detrended Fluctuation Analysis (DFA): Utility in Previous Research
Peng, C. K., Havlin, S., Stanley, H. E., & Goldberger, A. L. (1995). Quantification of scaling exponents and crossover phenomena in nonstationary heartbeat time series. Chaos: An Interdisciplinary Journal of Nonlinear Science, 5(1), 82-87.
19

#RSAC
Detrended Fluctuation Analysis (DFA): Application to Software Entropy Question: How would this technique apply to a mean change point time series?
20

#RSAC
Detrended Fluctuation Analysis (DFA): Pilot Test
The DFA statistic, , describes the level of structure in the entropy time series
 Pilot study: n=93 files that had between 4000 and 5000 entropy blocks
 Shown are files with:
 5 lowest `s (left column)  5 highest `s (right
column)
 Note that, as we argued, files with larger tend to be more "structured": they flip between stable local means
21

#RSAC
Detrended Fluctuation Analysis (DFA): Our Data
DFA is essentially uncorrelated with mean entropy!
22

Second Modeling Technique:

#RSAC

Mean Changepoint Modeling

(MCPM)

#RSAC
Mean Changepoint Modeling: Intro
 A major problem for reverse engineering of software is to identify the entry points for encrypted or compressed sections.
 Mean change point modeling can automatically determine the inherent sections of a file according to entropy-based code regimes (native code, strings, padding, encryption, compression)
 These code regimes needn't align with author-designated section labels: text, rsrc, reloc, data, etc.
24

Mean Changepoint Modeling: Concept

#RSAC

25

#RSAC
Mean Changepoint Modeling: Example Fit
26

#RSAC
Mean Changepoint Modeling: Features
These features characterize the size and prevalence of jumps, the value of landmark mean entropies, and the fit of the model.
27

#RSAC
Mean Changepoint Modeling: Algorithm
The mean change point model solves
28

Mean Changepoint Modeling: Limitations

#RSAC

29

Third Modeling Technique:

#RSAC

Wavelet Decomposition

#RSAC
Wavelet Transforms: Intro
 The Wavelet Transform is a generalization of the Fourier Transform.  The Wavelet Transform we have chosen is known as a Haar Wavelet
Transform.  We can project the original entropy signal onto a family of square waves.  By re-representing the signal in terms of changes at various scales, the Haar Wavelet Transform performs a multi-resolution analysis, revealing how entropic changes in the computer program are distributed across small, intermediate, and large scales.
31

Haar Wavelet Decompositions

#RSAC

32

Haar Wavelet Decompositions

#RSAC

33

#RSAC
Wavelet-Based Functional Approximations
Entropy Time Series projected onto Haar father wavelet space with 23 segments
34

#RSAC
Wavelet-Based Functional Approximations
Entropy Time Series projected onto Haar father wavelet space with 26 segments
35

#RSAC
Wavelet-Based Functional Approximations
Entropy Time Series projected onto Haar father wavelet space with 2J segments
36

#RSAC
Wavelet Energy Spectrum: Formula
37

#RSAC
Wavelet Energy Spectrum: Summary
 We perform a multi-resolution analysis, revealing how entropic changes in the computer program are distributed across small, intermediate, and large scales.
 The wavelet coefficients summarize the amount of "detail" or "change" exhibited within a time series at various locations over various levels of resolution.
 Using these wavelet coefficients, we summarize the overall amount of entropic detail in a time series at various levels of resolution. The total amount of detail at a particular level of resolution is known as its energy.
 The distribution of energy across various levels of resolution is known as an energy spectrum.
38

#RSAC
Wavelet Energy Spectrum as Features
 There is strong precedent, especially in biology, for using the energy spectrum of signals as features within automatic classification systems.
 For instance, using wavelet coefficients, researchers have been able to  Automatically classify lung sounds into categories (crackles, wheezes, striders, squawks, etc.)  Determine whether brain EEG scans originated from healthy patients, patients with epilepsy, or patients who were in the middle of having a seizure.  Determine whether EMG signals collected from the bicep originated from patients who were healthy, suffering from myopathy, or suffering from neurogenic disease
39

Pilot Study on n=1,599 files of size J=5

#RSAC
These are (Haar) waveletbased functional approximations to a representative good and bad file.

40

Pilot Study on n=1,599 files of size J=5

#RSAC

41

#RSAC
A problem in application to malware analysis
 The biological studies above were all controlled observational situations which produced time series samples (e.g. lung sounds, brain EEGs) of fixed length.
 Thus, these samples all produce the same number of wavelet energy features, J
 Variation in these J features were then immediately associated with a classification variable (categories of lung sounds, presence/absence of epilepsy, etc.) by setting the input layer of the neural network to have J activation notes.
 Yet executable files out in the "wild" have different lengths, and so J will vary from sample to sample.
42

#RSAC
Wavelet Energy Spectrum Suspiciousness: Definition
 To solve this problem, we create an algorithm which converts the wavelet energy spectrum into a malware "propensity score" or "suspiciousness score" within [0,1] describing the "propensity" of that executable file to be malware based on the wavelet energy spectrum alone.
 We call the resulting feature Wavelet Energy Spectrum Suspiciousness
 This feature can be compared from sample to sample. the input layer of the neural network to have J activation notes.
43

#RSAC
Data

#RSAC
Data
 Data is a corpus of Windows Portable Executable (PE) files.  We formed a balanced data set of 39,968 files; of these, 19,991
(50.01%) were malware, whereas 19,997 (49.98%) were clean computer programs.  The "malware" category contained different types of malicious software (e.g., computer viruses, Trojan horses and spyware -- but not adware).
45

#RSAC
Data: Training and test Set
 Before feature extraction, 31,676 (80%) of the samples were randomly selected to belong to the "training set," and the other 7,916 (20%) of the samples were classified in the "test set."
 The training set was used to
1. train the feature weights in the final classifier 2. determine the sparsity of the final classifier 3. determine weights for constructing the "propensity features"
46

#RSAC
Method

#RSAC
Feature Overview
48

#RSAC
Model Building: Lasso Logistic Regression
 We model the binary classification variable (malware or not) as a function of the 520 features related to structural entropy described above.
 We apply lasso logistic regression, a principled statistical method for model fitting while simultaneously performing feature selection.
 The logistic lasso produces an entire set of models, indexed by the sparsity parameter, . As the sparsity parameter increases, the size of the model decreases (by discarding features).
 The value of the sparsity parameter can be optimized. Thus, the lasso discovers the optimal proportion of features useful for classification
49

#RSAC
Model Building: Lasso Logistic Regression
50

#RSAC
Model Building: Lasso Logistic Regression
51

#RSAC
Results

#RSAC
Optimal sparsity of model
Our feature construction method was rather liberal. For example, our original dataset included 488 interaction terms (bivariate products of simpler features), and these had no a priori justifications. Could we have used far fewer than 520 features in our set?
53

Optimal sparsity of model: Keep 387 Features

#RSAC

Finding useful features in the dataset. The graph depicts the relationship between model size (governed by the sparsity parameter, and plotted on the x-axis) and the fit of model (assessed by the deviance measure, and plotted on the y-axis) to validation data.
The number of features retained by model is completely determined by the sparsity parameter and is shown in the top row above the plot.

54

#RSAC
Overall model performance
Test set performance of structural entropy classifier on a set of 7,916 newly seen files.
55

Contribution of model-based features

#RSAC

Test set performance (n=7,916) of classifiers using various subsets of the model-based entropy features
56

Contribution of model-based features

#RSAC

Feature Importance Plot: Blue, purple, and cyan are prominent throughout the display, which reflects that the model-based features are quite substantially involved in the overall predictive performance of the automated malware classifier.

57

Wavelet Energy Patterns: A "Danger Map"

#RSAC

The plot shows logistic regression beta coefficients for determining the probability that a portable executable file is malware based upon the magnitude of file's entropic energy at various levels of resolution within the code.
 Positive betas mean that higher "entropic energy" at that resolution level is associated with a greater probability of being malware.
 Negative betas (mean that higher "entropic energy" at that resolution level is associated with a lower probability of being malware.

58

#RSAC
Discussion

#RSAC
Take Home Points
 Machine learning automatic malware classification systems could benefit from incorporating "structural entropy" features.
 We extracted structural entropy features via three primary techniques: detrended fluctuation analysis, mean change point modeling, and wavelet decompositions.
 These features, especially considered in tandem, allow for the structural entropy classifier to construct a fairly complex relationship between machine code and a judgment of "entropic suspiciousness."
 This relationship would be much harder for an adversary to control than, say, mean entropy levels.
 Moreover, the strong predictive performance of these structural entropy features suggest that they may be a powerful contributor to a larger machine learning system for automatically classifying malware.
60

Questions and Answers

#RSAC

Contacts:  Mike Wojnowicz mwojnowicz@cylance.com
 Glenn Chisholm gchisholm@cylance.com

61

