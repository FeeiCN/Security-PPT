Graphic Content Ahead:! Towards Automated Scalable Analysis of Graphical Images Embedded In Malware
Alex Long, Joshua Saxe, Robert Gove

Invincea Labs
8/5/2015

Talk Outline

1. The Status Quo of Malware Analysis 2. Hard Problems The Industry is Dealing With

3. Our Approach 4. Two Research Experiments

1. Detecting and Visualizing ImageSharing Relationships (Live Demo)

2. Automatically Classifying Images by Their Semantics

2

Status Quo of Malware Analysis
Malware analysis treats malware as just a set of instructions
Analysis typically consists of analyzing the disassembled code and/or observing the malware's runtime behavior
3

Problems Facing Analysts Today
Malware could be packed or use VM detection tactics
Manual analysis of each sample is intractable given huge numbers of polymorphic variants
4

Expanding the Frame
Malware is not just code,! it's also
 natural language !  documents !  audio !  video!  images

"CLICK HERE FOR FREE PICS"
5

The Setting

 Problem: Graphical assets are an untapped resource in the malware analysis space; image analysis done manually.!

Of a collection of 2 million malware samples provided
to us by DARPA,! over half had at least one
image embedded.

samples without parseable images

samples with parseable images

0

200

400

600

800

number of samples

(in hundreds of thousands)

No images 1 to 10 images 11 to 20 images More than 20 images

6

How Image Analysis is Useful
A packed Trojan still needs an attractive icon to lure a user into executing it

Images can hint at the ways in which attackers are tricking the user and the purpose of a binary artifact.
Game-related

By exploring the malware's "social network" through shared rare images, you can learn about an otherwise hard-to-reverse sample.
Trojan.Win32.VBKrypt...
Trojan.Win32.Swizzor... 7

What Automation Makes Possible
Survey of the threat landscape
We're seeing an up-tick in malware masquerading as PDFs, let's alert our employees to be on the lookout
!
Quick analysis of new samples
Our system has found a previously analyzed sample that shares an image with this email attachment
8

Why Not Just Compare Hashes?

Images go on a wild ride

and tbhyeythme itgimhtelothoekyaelnitdtleudpififnermenatlware,

Hash comparison will fail if the image was!
compressed! copied and pasted! modified deliberately

Average Hash
1. Take an image
10

Average Hash
1. Take an image 2. Reduce to grayscale
11

Average Hash
1. Take an image 2. Reduce to grayscale 3. Stretch/shrink to 32x32
12

Average Hash

1. Take an image

2. Reduce to grayscale

3. Stretch/shrink to 32x32

4. Convert to high contrast

a. Get average value of pixels

b. For each pixel,

if above average, set to 255

!

if below average, set to 0

13

Average Hash

1. Take an image

2. Reduce to grayscale

3. Stretch/shrink to 32x32

4. Convert to binary vector

a. Get average value of pixels

b. For each pixel,

if above average, set to 255

!

if below average, set to 0

14

Average Hash
15

Statistics Refresher

Precision: ! What percent of the pairs matched by the
system actually had similar images?

Precision

Image Matcher Results

Recall:! What percent of all matching pairs did
the system find?

Recall

Image Matcher Results

Matching Pairs

NonMatching
Pairs

Matching Pairs

NonMatching
Pairs

False positives! Our system says a pair of images are similar that actually are different

False negatives! Our system fails to say a pair of images
are similar when they actually are
16

Average Hash vs MD5

Score

1.0 0.8 0.5 0.3 0.0
0.0
1.0 0.8 0.5 0.3 0.0
0.0

Score with Average Hash

precision f1-score recall

0.2

0.5

0.7

0.9

Decision Threshold

Score with MD5 Hash

precision
f1-score recall

0.2

0.5

0.7

0.9

Decision Threshold

 200 hand clustered samples!
!
 MD5 wins out in precision!
!
 Average hash wins in recall!
!
 Humans can easily detect and ignore images that don't match (false positives)!
!
 False negatives invisible to user and lost forever
 We'd prefer to have more false positives (lower precision) in order to have fewer false negatives (higher recall)
17

Score

Comparing Sets of Images

=

?

18

Comparing Sets of Images

Sample A

Sample B

=

?

19

Comparing Sets of Images

Sample A

Sample B

Number of matching pairs (2) Number of possible matching pairs (3)

= 0.66 similarity

20

Demo!
Live Demo
21

Automatic Classification of Images

Browser Anti-virus
Document

톀eveal purpose of malware
톁urvey threat landscape
텮ssign risk factor
22

Square feet

6,000 3,000
0

Machine Learning 101: ! K Nearest Neighbors

e.g. K = 3
10 Number of rooms

K Nearest Neighbors 1. Plot points on graph 2. Assign classes to points (e.g.
house or apartment) 3. Plot point on graph with
unknown class 4. Pick a number K as
appropriate for your data 5. Get the top-K nearest
neighbors (AKA closest points) to the point with the unknown class 6. Classify by majority vote  (e.g. if the 3 nearest points are 2 houses and 1 apartment, unknown class is house)
20
23

Classification by Color Histogram

Image with unknown class

Predicted class

K Nearest Neighbors

24

Conclusion
Graphical content of malware is a significantly under-utilized signal in malware analysis!
!
Automation and visualization make this "human" signal accessible at a large scale
Alex Long! ! alex.long@invincea.com! 25

