Identifying Novel Malware at Scale
Pedram Amini | InQuest.net

Who I be.
New York City native. Austin Texas since 2005.
Self taught in the 90's through SoftICE & phreaking. iDEFENSE VCP 2002-2005, TippingPoint ZDI 2005-2010. OpenRCE.org, PaiMei, Sulley, Fuzzing (book). Jumpshot 2010-2014, InQuest 2014+. Threat hunting/intelligence and automation.

 Low Hanging Fruit 
There are some beautiful exploits out there... But how are people getting owned?
 Invoice scams.  Phishing.  Open S3 buckets and Elastic databases.  Carrier lures...

A Formula for Success
1. Construct novel carrier(s). Exploit(s) optional.
 2. Own, pwn, or utilize shared hosting in the . . 3. Seed via some SPAM and...



2018
[O] CVE-2012-0158 [A] CVE-2015-1805 [I] CVE-2016-0189 [O] CVE-2017-0199 [O] CVE-2017-11882 [O] CVE-2017-8570 [O] CVE-2017-8750 [F] CVE-2018-4878 [I] CVE-2018-8174 [I] CVE-2018-8373

2019
[O] CVE-2012-0158 [O] CVE-2015-1641 [O] CVE-2017-0143 [O] CVE-2017-0199 [O] CVE-2017-11882 [O] CVE-2017-5638 [O] CVE-2017-8759 [F] CVE-2018-4878 [O] CVE-2018-7600 [O] CVE-2019-0604

2020
[J] CVE-2012-4681 [W] CVE-2014-6352 [W] CVE-2016-7255 [O] CVE-2016-7262 [O] CVE-2017-0199 [O] CVE-2017-11882 [P] CVE-2018-4893 [I] CVE-2019-1367 [W] CVE-2019-1405 [W] CVE-2020-0601

Adobe [F]lash / [P]DF | Google [A]ndroid | Oracle [J]ava | Microsoft [I]E / [O]ffice / [W]indows

Microsoft Excel Macrosheets
There's *always* something with Microsoft Office. Tens of millions of lines of code, decades of features. Deep dive into the breaking wave of XLM carriers:
 2019-01-29: Extracting "Sneaky" Excel XLM Macros  2020-03-18: Getting Sneakier: Hidden Sheets & Data Connections  2020-05-06: ZLoader 4.0 Macrosheets Evolution
Tool: XLMMacroDeobfuscator YARA Rules: Github/InQuest

More on #maldoc's

Didier Stevens, NVISO Maldocs Tips for Red Teamers @didierstevens blog

(D) = Disclosure

Common Malware Campaign

Common Malware Campaign

Common Malware Campaign

Common Malware Campaign

Infrastructure Pivots
Domain -> IP -> Domain(s) Domain -> DNS -> Domain(s) Domain -> Pattern -> Domain(s) Domain -> Registrant -> Domain(s) Domain -> Sub Domains(s) IP -> ASN -> IP(s) SSL Certificates Google Analytics IDs ...and more...

Infrastructure Pivots
Domain -> IP -> Domain(s) Domain -> DNS -> Domain(s) Domain -> Pattern -> Domain(s) Domain -> Registrant -> Domain(s) Domain -> Sub Domains(s) IP -> ASN -> IP(s) SSL Certificates Google Analytics IDs ...and more...

File Pivots
IP Address Domain Name URL Email Address File Name / Pattern Adobe XMP ID AV Labels Graphical Lure ...

File Pivots
IP Address Domain Name
URL Email Address File Name / Pattern
Adobe XMP ID AV Labels
Graphical Lure ...

Pivoting on XMP IDs
Adobe Extensible Metadata Platform (XMP). Defines a standard of mapping asset relationships.
XML parent-to-child and revision tracking.
Original (OID), Document (DID), and Instance (IID). Data updated on save/copy and embedded within the asset.
reference: http://wwwimages.adobe.com/content/dam/acom/en/products/xmp/Pdfs/XMPAssetRelationships.pdf

XMP ID Family Trees

XMP OID: deadbeef... XMP DID: deadbeef... XMP IID: c0cac01a...

XMP OID: deadbeef... XMP DID: cafebabe... XMP IID: ca55e77e...

XMP OID: cafebabe... XMP DID: b01dface... XMP IID: f01dab1e...

XMP OID: deadbeef...

XMP OID: deadbeef...

XMP DID: deadbeef...

XMP DID: cafebabe...

...

XMP IID: ba5eba11...

XMP IID: f005ba11...

XMP OID: deadbeef... XMP DID: deadbeef... XMP IID: ca55e77e...

Two XMP ID formats: MD5 hash (32 bytes) and GUID (36 bytes)

reference: http://wwwimages.adobe.com/content/dam/acom/en/products/xmp/Pdfs/XMPAssetRelationships.pdf

VTI: Daily Uploads
~1.3M total < ~1M distinct < ~900k new < ~400k malicious

VTI: File Distribution
~1M PDF < ~50k Office < ~20k Java < ~15k Excel...

 Reducing the Volume 
 https://github.com/InQuest/yara-rules  Layered carriers, Matryoshka:  Evasive characteristics.  ~5k samples a day, <1%.  Clustering...

 Burning Your Warez 
 MIME evasions ... "{\rt" vs "{\rtf1" ... "%PDF" not at 0.  Burning your 0day via symbols:
"shellcode", "exploit", "heapspray", etc.  UTF-8 Byte Order Mark (BOM), 0xEFBBBF, from 2013!  Chaff...

 Burning Your Warez 
 MIME evasions ... "{\rt" vs "{\rtf1" ... "%PDF" not at 0.  Burning your 0day via symbols:
"shellcode", "exploit", "heapspray", etc.  UTF-8 Byte Order Mark (BOM), 0xEFBBBF, from 2013!  Chaff.  RTF Byte-Nibble, utilized by CVE-2018-8174 ITW 0day...

 Feature Selection 
Data -> Features -> Algorithm(s) ML models are primarily driven by the features you select. The tunables per algorithm, can be "fuzzed" via grid search. Our feature vector contains ~150 data points. Split 75/25 between "visual" and semantic.

 BoW and TF/IDF 
Given a corpus of text, find all the unique tokens, jumble them together. Rank the words by Term Frequency / Inverse Document Frequency (TF/IDF). In other words, times the term is seen in a document vs all documents. This text mining process can identify unique anchors for filtering.

Clustering
Inputs: Raw Macro and Feature Vector Macro -> Bag-of-Words (BoW) -> TF/IDF
Macro hashing w/ SSDeep and TLSH. K-Means (BoW and Features). DBSCAN / OPTICS (BoW and Features).

 Fuzzy Hashes #
Context Triggered Piecewise Hash (CTPH), aka "fuzzy hashes". SSDeep, the ubiquitous option and it's SQL query-able! Trend Micro Locality Sensitive Hash (TLSH), the newer option, gaining traction, included in STIX v2.1. Input is raw macro. Distance between samples is calculated.
 You must choose a threshold for clustering.

K-Means Clustering
1. Randomly choose dummy points, measure distance from dummy
point to every other point.
2. Move the dummy points towards a denser area. 3. Repeat the process until improvements can not be made.
 You must choose the number of clusters.

K-Means Clustering

K-Means Clustering

K-Means Clustering

K-Means Clustering

K-Means Clustering

DBSCAN / OPTICS
Density-Based Spatial Clustering of Applications with Noise (DBSCAN) Ordering Points To Identify the Clustering Structure (OPTICS) Uniform density-> DBSCAN, Varying density -> OPTICS.
1. For each point, determine which other points live within epsilon
distance.
2. If that number of points > min_points, then it's a "core point".
Otherwise, it's an "edge point".
3. Points without neighbors are "noise".
 You must choose your epsilon and min_points threshold.

DBSCAN / OPTICS

1

3

2

4

DBSCAN / OPTICS

5

7

6

8

DBSCAN / OPTICS

9

11

10

12

Clustering Results

Method
SSDeep TLSH K-Means-TFIDF K-Means-Features DBSCAN-TFIDF DBSCAN-Features OPTICS-TFIDF OPTICS-Features Total / Unique

+Malicious
917 478 238 285 795
349 390 1789

+Benign
161 102
2 3 4 12 22 95

Contribution
10.78% 5.8% 2.4%
2.88% 7.99%
3.61% 4.12% 18.84%

Corpus consists of 10,000 unique (macro hash) carrier documents, ~20% labeled.

 Looking for Outliers 
1. Discard the clusters. 2. Dynamic analysis, especially on bare metal. 3. Manual analysis with a focus on the suspect but undetected.
Identify an anchor and RetroHunt to expand the sample set. 's include: constant, asset, metadata, network header, etc.

labs.inquest.net

 Explore common carriers.  ~1M files in corpus.
 YARA helpers.  mIXeD HeX CaSe  uint() "triggers"  base64 regex generator

 Reputation aggregation  ~25 open sources
 IOC aggregration  Twitter, RSS, Github...
 Open API  Cluster data impending...

Get in touch.

pedram@inquest.net

@pedramamini
@InQuest

