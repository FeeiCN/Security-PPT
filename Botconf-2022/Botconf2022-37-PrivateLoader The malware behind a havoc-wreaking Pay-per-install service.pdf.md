PrivateLoader
The malware behind a havoc-wreaking Pay-per-install service
Souhail Hammou Malware Reverse Engineer

Agenda
 Introduction to Pay-per-install (PPI) services  Discovering PrivateLoader  In-depth look at PrivateLoader  Tracking PrivateLoader  Conclusion

 2022 Intel 471 2

Introduction to underground PPI services
 PPI services monetize wide distribution of malware and PUAs.  Providers offer geo-targeted installs (aka loads) in exchange for money.  A malware operator purchases a number of installs and the service works to
guarantee the same number of infected bots.  Used mainly by low to mid-tier actors to distribute downloaders and
information stealers.
 2022 Intel 471 3

Introduction to underground PPI services
 There exist public and private PPI services. Underground forums host ads for such services and provide escrow.
 2022 Intel 471 4

Custom loaders of PPI services
 Most PPI services use custom loaders for payload delivery.  Methods of distribution deliver the custom loader to victims.  The loader connects to a C2 server to retrieve the payloads to install.  The loader communicates information back to confirm the installs as proof.  An infected bot can be re-used multiple times. This creates a clutter of
malware on victim machines (tens to hundreds of malicious payloads).
 2022 Intel 471 5

A typical PPI transaction
 Malware operators provide:  Payment in cryptocurrency.  Malicious payloads to distribute.  Number of installs.  Geo-targeting preferences e.g. EU, Mixed geo etc.
 PPI Service operators provide:  Payload distribution: Bot masters, affiliates, PPI etc.  Payload delivery to infected hosts.

 2022 Intel 471 6

Methods of distribution
 Bot masters:  Monetize their large botnets by using infected bots for PPI installs.  Bot masters offer PPI services for direct payload delivery in underground forums.
 Affiliate programs:  PPI services can outsource malware delivery to affiliates.  Affiliates get paid to distribute a custom PPI loader.  The sky's the limit with delivery methods: phishing, bundleware etc.
 Other PPI services:  A PPI service can deliver its custom loader using better PPI services.  Example: GCleaner using PrivateLoader for delivery.
 2022 Intel 471 7

PrivateLoader
 Intel 471 became aware of PrivateLoader in late July 2021. We believe it has been active since at least May 2021.
 Private PPI service: service and operators are unknown.  The variety and large amount of payloads it was dropping in a single run caught our
attention.  Programmed in C++, uses HTTP for C2 communication and is actively maintained. In
early August 2021 it underwent changes to become modular.
 2022 Intel 471 8

Distribution method
 Network of malicious websites of fake cracked software.  SEO optimized.  "Download Crack" button is retrieved from a remote server.  User is redirected to download password-protected archive.  Researchers from SophosLabs tied some of the infrastructure to an affiliate PPI service called
InstallUSD. Affiliates host download links on websites and get paid for installs.  Main distribution method.
 2022 Intel 471 9

Life cycle of a PrivateLoader infection
 2022 Intel 471 10

Loader module
 The first stage payload in a PrivateLoader infection.  Contains multiple loader C2s used to retrieve the main C2 configuration.  The loader module includes multiple URLs that are requested (GET request):
 /proxies.txt  /server.txt  /api/setStats.php  The resulting responses can contain an encoded, encrypted or plaintext main C2 configuration.  HOST:45.133.1.60
 2022 Intel 471 11

Loader module: Example of /proxies.txt
 Example: hxxp://45.133.1[.]182/proxies.txt  The response is a multiline text file with an IP
address and a port in each line.  The main C2 IP address is always encoded in line
119 of this file.  The port is discarded and the IP is rearranged.  1.45.60.133 becomes 45.133.1.60.

Excerpt with line numbers
 2022 Intel 471 12

Loader module: Downloading the core module
 Loader uses the main C2 address to query this URL:  Example: hxxp://45.133.1[.]60/base/api/statistics.php
 The response is encrypted with a 1-byte XOR key hardcoded in the sample.  The decrypted response is a download config for the encrypted core module.
Frequently stored on the Discord CDN.
 2022 Intel 471 13

Loader module: Executing the core module
 Decrypts and reflectively loads the core module DLL.  Builds a parameter buffer that it supplies to the core module's entrypoint.

Buffer offset 0x00 0x04 0x05 0x120

Argument
Region code integer hardcoded into the loader module e.g. 2
Termination byte set to 1 by the core module before it terminates The main C2 host
Unknown integer as a string

Size 4 bytes 1 byte variable variable

 2022 Intel 471 14

Core module

 Uses Windows 10 UAC bypass to elevate privileges. Relies on widely documented technique involving ComputerDefaults.exe
 Disables Windows Defender by writing to the registry.

Registry key

Values

HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows - DisableAntiSpyware

Defender

- DisableRoutinelyTakingAction

HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection

- DisableBehaviorMonitoring - DisableOnAccessProtection - DisableScanOnRealtimeEnable - DisableRealtimeMonitoring - DisableIOAVProtection - DisableRawWriteNotification

 2022 Intel 471 15

Core module: Region code
 Reads its configuration from the parameter buffer passed by the loader module.
 The region code integer is mapped to a string using a conversion table.
 Frequently updated. 32 region codes in current samples.

 2022 Intel 471 16

Core module: Region code
 Since this region code is hardcoded in the loader, we believe that the proper samples are funneled to targeted geo-locations by the delivery network distributing PrivateLoader.
 Region code defines which payloads to deliver to bots.

 2022 Intel 471 17

Core module: Target fingerprinting
 Searches for cryptocurrency wallet software and browser login data for multiple websites related to banking, cryptocurrency and e-commerce.
 Searches are grouped by category each with specific targets e.g. cold wallets, browser wallets, banking websites etc.

 2022 Intel 471 18

Core module: Target fingerprinting
 When a target in a category identified, the category is marked as present.
 Operators can set an option to serve payloads only when a target for a certain category was identified on the infected host.

 2022 Intel 471 19

Core module: Communication protocol
 Communication is done using HTTP POST requests.  Endpoint: /base/api/getData.php
 Relies on a more robust algorithm to encrypt request and response messages.  PBKDF2-SHA512 + AES-256 CBC + HMAC-SHA256.  The password used in PBKDF2 is: Snowman+under_a_sn0wdrift_forgot_the_Snow_Maiden  PBKDF2 is used to generate AES-256 and HMAC keys.
 Resulting packet is base64 encoded.
 2022 Intel 471 20

Core module: Retrieving payloads
 PrivateLoader supports deployment of:  Windows .EXE executables.  Browser extensions on most Chromium browsers silently.
 Request messages to retrieve the download URLs:  GetExtensions|{REGION_CODE}|{BOT_COUNTRY}|10  GetLinks|{REGION_CODE}|{BOT_COUNTRY}|10
 2022 Intel 471 21

Core module: Executable payloads
 Example request to get loader links  GetLinks|WW_8|US|10
 Example response:

 2022 Intel 471 22

Core module: PPI logs
 The core module must relay information regarding installed payloads back to the C2.
 AddLoggerStat|{"extensions":[],"links":[{"id":"-1"},{"id":"11"}],"net_country_c ode":"US","os_country_code":"US"}
 2022 Intel 471 23

Service module
 Ensures persistence:  Persisted to run at logon:  Windows service.  Scheduled task.  Runs every hour thanks to a scheduled task.  C:\Program Files (x86)\PowerControl\PowerControl_Svc.exe
 Communicates with the main C2:  /service/communication.php
 Updates itself.  Receives a download URL to execute a loader module.

 2022 Intel 471 24

Tracking PrivateLoader
 Intel 471 started tracking PrivateLoader in early September 2021.  Automate the whole life-cycle of an infection for each sample.
 From a loader component to getting installs.  Replicate using config extractors + network protocol emulation.  Create bots from various countries.  Passive bots to avoid raising alarms.  Classify as many malware families as we can.
 2022 Intel 471 25

Tracking PrivateLoader

 2022 Intel 471 26

Tracking PrivateLoader: Bot stats
 2022 Intel 471 27

Tracking PrivateLoader: Bot stats
 2022 Intel 471 28

Tracking PrivateLoader: Malware families
 2022 Intel 471 29

Tracking PrivateLoader: Banking Trojans
 On Oct. 22, 2021, a Smokeloader sample delivered the Qbot banking trojan. Revealed the new botnet ID star01.
 On Oct. 31. PrivateLoader dropping:  Kronos.
 On Nov. 1. Privateloader dropping:  Danabot: affiliate ID 40.  Dridex: 10444 botnet.  Trickbot: lip*, tot*, top* gtags.
 Danabot, Dridex and Trickbot were often bundled together.

 2022 Intel 471 30

Tracking PrivateLoader: Banking Trojans
 On Nov. 14, started dropping Danabot with affiliate ID 4 for a day.
 Starting late February 2022, new version of the Danabot banking trojan pushed by affiliate ID 5.

 2022 Intel 471 31

Tracking PrivateLoader: Ransomware
 PPI services advise against deploying ransomware.  Ransomware seen from PrivateLoader:
 Lockbit  STOP Djvu

 2022 Intel 471 32

Tracking PrivateLoader: Some new families
 RisePro stealer  Information stealer in C++ appeared in December 2021.  From the same developers of Privateloader.  Download and execute functionality: miners.
 Discoloader  .NET loader  Hosts payload on the Discord CDN

 2022 Intel 471 33

Conclusion
 PPI services have been around for a long time.  Accessible and affordable to offload malware delivery.  PPI services often overlooked when it comes to installed payloads.  Privateloader as an example.
 2022 Intel 471 34

Thank you !
Contact: shammou@intel471.com Website: www.intel471.com Twitter: @Dark_Puzzle

 2022 Intel 471 35

