Qbot Code Evolution
Deep Malware Analysis and Intelligence

COPYRI GH T © TH REATRAY 2022

1

Who are we?

COPYRI GH T © TH REATRAY 2022

2

Carlos Rubio Ricote
Malware reverse engineer
Currently at: Threatray Formerly: Blueliv, S21sec, Panda Security...
Blog: http://reversingminds-blog.logdown.com/

COPYRI GH T © TH REATRAY 2022

3

Markel Picado Ortiz (d00rt)
Malware reverse engineer
Currently at: Threatray Formerly: Sophos, Hatching (tria.ge), Panda Security, S21Sec...
Twitter: @D00RT_RM Github: https://github.com/d00rt Blog: https://d00rt.blogspot.com/

COPYRI GH T © TH REATRAY 2022

4

Intro

COPYRI GH T © TH REATRAY 2022

5

Index

COPYRI GH T © TH REATRAY 2022

6

Table of contents
· Brief introduction to Qbot · Technical summary of Qbot · Qbot code evolution · Converting metadata into insights · Conclusion

COPYRI GH T © TH REATRAY 2022

7

What is Qbot?
· Historically known as a banking trojan / credential harvester · Active since 2007 · Modular framework · Currently one of the most prevalent malware (Distributed by TA551,
TA570, TA571, TA577...) · Continuous development

COPYRI GH T © TH REATRAY 2022

8

Qbot Version Timeline (2013-2022)

COPYRI GH T © TH REATRAY 2022

9

What is Qbot?
(tech view)

COPYRI GH T © TH REATRAY 2022

10

· Historically composed by 2 elements - STAGER (exe) - MAIN DLL (dll)
· MAIN DLL is embedded into stager's resources
· STAGER goals - Installation - Persistence - Main DLL injection

Qbot STAGER (EXE)

Qbot MAIN/HOOK (DLL)

RESOURCES

COPYRI GH T © TH REATRAY 2022

11

· MAIN DLL also has artifacts in its resources - CC config - Script for malware updates - Antisession Webinjects
· MAIN DLL goals - Network traffic interception - Steal creadentials - Lateral movements - Run commands periodically - Handle received commands from the CC

Qbot STAGER (EXE)

Qbot MAIN/HOOK (DLL)

RESOURCES

RESOURCES

CCC script webinj

COPYRI GH T © TH REATRAY 2022

12

Qbot code evolution
2013-2022

COPYRI GH T © TH REATRAY 2022

13

Disclaimer
· Based in our telemetry
· Missing changes
· We are not covering all changes in this talk
· Time · Whitepaper / Blog · Transformation to more advanced and modular malware

COPYRI GH T © TH REATRAY 2022

14

Qbot STAGER (EXE)

Qbot MAIN/HOOK (DLL)

Version: 201.X

Qbot STAGER (EXE)

Qbot MAIN (DLL)

~ Jun 2013

Qbot HOOK x86 (DLL)

Qbot HOOK x64 (DLL)

Version: >300.549

Qbot STAGER (EXE)

Qbot MAIN (DLL)

Version: >324.X

~ Feb 2017

Qbot STAGER + MAIN Version: >401.X (DLL)

~ Jan 2020

~ Nov 2020

~ Release date

COPYRI GH T © TH REATRAY 2022

15

Qbot version:
201.X
~Jun 2013

COPYRI GH T © TH REATRAY 2022

16

Qbot STAGER (EXE)

Qbot MAIN (DLL)

WebInjects Script CC Config

QBOT ARTIFACTS 201.X

RESOURCES TABLE RES_BUTTON_3

RESOURCES TABLE RES_BUTTON_1 RES_BUTTON_2 RES_BUTTON_4

COPYRI GH T © TH REATRAY 2022

17

InitCoreData detect VM

QbotInstalled?

NO
enum all users

user available?

YES

NO

get user

install create persistence execute installed sample

YES
install it as service
create injection thread
listen message loop
get message
TERMINATE

terminate process

QBOT STAGER 201.X

get main dll from resources
list all running processes

injection thread

remaining processes?

YES

NO

main dll injection

Signal events for all injected
processes

ctrl event created?

NO

YES

TIMEOUT

create iexplorer

stop thread?
NO
YES
end thread

COPYRI GH T © TH REATRAY 2022

18

init core data suspend Trusteer RapportGP (IBM)
suspend all threads hook ResumeThread

msddbemgvvi.oreieclxl.wyceedt.xfebmexgoe.enx.eexe

check protected exe

YES

NO

global initializations hook the rest of
the API

is injected in target
process?

resume all threads

NO

YES

iexplore.exe outlook.exe firefox.exe opera.exe skype.exe msnmsgr.exe yahoomesseng er.exe msmsgs.exe wscntfy.exe wuauclt.exe

create qbot main thread

create ctrl events

QBOT MAIN DLL 201.X

init ctrl events sync stager CCinit IESessPipeServerInit (thread) CheckStartupKey (thread) add cron events

main thread

stop qbot DLL?

YES

NO

uninitalizations

get all cron events

remaining event?
NO YES
reached time?
NO YES
process event

sleep

CRON EVENTS cc_main
getip nbscan ckkill uploaddata instwd nattun

COPYRI GH T © TH REATRAY 2022

19

Qbot version:
300.X
~Nov 2015
- Main DLL Execution mode

COPYRI GH T © TH REATRAY 2022

20

InitCoreData detect VM detect AV

QbotInstalled?

=LOW
try to run itself with higher integrity level

>LOW

process integrity level?

enum all users

NO

YES

IsUserNTSystem?

YES

NO

CopyToTemp Run new copy

RunMeInTrusted Exe

user available?

YES

NO

get user

terminate process

install create persistence execute installed sample

QBOT STAGER 300.35

COPYRI GH T © TH REATRAY 2022

21

Run explorer.exe Self injection

install it as service
create injection thread
load MAIN DLL (cc mode)
listen message loop
get message
TERMINATE
terminate process

get MAIN DLL from resources
encrypt dll in mem

QBOT STAGER 300.35 RunMeInTrustedExe
injection thread

list all running processes

remaining processes?

YES

NO

decrypt dll in mem
MAIN DLL injection (hook mode)
encrypt dll in mem

NO TIMEOUT

Signal events for all injected
processes
ctrl event created?
YES

create iexplorer

stop thread?
NO

YES
end thread

COPYRI GH T © TH REATRAY 2022

22

Run explorer.exe Self injection

install it as service
create injection thread
load MAIN DLL (cc mode)
listen message loop
get message
TERMINATE
terminate process

get MAIN DLL from resources
encrypt dll in mem

QBOT STAGER 300.35 RunMeInTrustedExe
injection thread

list all running processes

remaining processes?

YES

NO

decrypt dll in mem
MAIN DLL injection (hook mode)
encrypt dll in mem

NO TIMEOUT

Signal events for all injected
processes
ctrl event created?
YES

create iexplorer

stop thread?
NO

YES
end thread

COPYRI GH T © TH REATRAY 2022

23

decrypt strings init core data
execution mode?

HOOK
check protected exe

YES

NO

CC HANDLER

global initializations hook the rest of the API
suspend Trusteer RapportGP (IBM) suspend all threads hook ResumeThread

resume all threads

create qbot main thread

create ctrl events

QBOT MAIN DLL 300.35

init ctrl events sync STAGER CCinit IESessPipeServerInit (thread) CheckStartupKey (thread) add cron events

main thread

stop qbot dll?

YES

NO

uninitalizations

get all cron events

remaining event?
NO YES
reached time?
NO YES
process event

sleep

CRON EVENTS cc_main
getip nbscan ckkill uploaddata instwd nattun

COPYRI GH T © TH REATRAY 2022

24

QBOT 200.X

MAIN DLL Execution mode

QBOT 300.X

COPYRI GH T © TH REATRAY 2022

25

Qbot version:
300.257
~April 2016
- CC List

COPYRI GH T © TH REATRAY 2022

26

Qbot STAGER (EXE)
RESOURCES TABLE IDB_BITMAP1

Qbot MAIN (DLL)
RESOURCES TABLE IDB_BITMAP3 IDB_BITMAP4 IDB_BITMAP2
IDB_BITMAP5

WebInjects Script CC Config CC Server list

QBOT ARTIFACTS 300.257

COPYRI GH T © TH REATRAY 2022

27

decrypt strings init core data
execution mode?

HOOK
check protected exe

YES

NO

CC HANDLER

global initializations hook the rest of the API
suspend Trusteer RapportGP (IBM) suspend all threads hook ResumeThread

resume all threads

create qbot main thread

create ctrl events

QBOT MAIN DLL 300.257

init ctrl events sync stager CCinit IESessPipeServerInit (thread) CheckStartupKey (thread) add cron events

main thread

stop qbot dll?

YES

NO

uninitalizations

get all cron events

remaining event?
NO YES
reached time?
NO YES
process event

sleep

CRON EVENTS cc_main
getip nbscan ckkill uploaddata instwd nattun ExtIpCheck grab_saved_i
nfo

COPYRI GH T © TH REATRAY 2022

28

STAGER · run_as_exe_installer modified
QBOT >300.X

QBOT >300.257

COPYRI GH T © TH REATRAY 2022

29

QBOT >300.X

· MAIN DLL - Added the DGA as secondary option if it can not obtain the CC list from its resources
QBOT >300.257

COPYRI GH T © TH REATRAY 2022

30

Qbot version:
300.549
~Feb 2017
Plugin support

COPYRI GH T © TH REATRAY 2022

31

Qbot STAGER (EXE)
RESOURCES TABLE IDB_BITMAP10 IDB_BITMAP11 IDB_BITMAP12

Qbot MAIN (DLL)

Script CC Config
CC Server list
Qbot HOOK x86 (DLL)

RESOURCES TABLE IDB_BITMAP4 IDB_BITMAP2 IDB_BITMAP5

RESOURCES TABLE IDB_BITMAP3

QBOT ARTIFACTS 300.549

Webinj
Qbot HOOK x64 (DLL)

Webinj

RESOURCES TABLE IDB_BITMAP3

COPYRI GH T © TH REATRAY 2022

32

Run from explorer.exe or iexplorer.exe

install it as service
create injection thread
load MAIN DLL

listen message loop
get message

TERMINATE
terminate process

get main dll from resources
encrypt dll in mem
list all running processes

injection thread

remaining processes?

YES

NO

select HOOK DLL version
decrypt dll in mem
hook dll injection

Signal events for all injected
processes

ctrl event created?

NO

YES

encrypt dll in mem

TIMEOUT

create iexplorer

stop thread?
NO YES
end thread

QBOT STAGER 300.549 RunMeInTrustedExe

COPYRI GH T © TH REATRAY 2022

33

init core data
create qbot main thread
create ctrl events

init ctrl events sync stager CCinit IESessPipeServerInit (thread) CheckStartupKey (thread) add cron events StartAllPlugins

main thread

stop qbot dll?

YES

NO

uninitalizations

get all cron events

remaining event?
NO YES
reached time?
NO YES
process event

sleep

QBOT MAIN DLL 300.549

CRON EVENTS cc_main
getip nbscan
ckkill uploaddata
instwd nattun ExtIpCheck grab_saved_i
nfo

COPYRI GH T © TH REATRAY 2022

34

QBOT HOOK DLL 300.549

windbg.exe ChromeUpdate.exe msdev.exe dbgview.exe ollydbg.exe ctfmon.exe Proxifier.exe nav.exe

init core data

check protected exe

YES

NO

global initializations install hooks
suspend Trusteer RapportGP (IBM)
resume all threads

COPYRI GH T © TH REATRAY 2022

35

MAIN DLL · Plugin support

COPYRI GH T © TH REATRAY 2022

36

MAIN DLL · The fields in the config are renamed to numbers to hide their meaning · This is applied not only to the fields in the hardcoded config but also to any field in the
config

QBOT >300.257

QBOT >300.549

COPYRI GH T © TH REATRAY 2022

37

Qbot version:
324.X
~Jan 2020

COPYRI GH T © TH REATRAY 2022

38

Qbot STAGER (EXE)
RESOURCES TABLE 307

Qbot MAIN (DLL)

Script CC Config
CC Server list
Qbot HOOK x86 (DLL)

RESOURCES TABLE 310 308 311

RESOURCES TABLE 9

QBOT ARTIFACTS 324.X

Webinj
Qbot HOOK x64 (DLL)

Webinj

RESOURCES TABLE 9

COPYRI GH T © TH REATRAY 2022

39

QBOT STAGER 324.X

InitCoreData detect VM detect AV

check if it is running from installation path

=LOW

>LOW

process integrity level?

NO

YES

IsUserNTSystem?

try to run itself with higher integrity level

enum all users

YES
CopyToTemp Run new copy

NO

AV Detected

NO

YES

user available?

YES

NO

get user

terminate process

install create persistence execute installed sample

RunMeInTrusted Exe2

SUCCESS

FAIL

StartQbotThread listen message loop
get message

TERMINATE

COPYRI GH T © TH REATRAY 2022

40

QBOT >300.257

MAIN DLL · Managed the webinjects as Plugin
QBOT >324.X

crc32("plugin_hook") ==
0x2deb8b96

COPYRI GH T © TH REATRAY 2022

41

Qbot version:
401.X
~Nov 2020

COPYRI GH T © TH REATRAY 2022

42

Qbot STAGER (EXE)

Qbot MAIN (DLL)

CC Config CC Server list

RESOURCES TABLE 307

RESOURCES TABLE 308 311

QBOT ARTIFACTS 401.X

COPYRI GH T © TH REATRAY 2022

43

· Current Major version 403
· From version >=401
- They have join in same binary the STAGER and the MAIN DLL - This new binary is a DLL which does the persistence and communication with the C2 - All previous functionalities has been moved to Plugins
+ Webinjects + Password grabber + Proxy + Hidden VNC + ...

COPYRI GH T © TH REATRAY 2022

44

Qbot STAGER (EXE)

Qbot MAIN/HOOK (DLL)

Version: 201.X

Qbot STAGER (EXE)

Qbot MAIN (DLL)

~ Jun 2013

Qbot HOOK x86 (DLL)

Qbot HOOK x64 (DLL)

Version: >300.549

Qbot STAGER (EXE)

Qbot MAIN (DLL)

Version: >324.X

~ Feb 2017

Qbot STAGER + MAIN Version: >401.X (DLL)

~ Jan 2020

~ Nov 2020

~ Release date

COPYRI GH T © TH REATRAY 2022

45

Qbot STAGER

COPYRI GH T © TH REATRAY 2022

46

Qbot STAGER

Only DLL. Joined MAIN DLL and STAGER

Integrity level logic Self injection for installation MAIN dll split + Plugin support
CC List

Hook dll moved to
Plugin
Code obfuscatio
n

Resource key changed

COPYRI GH T © TH REATRAY 2022

47

Metadata -> Insights

COPYRI GH T © TH REATRAY 2022

48

Affiliate ID/ Version / Timestamp

Affiliate ID

Version

· spx112 · tr · AA · abc12 · abc13 · obama72 · obama73 · clinton1 · clinton10

· 201.81 · 201.834 · 300.400 · 321.128 · 322.1598 · 323.36 · 324.386 · 401.855 · 403.263

Timestamp

22 January 2018 17:23:46 (1516641826)

30 January 2019 17:43:09 (1548870189)

17 March 2020 16:17:44 (1584461864)

8 February 2021 11:02:19 (1612782139)

18 February 2021 14:02:49 (1613656969)

12 December 2021 18:25:30 (1639333530)

15 February 2022 11:01:24 (1644922884)

9 March 2022 15:46:32

(1646840792)

4 April 2022 7:42:58

(1649058178)

COPYRI GH T © TH REATRAY 2022

49

Before 2020 Samples Affiliate ID
2021-2022

2020-2021

2022

COPYRI GH T © TH REATRAY 2022

50

Samples Affiliate ID ­ All

COPYRI GH T © TH REATRAY 2022

51

Relevant Affiliate IDs

COPYRI GH T © TH REATRAY 2022

52

Qbot Affiliate ID / Version / Timestamp

COPYRI GH T © TH REATRAY 2022

53

Conclusion

COPYRI GH T © TH REATRAY 2022

54

Qbot Version Timeline (2013-2022)

COPYRI GH T © TH REATRAY 2022

55

Ready for the Threatray Advantage?
V I S I T H T T P S : / / T H R E A T R A Y. C O M O R C O N T A C T U S A T I N F O @ T H R E A T R A Y. C O M

COPYRI GH T © TH REATRAY 2022

56

