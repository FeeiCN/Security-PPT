Finding New Bluetooth Low Energy Exploits via Reverse Engineering Multiple Vendors' Firmwares
Veronica Kovah Dark Mentor LLC
0

Hello World!
 Previously a security engineer for Tesla, NSA, MITRE, and Sourcefire  Currently founder of Dark Mentor LLC, security consulting and
education  This talk is about sharing the journey from knowing almost nothing
about Bluetooth to finding remote code execution vulnerabilities  veronica@darkmentor.com, @VeronicaKovah
1

Starting from scratch...
2

Learning mode
 Surveyed existing Bluetooth (BT) security research  Read the complex, more than 3000 pages, Bluetooth specification
 Not back to back!  Focus on common developer's mistake: e.g. length, nested fields
 Looked for if there is any open source implementation below HCI
 BT classic: could not find any  Bluetooth Low Energy (BLE) : Zephyr and Apache Mynewt NimBLE
 Started with BT classic, then moved onto BLE
3

BLE stack in dual chip configuration

Host

Generic Access Profile (GAP)

Generic Attribute Profile (GATT)

Attribute Protocol (ATT)

Security Manager (SM)

Logical Link Control and Adaptation Protocol (L2CAP)

UART, USB, etc. Controller
THIS TALK

Host Controller Interface (HCI) Link Layer (LL)

BLE Radio Physical Layer (PHY)
4

BLE stack in single chip configuration

Controller

Generic Access Profile (GAP)

Generic Attribute Profile (GATT)

Attribute Protocol (ATT)

Security Manager (SM)

Implementationspecific
THIS TALK

Logical Link Control and Adaptation Protocol (L2CAP) Host Controller Interface (HCI) Link Layer (LL)

BLE Radio Physical Layer (PHY)
5

Bluetooth (classic and low energy) vulnerability CVE ID counts when I started
Host
132
Controller
0
6

Bluetooth (classic and low energy) vulnerability CVE ID counts now
Host
244

Controller

14

(2/3 BLE RCEs are this talk!)

7

Why target below the HCI layer?

PC OS 1

PC OS 1

PC OS 1

PC OS 2

Controller 1

Controller 2

Controller 3

Controller 4
8

Why target below the HCI layer?

OS 1

OS 2

OS 3

OS 4

Controller 1

Controller 1

Controller 1

Controller 1
9

New BLE low layer vulnerabilities!
 Neither pairing nor authentication is required, just need proximity  Texas Instruments CC256x and WL18xx dual-mode Bluetooth
controller devices
Demo  RCE #1 (CVE-2019-15948)  Potential RCE (CVE-2019-15948)
 Silicon Labs BLE EFR32 SoC's and associated modules
Demo  RCE #2 (CVE-2020-15531)  DoS (CVE-2020-15532)
10

Lab Setup
11

Lab setup: targets

My lab has way more development boards but these are the ones I will talk about today J
12

Lab setup: for basic HW debug 1
USB to serial converters with CTS and RTS lines
USB to serial converters without CTS and RTS lines
13

Lab setup: for basic HW debug 2
To use OpenOCD, Olimex ARM-USB-TINY-H
+ Olimex ARM-JTAG-SWD
(used this the most) SEGGER J-Link EDU JTAG/SWD debugger
+ SWD adapter

SEGGER J-Link EDU Mini - JTAG/SWD debugger
10-pin 2x5 socketsocket 1.27mm IDC
(SWD) cable
14

Lab setup: for fuzzer and convenience
USB hub with individual power switches
SW-controllable (uhubctl) USB hub for fuzzer USB power meter
15

Ubertooth TI CC1352/CC26x2 hardware

Lab setup: sniffers
 Ubertooth
 Great Scott Gadgets hardware  Pretty console display  (SW) does not support extended
advertisement packets  http://ubertooth.sourceforge.net/
 Sniffle
 TI CC1352/CC26x2 hardware  Supports BT 5 packet formats / PHY modes  Was very useful to build/debug a BLE fuzzer  Less pretty console display for a demo  https://www.nccgroup.com/us/our-research/sniffle-a-sniffer-for-bluetooth-5/
Note: There are many other sniffers, check if your project goal aligns with a sniffer's features
16

Lab setup: packet sending HW
 Started with Nordic Semiconductor nRF52832 dev board
 Selected this first because open source BLE implementations had more documentation with this board (obviously B/C it's older dev board!)
 USB to serial converter is necessary
 Ended up with nRF52840 dev board
 UART interface through a virtual COM port  No USB to serial converter is needed
17

Lab setup: JackBNimBLE, packet sending SW
 Send arbitrary BLE Link Layer packets  Extracted from my home-made fuzzer  Controller SW: made modification to Apache Mynewt NimBLE
(https://mynewt.apache.org/)  Host SW: python scripts via HCI interface  Current version can be used to share PoC  Easy to extend, e.g. fuzzer  https://github.com/darkmentorllc/jackbnimble
18

Host (e.g. Linux) JackBNimBLE Host (HCI commandsending python)
UART HCI link
Controller (nRF52840) JackBNimBLE Firmware (custom nRF NimBLE)

Host (Victim) Controller (Victim)
19

Lab Setup Complete! Let's attack!
20

Target #1: Texas Instruments WL1835MOD
 Bluetooth v4.2  Dual mode (BT classic and BLE)  No JTAG or SWD readily available  BLE Link Layer is in ROM
 Host applies a patch
 No firmware image readily available  WiLinkTM Wireless Tools for WL18XX modules
 HCITester: .bts binary patch -> human-readable format  Logger: UART binary debug messages-> human-readable format
21

BLE stack in dual chip configuration

Target #1

Host

Generic Access Profile (GAP)

Generic Attribute Profile (GATT)

Attribute Protocol (ATT)

Security Manager (SM)

Logical Link Control and Adaptation Protocol (L2CAP)

UART, USB, etc. Controller (WL1835MOD)

Host Controller Interface (HCI) Link Layer (LL)

BLE Radio Physical Layer (PHY)
22

Static analysis

Target #1

 Memory dumping via Vendor Specific "HCI_VS_Read_Memory" command
 Used IDA Pro to analyze the dumped memory
 Identified log print functions whose arguments are a log string identifier(s) and the log string's optional parameters like a format string
 Made an IDA Python script to add log strings where a log function call exists
 Identified some function names  Inferred a lot of functions' context
23

Log string ID Log function

Target #1
24

Dynamic analysis
 Used a home-made fuzzer  RE'ed the hard fault handler and enabled more
logs to see register, stack, and heap memory
states  Patched binary for debugging via hooking
 Don't know how to do JTAG wiring  Cortex-M3 Flash Patch and Breakpoint Unit (FPB)  Used HCI_VS_Write_Memory to have an alternate
code for reading memory and/or register values  Used log() to send values to UART

Target #1
25

Logger contents by default

Target #1

26

Hooked just before calling memcpy
Printing out src and len
Wrote 1 to 0x2008845c to see more hardfault state info

Target #1
Logger contents with firmware patch & memory modification
27

Hooked just before calling memcpy
Printing out src and len
28

Hooked just before calling memcpy
Printing out src and len
Wrote 1 to 0x2008845c to see more hardfault state info

Target #1
Logger contents with firmware patch & memory modification
29

Wrote 1 to 0x2008845c to see more hardfault state info
30

Remote code execution bugs

Target #1

 Static reverse engineering revealed integer underflows could cause stack buffer overflows
 Fuzzing with advertisement packets confirmed with a crash
 Wait... Yes, the "same" problem as BleedingBit but in a different code base (BleedingBit is heap overflow, mine is stack overflow)
 Reported on 5/22/2019, fixed on 11/12/2019

31

Victim

Attacker

Target #1

Attack Packet 1

From Spec v4.2
32

Stack buffer overflow 1 CVE-2019-15948

Target #1

ROM:0005B3A0 ROM:0005B3A2 ... ROM:0005B3CE ROM:0005B3D0 ROM:0005B3D2 ROM:0005B3D6 ROM:0005B3DA ROM:0005B3DE

PUSH SUB.W
SUBS UXTB ADD.W ADD.W STRB.W BL

{R4-R7,LR} SP, SP, #0x2C
R6, R6, #6 R2, R6 R1, R5, #8 R0, SP, #9 R2, [SP,#8] memcpy

; LR is stored on stack
; stack buffer ; R6 is PDU length ; integer underflow ; unsigned byte extension
; src, heap buffer address
; dst, stack buffer address

void *memcpy(void *dest, const void *src, size_t n);

R0

R1

R2

33

Attack packet example 1
From Spec v4.2

Target #1

Example: ADV_IND PDU Type

Header

Payload

0x00

0x02

0x41

0x41

34

From Spec v4.2

Target #1

35

One little problem...

Target #1

 Background BLE traffic affects heap contents, which affects exploit reliability

36

"Quiet Place" attack
 Lots of DoS attacks
 One (two?) of mine  Sweyntooth collection  Multiple SEEMOO's findings  Any failed RCE attacks -> DoS J
 An attacker can selectively DoS nearby devices to quiet them down, to make it more reliable to exploit a target

Target #1
37

BLE Controller (Bystander)

Target #1
BLE Controller (Bystander)

BLE Controller (Attacker)

BLE Controller (Target Victim)

BLE Controller (Bystander)

BLE Controller (Bystander)
38

!!
BLE Controller (Attacker)
!!

" BLE Controller
(Bystander)

Target #1
BLE Controller
" (Bystander)

BLE Controller (Target Victim)

" BLE Controller
(Bystander)

BLE Controller
" (Bystander) 39

BLE Controller (Bystander)

Target #1
BLE Controller (Bystander)

! BLE Controller
(Attacker)

BLE Controller (Target Victim)

BLE Controller (Bystander)

BLE Controller (Bystander)
40

I has a bucket!
41

I has a bucket!
42

RCE demo

Target #1
43

Host ("guidance") JackBNimBLE Host (HCI commandsending python)
UART HCI link
! Controller (nRF52840)
JackBNimBLE Firmware (custom nRF NimBLE)

Target #1
Host ("darkmentor")
UART HCI link
Controller (WL1835MOD)

44

45

Stack buffer overflow 2 CVE-2019-15948

Target #1

ROM:0005B348 ROM:0005B34A ... ROM:0005B36E ROM:0005B372 ROM:0005B374 ROM:0005B376 ROM:0005B37A ROM:0005B37E

PUSH SUB.W
ADD.W SUBS UXTB ADD.W STRB.W BL

{R4,R5,LR} ; LR is stored on stack

SP, SP, #0x2C ; stack buffer ; R0 is PDU length

R1, R4, #8 R0, R0, #6
R2, R0

; src, heap buffer address ; integer underflow ; unsigned byte extension

R0, SP, #9 ; dst, stack buffer address

R2, [SP,#8]

memcpy

46

Victim

Attacker

Target #1

Attack Packet 2
From Spec v4.2
47

Attack packet example 2
From Spec v4.2

Target #1

Example: SCAN_RSP PDU Type

Header

Payload

0x04

0x02

0x41

0x41

48

Next!
49

Target #2
 Silicon Labs EFR32MG21  Supports BT 5 extended
advertisements  SWD debug interface is available  Provides Simplicity Studio
 BT stack comes as a library  Symbols are available, GOOD
& ... bad ... no novel RE process to talk about J
50

BLE stack in single chip configuration

Target #2

Controller (EFR32MG21)
Implementationspecific

Generic Access Profile (GAP)

Generic Attribute Profile (GATT)

Attribute Protocol (ATT)

Security Manager (SM)

Logical Link Control and Adaptation Protocol (L2CAP)

Host Controller Interface (HCI)

Link Layer (LL)

BLE Radio Physical Layer (PHY)
51

Fuzzing extended advertisements

Target #2

 Fuzzer major update: had to move from Zephyr to NimBLE to start
fuzzing extended advertisements  Found DoS then fuzzed for a while but no crash
 Ubertooth (SW) does not support the extended length advertisement packets  Sniffle does, thanks!
 NimBLE debugging? modified NimBLE scheduling code to send a large
packet for longer time  Soon after the NimBLE modification, CRASH!!

52

Target #2
Not every memory buffer overflow leads to RCE
53

DoS: heap buffer overflow CVE-2020-15532

Target #2

00021800 ... 0002180e 00021810 ... 0002181a 0002181e 00021820 00021822 00021824

ldrb r6,[r0,#0x6]

; controlled by an attacker

ldrb r2,[r0,#0x7] sub r2,r2,r6

add.w add sub add bl

r1,r6,#0xc r1,r0 r0,r5,r6 r0,r1 memmove

; controlled by an attacker ; integer underflow ; but it's too large value
; memory access violation

void *memmove(void *dest, const void *src, size_t n);

R0

R1

R2

54

Target #2
Difference from the target #1's RCE bug

ROM:0005B3A0 ROM:0005B3A2 ... ROM:0005B3CE ROM:0005B3D0 ROM:0005B3D2 ROM:0005B3D6 ROM:0005B3DA ROM:0005B3DE

PUSH SUB.W
SUBS UXTB ADD.W ADD.W STRB.W BL

{R4-R7,LR} SP, SP, #0x2C
R6, R6, #6 R2, R6 R1, R5, #8 R0, SP, #9 R2, [SP,#8] memcpy

; LR is stored on stack ; stack buffer ; R6 is LL packet length ; integer underflow ; unsigned byte extension ; src, heap buffer address ; dst, stack buffer address

55

RCE: heap buffer overflow CVE-2020-15531

Target #2

 Neither pairing nor authentication is required  Found a heap memory corruption via fuzzing, which leads to RCE, in
extended advertisement packet parsing  Packet data is chopped into a chained buffer, an entry holds max 0x45
bytes  Length mis-calculation took place  Manipulated the last byte of a memory chunk pointer  With a heap spray, overwrote a function pointer  Reported 2/21/2020, fixed 3/20/2020, Impressive!!

56

Attack packet example

Target #2
From Spec v5.2

Example: ADV_EXT_IND Type, introduced on v5.0

Header 0x07 0xFF

Payload 0x3C 0x00

0x41

0x41

0x41

0x41

0x41

0x41

...

57

Target #2
RCE persistence demo
The successful attack is probabilistic
58

Host ("guidance") JackBNimBLE Host (HCI commandsending python)
UART HCI link
! Controller (nRF52840)
JackBNimBLE Firmware (custom nRF NimBLE)

Target #2
Host ("darkmentor")
GDB over SWD to display status
Controller (EFR32MG21)
"

59

60

General BT security challenges:
61

BT security challenge 1:
Lack of all common exploit mitigations
 Stack Canaries  Data Execution Prevention (DEP)  Address Space Layout Randomization (ASLR)  Return Oriented Programming (ROP) Prevention ...
62

BT security challenge 2:
SecureBoot
 Many chip vendors do not support secure boot or secure reset  An exploit only has to work once for the attacker to have control
forever  Even if chip vendors support, it's up to the company who uses the
chips in their end product to enable it
 Silicon Labs' Gecko Bootloader does support secure boot  Hope that all Silabs' customers patched the vulnerability
63

BT security challenge 3:
Impact assessment
 How to assess the impact of a vulnerability
 Difficult to identify which end products are vulnerable  Light bulbs vs. medical devices
 Customer information is often secret and it's up to the chip vendors to notify their customers
 Or even worse case: chip vendors -> packaging providers -> end product makers
 Some ways to find end products but it won't be the complete list
 Googling with "site:fccid.io"  https://launchstudio.bluetooth.com/Listings/Search
64

For additional information
https://github.com/darkmentorllc
65

Thanks for valuable feedback!

Xeno Kovah Rafal Wojtczuk Marion Marschalek

Root

Lily

Thank you...

for watching!
66

